"use strict";var e,t,i,s=require("obsidian");!function(e){e[e.DEFINED=1]="DEFINED",e[e.INFERRED=2]="INFERRED"}(e||(e={})),function(e){e[e.PARENT=0]="PARENT",e[e.CHILD=1]="CHILD",e[e.FRIEND=2]="FRIEND"}(t||(t={})),function(e){e[e.TO=1]="TO",e[e.FROM=2]="FROM",e[e.BOTH=3]="BOTH"}(i||(i={}));const n=(e,t,i)=>{const s=e.metadataCache.getFirstLinkpathDest(t,i);return s?s.path:t},a=(e,t)=>{var i,s,a,r;const o=new Set,l=e.matchAll(/[^[]*\[\[(?<wikiLink>[^#\]\|]*)[^\]]*]]|\[[^\]]*]\((?<mdLink>[^)]*)\)/g);let h;for(;!(h=l.next()).done;){if(null===(s=null===(i=null==h?void 0:h.value)||void 0===i?void 0:i.groups)||void 0===s?void 0:s.wikiLink){const e=n(app,h.value.groups.wikiLink,t.path);e&&o.add(e)}if(null===(r=null===(a=null==h?void 0:h.value)||void 0===a?void 0:a.groups)||void 0===r?void 0:r.mdLink){const e=n(app,decodeURIComponent(h.value.groups.mdLink),t.path);e&&o.add(e)}}return Array.from(o)},r=(e,t,i)=>{const s=[],r=new Set;return i.forEach((i=>{const o=t[i];o&&!r.has(i)&&(r.add(i),((e,t,i)=>{const s=new Set;if(t.values){const r=Array.from(t.values());r.filter((e=>(null==e?void 0:e.type)&&("file"===e.type||"header"===e.type||"block"==e.type))).forEach((t=>{const a=n(e,t.path,i.path);a&&s.add(a)}));const o=a(r.filter((e=>"string"==typeof e)).join(" "),i),l=r.filter((e=>(null==e?void 0:e.values)&&"object"==typeof e&&"string"==typeof e.values[0])).map((t=>n(e,t.values[0],i.path)));
//! currently there is an issue with case sensitivity. DataView retains case sensitivity of links for the front matter, but not the others
return Array.from(s).concat(o).concat(l)}if(t.path){const s=n(e,t.path,i.path);return s?[s]:[]}return"string"==typeof t?a(t,i):[]})(e.app,o,t.file).forEach((e=>s.push({link:e,field:i}))))})),s},o=(e,t)=>{var i,s,n;return e?(null!==(n=null===(s=null===(i=e.file)||void 0===i?void 0:i.tags)||void 0===s?void 0:s.values)&&void 0!==n?n:[]).filter((e=>t.tagStyleList.some((t=>e.startsWith(t)))))[0]:null},l=(e,t)=>e?t.tagNodeStyles[t.tagStyleList.filter((t=>e.startsWith(t)))[0]]:{},h=e=>{console.error(Object.assign({plugin:"ExcaliBrain"},e))};console.log.bind(window.console),console.log.bind(window.console);const d=e=>`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(e.replaceAll("&nbsp;"," "))))}`;function g(e){const t=e.lastIndexOf("/"),i=-1==t?e:e.substring(t+1);return{folderpath:s.normalizePath(e.substring(0,t)),filename:i,basename:i.replace(/\.[^/.]+$/,"")}}const c={target:null,isParent:!1,isChild:!1,isFriend:!1,direction:null},p=(e,t)=>e&&t?e+", "+t:e||t,u=(e,t)=>e?e===i.BOTH||e===t?e:i.BOTH:t,f=(t,i)=>t===e.DEFINED?e.DEFINED:t===e.INFERRED?i===e.DEFINED?e.DEFINED:e.INFERRED:i;class y{constructor(t,i,s,n,a=!1,r=!1,o){this.pages=t,this.path=i,this.file=s,this.plugin=n,this.isFolder=a,this.isTag=r,this.name=o,this.dvIndexReady=!1,this.isChild=t=>{const{pi:i,pd:s,ci:n,cd:a,fd:r}=this.getRelationVector(t);return!a||s||r?i||s||!n||a||r?null:e.INFERRED:e.DEFINED},o||(this.name=s?"md"===s.extension?s.basename:s.name:(e=>{const t=e.endsWith(".md"),i=e.substring(e.lastIndexOf("/")+1);return t?i.slice(0,-3):i})(i)),this.mtime=s?s.stat.mtime:null,this.neighbours=new Map}addDVFieldLinksToPage(){var t,s,n;if(this.dvIndexReady||this.isFolder||!this.pages)return;if(this.dvIndexReady=!0,this.isTag){const t=this.plugin.DVAPI.index.etags.getInverse("#"+this.path.substring(4));if(!t)return;return void t.forEach((t=>{const s=this.pages.get(t);s&&(this.neighbours.has(t)||(s.addParent(this,e.DEFINED,i.FROM,"tag-tree"),this.addChild(s,e.DEFINED,i.TO,"tag-tree")))}))}if(!this.file)return;const a=this.plugin.DVAPI.page(this.file.path);if(!a)return;if(this.dvPage=a,!a)return;this.primaryStyleTag=o(this.dvPage,this.plugin.settings),(null!==(n=null===(s=null===(t=a.file)||void 0===t?void 0:t.etags)||void 0===s?void 0:s.values)&&void 0!==n?n:[]).forEach((t=>{t="tag:"+t.substring(1);const s=this.pages.get(t);s&&(this.addParent(s,e.DEFINED,i.FROM,"tag-tree"),s.addChild(this,e.DEFINED,i.TO,"tag-tree"))}));const l=this.plugin.hierarchyLowerCase.parents;r(this.plugin,a,l).forEach((t=>{const s=this.pages.get(t.link);s&&(this.addParent(s,e.DEFINED,i.TO,t.field),s.addChild(this,e.DEFINED,i.FROM,t.field))}));const h=this.plugin.hierarchyLowerCase.children;r(this.plugin,a,h).forEach((t=>{const s=this.pages.get(t.link);s&&(this.addChild(s,e.DEFINED,i.TO,t.field),s.addParent(this,e.DEFINED,i.FROM,t.field))}));const d=this.plugin.hierarchyLowerCase.friends;r(this.plugin,a,d).forEach((t=>{const s=this.pages.get(t.link);s&&(this.addFriend(s,e.DEFINED,i.TO,t.field),s.addFriend(this,e.DEFINED,i.FROM,t.field))}))}getTitle(){var e,t,i,s,n;const a=this.file&&this.plugin.settings.renderAlias&&null!==(s=null===(i=null===(t=null===(e=this.dvPage)||void 0===e?void 0:e.file)||void 0===t?void 0:t.aliases)||void 0===i?void 0:i.values)&&void 0!==s?s:[],r=a.length>0?a[0]:this.name;if((null===(n=this.dvPage)||void 0===n?void 0:n.file)&&this.plugin.customNodeLabel)try{return this.plugin.customNodeLabel(this.dvPage,r)}catch(e){h({fn:this.getTitle,message:"Error executing cutomer node label function. The script is: "+this.plugin.settings.nodeTitleScript,data:this.dvPage,where:"Page.getTitle()",error:e})}return r}getRelationVector(t){return{pi:t.isParent&&t.parentType===e.INFERRED,pd:t.isParent&&t.parentType===e.DEFINED,ci:t.isChild&&t.childType===e.INFERRED,cd:t.isChild&&t.childType===e.DEFINED,fd:!this.plugin.settings.inferAllLinksAsFriends&&t.isFriend||this.plugin.settings.inferAllLinksAsFriends&&t.isFriend&&!(t.parentType===e.DEFINED||t.childType===e.DEFINED)}}getNeighbours(){this.addDVFieldLinksToPage(),this.neighbours.forEach((e=>e.target.addDVFieldLinksToPage()));const{showVirtualNodes:e,showAttachments:t,showFolderNodes:i,showTagNodes:s,showPageNodes:n}=this.plugin.settings;return Array.from(this.neighbours).filter((a=>(e||!a[1].target.isVirtual)&&(t||!a[1].target.isAttachment)&&(i||!a[1].target.isFolder)&&(s||!a[1].target.isTag)&&(n||a[1].target.isFolder||a[1].target.isTag||a[1].target.isAttachment)))}get isVirtual(){return null===this.file&&!this.isFolder&&!this.isTag}get isAttachment(){return!!this.file&&"md"!==this.file.extension}get isMarkdown(){var e;return"md"===(null===(e=this.file)||void 0===e?void 0:e.extension)||!this.file}addParent(e,t,i,s){var n;if(e.path===this.plugin.settings.excalibrainFilepath||e.path===this.path)return;const a=this.neighbours.get(e.path);if(a)return a.isParent=!0,a.parentType=f(a.parentType,t),s&&!(null===(n=a.parentTypeDefinition)||void 0===n?void 0:n.contains(s))&&(a.parentTypeDefinition=p(s,a.parentTypeDefinition)),void(a.direction=u(a.direction,i));this.neighbours.set(e.path,Object.assign(Object.assign({},c),{target:e,isParent:!0,parentType:t,parentTypeDefinition:s,direction:i}))}addChild(e,t,i,s){var n;if(e.path===this.plugin.settings.excalibrainFilepath||e.path===this.path)return;const a=this.neighbours.get(e.path);if(a)return a.isChild=!0,a.childType=f(a.childType,t),s&&!(null===(n=a.childTypeDefinition)||void 0===n?void 0:n.contains(s))&&(a.childTypeDefinition=p(s,a.childTypeDefinition)),void(a.direction=u(a.direction,i));this.neighbours.set(e.path,Object.assign(Object.assign({},c),{target:e,isChild:!0,childType:t,childTypeDefinition:s,direction:i}))}addFriend(e,t,i,s){var n;if(e.path===this.plugin.settings.excalibrainFilepath||e.path===this.path)return;const a=this.neighbours.get(e.path);if(a)return a.isFriend=!0,a.friendType=f(a.friendType,t),s&&!(null===(n=a.friendTypeDefinition)||void 0===n?void 0:n.contains(s))&&(a.friendTypeDefinition=p(s,a.friendTypeDefinition)),void(a.direction=u(a.direction,i));this.neighbours.set(e.path,Object.assign(Object.assign({},c),{target:e,isFriend:!0,friendType:t,friendTypeDefinition:s,direction:i}))}unlinkNeighbour(e){this.neighbours.delete(e)}childrenCount(){return this.getNeighbours().reduce(((t,i)=>{const s=this.isChild(i[1]);return t+(s&&this.plugin.settings.showInferredNodes||s===e.DEFINED?1:0)}),0)}hasChildren(){return this.getNeighbours().some((t=>{const i=this.isChild(t[1]);return i&&this.plugin.settings.showInferredNodes||i===e.DEFINED}))}getChildren(){return this.getNeighbours().filter((t=>{const i=this.isChild(t[1]);return i&&this.plugin.settings.showInferredNodes||i===e.DEFINED})).map((e=>({page:e[1].target,relationType:e[1].childType,typeDefinition:e[1].childTypeDefinition,linkDirection:e[1].direction})))}isParent(t){const{pi:i,pd:s,ci:n,cd:a,fd:r}=this.getRelationVector(t);return a||!s||r?!i||s||n||a||r?null:e.INFERRED:e.DEFINED}parentCount(){return this.getNeighbours().reduce(((t,i)=>{const s=this.isParent(i[1]);return t+(s&&this.plugin.settings.showInferredNodes||s===e.DEFINED?1:0)}),0)}hasParents(){return this.getNeighbours().some((t=>{const i=this.isParent(t[1]);return i&&this.plugin.settings.showInferredNodes||i===e.DEFINED}))}getParents(){return this.getNeighbours().filter((t=>{const i=this.isParent(t[1]);return i&&this.plugin.settings.showInferredNodes||i===e.DEFINED})).map((e=>({page:e[1].target,relationType:e[1].parentType,typeDefinition:e[1].parentTypeDefinition,linkDirection:e[1].direction})))}isFriend(t){const{pi:i,pd:s,ci:n,cd:a,fd:r}=this.getRelationVector(t);return r?e.DEFINED:!i||s||!n||a||r?null:e.INFERRED}friendCount(){return this.getNeighbours().reduce(((t,i)=>{const s=this.isFriend(i[1]);return t+(s&&this.plugin.settings.showInferredNodes||s===e.DEFINED?1:0)}),0)}hasFriends(){return this.getNeighbours().some((t=>{const i=this.isFriend(t[1]);return i&&this.plugin.settings.showInferredNodes||i===e.DEFINED}))}getFriends(){return this.getNeighbours().filter((t=>{const i=this.isFriend(t[1]);return i&&this.plugin.settings.showInferredNodes||i===e.DEFINED})).map((t=>{var i;return{page:t[1].target,relationType:null!==(i=t[1].friendType)&&void 0!==i?i:t[1].parentType===e.DEFINED&&t[1].childType===e.DEFINED?e.DEFINED:e.INFERRED,typeDefinition:t[1].friendTypeDefinition,linkDirection:t[1].direction}}))}getRelationToPage(e){const t=this.neighbours.get(e.path);return t?this.isChild(t)?{type:"child",relationType:t.childType,typeDefinition:t.childTypeDefinition}:this.isParent(t)?{type:"parent",relationType:t.parentType,typeDefinition:t.parentTypeDefinition}:{type:"friend",relationType:t.friendType,typeDefinition:t.friendTypeDefinition}:null}getSiblings(){const t=new Map;return this.getParents().forEach((i=>i.page.getChildren().forEach((i=>{t.has(i.page.path)?i.relationType===e.DEFINED&&(t.get(i.page.path).relationType=e.DEFINED):t.set(i.page.path,i)})))),Array.from(t.values())}}var E={};Object.defineProperty(E,"__esModule",{value:!0});const m=e=>{try{return window.ExcalidrawAutomate.getAPI(e)}catch(e){return console.log({message:"Excalidraw not available",fn:m}),null}};var S=E.getEA=m;const w="ExcaliBrain",v=["base","inferred","file-tree","tag-tree"],b={strokeColor:"#696969FF",strokeWidth:1,strokeStyle:"solid",roughness:0,startArrowHead:"none",endArrowHead:"none",showLabel:!1,fontSize:10,fontFamily:3,textColor:"#ffffffff"},T={prefix:"",backgroundColor:"#00000066",fillStyle:"solid",textColor:"#ffffffff",borderColor:"#00000000",fontSize:20,fontFamily:3,maxLabelLength:30,roughness:0,strokeShaprness:"round",strokeWidth:1,strokeStyle:"solid",padding:10,gateRadius:5,gateOffset:15,gateStrokeColor:"#ffffffff",gateBackgroundColor:"#ffffffff",gateFillStyle:"solid"};var L={JSON_MALFORMED:"Malformed JSON",JSON_MISSING_KEYS:'JSON must have these 3 keys: "parents", "children", "friends"',JSON_VALUES_NOT_STRING_ARRAYS:'Key values must be a non-empty array of strings. e.g. "parents": ["Parent", "Parents", "up"]',EXCALIBRAIN_FILE_NAME:"Filepath of Excalibrain drawing",EXCALIBRAIN_FILE_DESC:"⚠ This file will be overwritten by the plugin. If you stop the script and make changes to the graph, you should rename the file so your edits are preserved, because the next time you initiate ExcaliBrain your edits will be overwritten by the automatically generated ExcaliBrain graph.",INDEX_REFRESH_FREQ_NAME:"Index refresh frequency",INDEX_REFRESH_FREQ_DESC:"ExcaliBrain will update its index whenever you switch work panes, in case a file has changed in your Vault since the last index update. <br>This setting is thus only relevant when you are typing in a markdown editor (not switching files or panes) and you still want ExcaliBrain to update it's graph as you type. Because frequent background index updates can be resource intensive you have an option to increase the time interval for the index-updates which in turn will reduce the overhead on your system.",HIERARCHY_HEAD:"Ontology",HIERARCHY_DESC:"Enter the Dataview field names separated by comma (,) that you will use to define link directions in your graph.<br>You can also add fields to the ontology on the fly from the markdown editor by typing the new field at the beginning of a paragraph (e.g.: 'Consits of::') and then calling one of the command palette actions to <code>Add dataview field to ontology as PARENT</code>, or <code>as CHILD</code>, or <code>as FRIEND</code>",INFER_NAME:"Infer all implicit relationships as Friend",INFER_DESC:"<b>Toggle On:</b> All implicit links in the document are interpreted as FRIENDS.<br><b>Toggle Off:</b> The following logic is used:<ul><li>A forward link is inferred as a CHILD</li><li>A backlink is inferred as a PARENT</li><li>If files mutually link to each other, they are FRIENDS</li></ul>",REVERSE_NAME:"Reverse infer logic",REVERSE_DESC:"<b>Toggle ON:</b> Treat backlinks as children and forward links as parents.<br><b>Toggle OFF:</b> Treat backlinks as parents and forward links as children</b>",PARENTS_NAME:"Parents",CHILDREN_NAME:"Children",FRIENDS_NAME:"Friends",EXCLUSIONS_NAME:"Excluded",EXCLUSIONS_DESC:"Dataview or YAML fields that are never used for ontology",UNASSIGNED_NAME:"Unassigned",UNASSIGNED_DESC:"Fields in your Vault that are neither excluded nor part of the defined ontology.",ONTOLOGY_SUGGESTER_NAME:"Ontology Suggester",ONTOLOGY_SUGGESTER_DESC:"Activate ontology suggester in the markdown editor. If enabled then typing the trigger sequence at the beginning of a paragraph will activate the suggester listing your ontology fields defined above.",ONTOLOGY_SUGGESTER_ALL_NAME:"Character sequence to trigger generic suggester. The Generic suggester will include all the ontology fields regardless of their direction.",ONTOLOGY_SUGGESTER_PARENT_NAME:"Character sequence to trigger parent suggester",ONTOLOGY_SUGGESTER_CHILD_NAME:"Character sequence to trigger child suggester",ONTOLOGY_SUGGESTER_FRIEND_NAME:"Character sequence to trigger friend suggester",MID_SENTENCE_SUGGESTER_TRIGGER_NAME:"Mid-sentence dataview field suggester trigger",MID_SENTENCE_SUGGESTER_TRIGGER_DESC:"You may add fields mid-way in sentences following one of these two formats:<br><code>We met at [location:: [[XYZ restaurant]]] with [candidate:: [[John Doe]]]</code><br><code>We met at (location:: [[XYZ restaurant]]) with (candidate:: [[John Doe]])</code><br>If you set this trigger to e.g. <code>(</code> then typing <code>(:::</code> anywhere in the sentence will activate the suggester (assuming you are using the default generic suggester trigger commbination of <code>:::</code> - see setting above).<br>More info on inline fields: [DataView Help](https://blacksmithgu.github.io/obsidian-dataview/data-annotation/)",BOLD_FIELDS_NAME:"Add selected field with BOLD",BOLD_FIELDS_DESC:"Add selected field to text with bold typeface, i.e. (**field name**:: ) resulting in (<b>field name</b>:: )",DISPLAY_HEAD:"Display",EXCLUDE_PATHLIST_NAME:"Filepaths to exclude",EXCLUDE_PATHLIST_DESC:"Enter comma-separated list of filepaths to exclude from the index.",RENDERALIAS_NAME:"Display alias if available",RENDERALIAS_DESC:"Displays the page alias instead of the filename if it is specified in the page's front matter.",NODETITLE_SCRIPT_NAME:"Javascript for rendering node names",NODETITLE_SCRIPT_DESC:"Javascript code to render the node title. If you don't need it, just leave this field empty.<br>Function definition: <code>customNodeLabel: (dvPage: Literal, defaultName:string) => string</code><br>In your script you may refer to the dataview page object via the <code>dvPage</code> variable; and the default page name (filename or alias if available) via the <code>defaultName</code> variable. Use the following expression syntax:<br><code>dvPage['field 1']??defaultName</code> - this example will display the vaule of 'field 1' if available else the defaultName<br>⚠ Your line of code will be executed as is, make sure you add proper exception handling. Beyond <code>defaultName</code> and dataview field names, you also have the freedom to use any javascript function (e.g. <code>defaultName.toLowerCase()</code>) and any value that appears on the <code>dvPage</code> object, e.g. <code>dvPage.file.path</code>, etc. <br> To explore the dataview page object open Developer Console and enter the following code:<br><code>DataviewAPI.page('full filepath including extension')</code><br>Here's an example code that will display the value of the title field if available, else the filename, followed by the state (if available): <br><code>dvPage.title??defaultName & (dvPage.state ? ' - ' & dvPage.state : '')</code>",SHOWINFERRED_NAME:"Display inferred relationships",SHOWINFERRED_DESC:"<b>Toggle ON</b>: Display both explicitly defined and inferred links. Forward links are children, backlinks are parents, if two page mutually referes to one another then relationship is inferred to be a friendship. Explicitly defined relationships always take priority.<br><b>Toggle OFF</b>: Display only explicitely defined relationships.",SHOWVIRTUAL_NAME:"Display virtual child nodes",SHOWVIRTUAL_DESC:"<b>Toggle ON</b>: Display unresolved links.<br><b>Toggle OFF</b>: Do not display unresolved links.",SHOWATTACHMENTS_NAME:"Include attachments",SHOWATTACHMENTS_DESC:"<b>Toggle ON</b>: Display every type of file on the graph. <br><b>Toggle OFF</b>: Display only markdown files.",STYLE_HEAD:"Styling",STYLE_DESC:"Styles are applied in sequence.<br><ol><li><b>Base</b> node style</li><li><b>Inferred</b> node style (only applied if the node is inferred)</li><li><b>Virtual</b> node style (only applied if the node is virtual)</li> <li><b>Central</b> node style (only applied if the node is in the center)</li><li><b>Sibling</b> node style (only applied if the node is a sibling)</li> <li><b>Attachment</b> node style (only applied if the node is an attachment)</li><li><b>Optional</b> tag based style</li></ol>All the attributes of the base node style must be specified. All other styles may have partial definitions. e.g. You may add a prefix and override the base node-background color in the tag-based style, override the font color in the inferred-node style and set the border stroke style to dotted in the virtual-node style.",CANVAS_BGCOLOR:"Canvas color",SHOW_FULL_TAG_PATH_NAME:"Display full tag name",SHOW_FULL_TAG_PATH_DESC:"<b>Toggle on:</b> will display the full tag e.g. #reading/books/sci-fi</br><b>Toggle off:</b> will display the current section of the tag, e.g. assuming the tag above, the graph will display only #reading, #books, #sci-fi respectively as you navigate the tag hierarchy.",SHOW_COUNT_NAME:"Display neighbor count",SHOW_COUNT_DESC:"Show the number of children, parents, friends next to the node gate",ALLOW_AUTOZOOM_NAME:"Autozoom",ALLOW_AUTOZOOM_DESC:"<b>Toggle ON:</b> Allow autozoom<br><b>Toggle OFF:</b> Disable autozoom",ALLOW_AUTOFOCUS_ON_SEARCH_NAME:"Autofocus on search",ALLOW_AUTOFOCUS_ON_SEARCH_DESC:"<b>Toggle ON:</b> Allow autofocus on Search<br><b>Toggle OFF:</b> Disable autofocus",TAGLIST_NAME:"Formatted tags",TAGLIST_DESC:"You can specify special formatting rules for Nodes based on tags. If multiple tags are present on the page the first matching a specification will be used. <br>Tagnames should start with <mark>#</mark> and may be incomplete. i.e. <code>#book</code> will match #books, #book/fiction, etc.<br>Enter a comma separated list of tags here, then select from the dropdown list to change the formatting.",MAX_ITEMCOUNT_DESC:"Maximum node count",MAX_ITEMCOUNT_NAME:"Maximum number of nodes to display in a given area of the layout.i.e. the maximum number of parents, the maximum number of children, the maximum number of friends, and the maximum number of siblings to display. If there are more items, they will be ommitted from the drawing.",NODESTYLE_INCLUDE_TOGGLE:"Toggle ON: override base node style for this attribute; OFF: apply base node style for this attribute",NODESTYLE_PREFIX_NAME:"Prefix",NODESTYLE_PREFIX_DESC:"Prefix character or emoji to display in front of the node's label",NODESTYLE_BGCOLOR:"Background color",NODESTYLE_BG_FILLSTYLE:"Background fill-style",NODESTYLE_TEXTCOLOR:"Text color",NODESTYLE_BORDERCOLOR:"Border color",NODESTYLE_FONTSIZE:"Font size",NODESTYLE_FONTFAMILY:"Font family",NODESTYLE_MAXLABELLENGTH_NAME:"Max label length",NODESTYLE_MAXLABELLENGTH_DESC:"Maximum number of characters to display from node title. Longer nodes will end with '...'",NODESTYLE_ROUGHNESS:"Stroke roughness",NODESTYLE_SHARPNESS:"Stroke sharpness",NODESTYLE_STROKEWIDTH:"Stroke width",NODESTYLE_STROKESTYLE:"Stroke style",NODESTYLE_RECTANGLEPADDING:"Padding of the node rectangle",NODESTYLE_GATE_RADIUS_NAME:"Gate radius",NODESTYLE_GATE_RADIUS_DESC:"The radius of the 3 small circles (alias: gates) serving as connection points for nodes",NODESTYLE_GATE_OFFSET_NAME:"Gate offset",NODESTYLE_GATE_OFFSET_DESC:"The offset to the left and right of the parent and child gates.",NODESTYLE_GATE_COLOR:"Gate border color",NODESTYLE_GATE_BGCOLOR_NAME:"Gate background color",NODESTYLE_GATE_BGCOLOR_DESC:"The fill color of the gate if it has children",NODESTYLE_GATE_FILLSTYLE:"Gate background fill-style",NODESTYLE_BASE:"Base node style",NODESTYLE_CENTRAL:"Style of central node",NODESTYLE_INFERRED:"Style of inferred nodes",NODESTYLE_VIRTUAL:"Style of virtual nodes",NODESTYLE_SIBLING:"Style of sibling nodes",NODESTYLE_ATTACHMENT:"Style of attachment nodes",NODESTYLE_FOLDER:"Style of folder nodes",NODESTYLE_TAG:"Style of tag nodes",LINKSTYLE_COLOR:"Color",LINKSTYLE_WIDTH:"Width",LINKSTYLE_STROKE:"Stroke style",LINKSTYLE_ROUGHNESS:"Roughness",LINKSTYLE_ARROWSTART:"Start arrow head",LINKSTYLE_ARROWEND:"End arrow head",LINKSTYLE_SHOWLABEL:"Show label on link",LINKSTYLE_FONTSIZE:"Label font size",LINKSTYLE_FONTFAMILY:"Label font family",LINKSTYLE_BASE:"Base link style",LINKSTYLE_INFERRED:"Style of inferred link",LINKSTYLE_FOLDER:"Style of folder link",LINKSTYLE_TAG:"Style of tag link",DATAVIEW_NOT_FOUND:`Dataview plugin not found. Please install or enable Dataview then try restarting ${w}.`,DATAVIEW_UPGRADE:`Please upgrade Dataview to 0.5.31 or newer. Please update Dataview then try restarting ${w}.`,EXCALIDRAW_NOT_FOUND:`Excalidraw plugin not found. Please install or enable Excalidraw then try restarting ${w}.`,EXCALIDRAW_MINAPP_VERSION:`ExcaliBrain requires Excalidraw 1.6.33 or higher. Please upgrade Excalidraw then try restarting ${w}.`,COMMAND_ADD_PARENT_FIELD:"Add dataview field to ontology as PARENT",COMMAND_ADD_CHILD_FIELD:"Add dataview field to ontology as CHILD",COMMAND_ADD_FRIEND_FIELD:"Add dataview field to ontology as FRIEND",COMMAND_START:"ExcaliBrain Normal",COMMAND_START_HOVER:"ExcaliBrain Hover-Editor",COMMAND_START_POPOUT:"ExcaliBrain Popout Window",COMMAND_STOP:"Stop ExcaliBrain",HOVER_EDITOR_ERROR:"I am sorry. Something went wrong. Most likely there was a version update to Hover Editor which I haven't addressed properly in ExcaliBrain. Normally I should get this fixed within few days",OPEN_DRAWING:"Save snapshot for editing",SEARCH_IN_VAULT:"Starred items will be listed in empty search.\nSearch for a file, a folder or a tag in your Vault.\nToggle folders and tags on/off to show in the list.",SHOW_HIDE_ATTACHMENTS:"Show/Hide attachments",SHOW_HIDE_VIRTUAL:"Show/Hide virtual nodes",SHOW_HIDE_INFERRED:"Show/Hide inferred nodes",SHOW_HIDE_ALIAS:"Show/Hide document alias",SHOW_HIDE_SIBLINGS:"Show/Hide siblings",SHOW_HIDE_FOLDER:"Show/Hide folder nodes",SHOW_HIDE_TAG:"Show/Hide tag nodes",SHOW_HIDE_PAGES:"Show/Hide page nodes (incl. defined, inferred, virtual and attachments)",PIN_LEAF:"Link ExcaliBrain to most recent active leaf"};const D={en:L}[s.moment.locale()];function N(e){return D||h({fn:N,where:"src/lang/helpers.ts",message:"Error: locale not found",data:s.moment.locale()}),D&&D[e]||L[e]}class C extends s.Modal{constructor(e,t,i){super(e),this.title=t,this.message=i}onOpen(){this.createForm()}onClose(){}createForm(){this.titleEl.setText(this.title),this.contentEl.createDiv({cls:"excalibrain-prompt-center",text:this.message}),this.contentEl.createDiv({cls:"excalibrain-prompt-center"},(e=>{e.style.textAlign="right",e.createEl("button",{text:"Ok"}).onclick=()=>{this.resolve(!0),this.close()},e.createEl("button",{text:"Cancel"}).onclick=()=>{this.resolve(!1),this.close()}}))}show(e){this.resolve=e,this.open()}}class O{constructor(e){this.style={},this.center={x:0,y:0},this.page=e.page,this.settings=e.page.plugin.settings,this.ea=e.ea,this.page.isFolder?this.style=Object.assign(Object.assign(Object.assign(Object.assign({},this.settings.baseNodeStyle),e.isCentral?this.settings.centralNodeStyle:{}),e.isSibling?this.settings.siblingNodeStyle:{}),this.settings.folderNodeStyle):this.page.isTag?this.style=Object.assign(Object.assign(Object.assign(Object.assign({},this.settings.baseNodeStyle),e.isCentral?this.settings.centralNodeStyle:{}),e.isSibling?this.settings.siblingNodeStyle:{}),this.settings.tagNodeStyle):this.style=Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},this.settings.baseNodeStyle),e.isInferred?this.settings.inferredNodeStyle:{}),e.page.isVirtual?this.settings.virtualNodeStyle:{}),e.isCentral?this.settings.centralNodeStyle:{}),e.isSibling?this.settings.siblingNodeStyle:{}),e.page.isAttachment?this.settings.attachmentNodeStyle:{}),l(this.page.primaryStyleTag,this.settings)),this.friendGateOnLeft=e.friendGateOnLeft,this.title=this.page.getTitle()}displayText(){var e;const t=(null!==(e=this.style.prefix)&&void 0!==e?e:"")+this.title;return t.length>this.style.maxLabelLength?t.substring(0,this.style.maxLabelLength-1)+"...":t}setCenter(e){this.center=e}render(){var e,t;const i=this.ea,s=this.displayText(),n=2*this.style.gateRadius;i.style.fontSize=this.style.fontSize,i.style.fontFamily=this.style.fontFamily;const a=i.measureText(`${s}m`);i.style.fillStyle=this.style.fillStyle,i.style.roughness=this.style.roughness,i.style.strokeSharpness=this.style.strokeShaprness,i.style.strokeWidth=this.style.strokeWidth,i.style.strokeColor=this.style.textColor,i.style.backgroundColor="transparent",this.id=i.addText(this.center.x-a.width/2,this.center.y-a.height/2,s,{wrapAt:this.style.maxLabelLength+5,textAlign:"center",box:!0,boxPadding:this.style.padding});const r=i.getElement(this.id);r.link=`[[${null!==(t=null===(e=this.page.file)||void 0===e?void 0:e.path)&&void 0!==t?t:this.page.path}]]`,r.backgroundColor=this.style.backgroundColor,r.strokeColor=this.style.borderColor,r.strokeStyle=this.style.strokeStyle,i.style.fillStyle=this.style.gateFillStyle,i.style.strokeColor=this.style.gateStrokeColor,i.style.strokeStyle="solid";const o=this.page.friendCount();i.style.backgroundColor=o>0?this.style.gateBackgroundColor:"transparent",this.friendGateId=i.addEllipse(this.friendGateOnLeft?this.center.x-n-this.style.padding-a.width/2:this.center.x+this.style.padding+a.width/2,this.center.y-this.style.gateRadius,n,n),this.settings.showNeighborCount&&o>0&&(i.style.fontSize=n,i.addText(this.friendGateOnLeft?o>9?this.center.x-2*n-this.style.padding-a.width/2:this.center.x-n-this.style.padding-a.width/2:this.center.x+this.style.padding+a.width/2,this.friendGateOnLeft?this.center.y-2*n:this.center.y-this.style.gateRadius+n,o.toString()));const l=this.page.parentCount();i.style.backgroundColor=l>0?this.style.gateBackgroundColor:"transparent",this.parentGateId=i.addEllipse(this.center.x-this.style.gateRadius-this.style.gateOffset,this.center.y-n-this.style.padding-a.height/2,n,n),this.settings.showNeighborCount&&l>0&&(i.style.fontSize=n,i.addText(this.center.x+n-this.style.gateOffset,this.center.y-n-this.style.padding-a.height/2,l.toString()));const h=this.page.childrenCount();i.style.backgroundColor=h>0?this.style.gateBackgroundColor:"transparent",this.childGateId=i.addEllipse(this.center.x-this.style.gateRadius+this.style.gateOffset,this.center.y+this.style.padding+a.height/2,n,n),this.settings.showNeighborCount&&h>0&&(i.style.fontSize=n,i.addText(this.center.x+n+this.style.gateOffset,this.center.y+this.style.padding+a.height/2,h.toString())),i.addToGroup([this.friendGateId,this.parentGateId,this.childGateId,this.id,r.boundElements[0].id])}}class x{constructor(t,i,s,n,a,r,o,l){this.nodeA=t,this.nodeB=i,this.nodeBRole=s,this.hierarchyDefinition=a,this.ea=r,this.isInferred=!1;const h=null==a?void 0:a.split(",").map((e=>e.trim()));this.isInferred=n===e.INFERRED;let d={};h&&h.forEach((e=>{if(l.hierarchyLinkStylesExtended[e])d=Object.assign(Object.assign({},d),l.hierarchyLinkStylesExtended[e]);else switch(e){case"file-tree":d=Object.assign(Object.assign({},d),l.settings.folderLinkStyle);break;case"tag-tree":d=Object.assign(Object.assign({},d),l.settings.tagLinkStyle)}})),this.style=Object.assign(Object.assign(Object.assign({},o.baseLinkStyle),this.isInferred?o.inferredLinkStyle:{}),d)}render(e){const i=this.ea,s=this.style;let n,a;switch(i.style.strokeStyle=s.strokeStyle,i.style.roughness=s.roughness,i.style.strokeColor=s.strokeColor,i.style.strokeWidth=s.strokeWidth,i.style.opacity=e?10:100,this.nodeBRole){case t.CHILD:n=this.nodeA.childGateId,a=this.nodeB.parentGateId;break;case t.PARENT:n=this.nodeA.parentGateId,a=this.nodeB.childGateId;break;default:n=this.nodeA.friendGateId,a=this.nodeB.friendGateId}const r=i.connectObjects(n,null,a,null,{startArrowHead:"none"===s.startArrowHead?null:s.startArrowHead,endArrowHead:"none"===s.endArrowHead?null:s.endArrowHead});s.showLabel&&this.hierarchyDefinition&&(i.style.fontSize=s.fontSize,i.style.fontFamily=s.fontFamily,i.style.strokeColor=s.textColor,i.addLabelToLine(r,this.hierarchyDefinition))}}const A={excalibrainFilepath:"excalibrain.md",indexUpdateInterval:5e3,hierarchy:{exclusions:["excalidraw-font","excalidraw-font-color","excalidraw-css","excalidraw-plugin","excalidraw-link-brackets","excalidraw-link-prefix","excalidraw-border-color","excalidraw-default-mode","excalidraw-export-dark","excalidraw-export-transparent","excalidraw-export-svgpadding","excalidraw-export-pngscale","excalidraw-url-prefix","excalidraw-linkbutton-opacity","excalidraw-onload-script","kanban-plugin"],parents:["Parent","Parents","up","u"],children:["Children","Child","down","d"],friends:["Friends","Friend","Jump","Jumps","j"]},inferAllLinksAsFriends:!1,inverseInfer:!1,renderAlias:!0,nodeTitleScript:"",backgroundColor:"#0c3e6aff",excludeFilepaths:[],showInferredNodes:!0,showAttachments:!0,showVirtualNodes:!0,showFolderNodes:!1,showTagNodes:!1,showPageNodes:!0,showNeighborCount:!0,showFullTagName:!1,maxItemCount:30,renderSiblings:!0,baseNodeStyle:T,centralNodeStyle:{fontSize:30,backgroundColor:"#C49A13FF",textColor:"#000000ff"},inferredNodeStyle:{backgroundColor:"#000005b3",textColor:"#95c7f3ff"},virtualNodeStyle:{backgroundColor:"#ff000066",fillStyle:"hachure",textColor:"#ffffffff"},siblingNodeStyle:{fontSize:15},attachmentNodeStyle:{prefix:"📎 "},folderNodeStyle:{prefix:"📂 ",strokeShaprness:"sharp",borderColor:"#ffd700ff",textColor:"#ffd700ff"},tagNodeStyle:{prefix:"#",strokeShaprness:"sharp",borderColor:"#4682b4ff",textColor:"#4682b4ff"},tagNodeStyles:{},tagStyleList:[],baseLinkStyle:b,inferredLinkStyle:{strokeStyle:"dashed"},folderLinkStyle:{strokeColor:"#ffd700ff"},tagLinkStyle:{strokeColor:"#4682b4ff"},hierarchyLinkStyles:{},navigationHistory:[],allowOntologySuggester:!0,ontologySuggesterParentTrigger:"::p",ontologySuggesterChildTrigger:"::c",ontologySuggesterFriendTrigger:"::f",ontologySuggesterTrigger:":::",ontologySuggesterMidSentenceTrigger:"(",boldFields:!1,allowAutozoom:!0,allowAutofocuOnSearch:!0},I="excalibrain-settings-disabled",k=e=>(255*e|256).toString(16).slice(1),F=e=>createFragment((t=>t.createDiv().innerHTML=e)),_=e=>{const t=document.getElementById(e);if(!t)return;const i=t.parentNode;i&&i.removeChild(t)},R=(e,t)=>{const i=document.createElement("style");i.id=e,i.innerHTML=`.${t} {display: none;}`,document.body.appendChild(i)};class P extends s.PluginSettingTab{constructor(e,t){super(e,t),this.dirty=!1,this.updateTimer=!1,this.plugin=t}get hierarchyStyleList(){return v.concat(Array.from(this.plugin.settings.hierarchy.parents)).concat(Array.from(this.plugin.settings.hierarchy.children)).concat(Array.from(this.plugin.settings.hierarchy.friends))}async updateNodeDemoImg(){this.ea.reset(),this.ea.canvas.viewBackgroundColor=this.plugin.settings.backgroundColor,this.demoNode.style=Object.assign(Object.assign({},this.demoNodeStyle.getInheritedStyle()),this.demoNodeStyle.style),this.demoNode.render();const e=await this.ea.createSVG(null,!0,{withBackground:!0,withTheme:!1},null,"",40);e.removeAttribute("width"),e.removeAttribute("height"),this.demoNodeImg.setAttribute("src",d(e.outerHTML))}async updateLinkDemoImg(){this.ea.reset(),this.ea.canvas.viewBackgroundColor=this.plugin.settings.backgroundColor;const s=new y(null,"Start node",null,this.plugin),n=new y(null,"End node",null,this.plugin),a=this.plugin.settings.hierarchy;a.friends.contains(this.demoLinkStyle.display)?(s.addFriend(n,e.DEFINED,i.FROM),n.addFriend(s,e.DEFINED,i.TO)):a.parents.contains(this.demoLinkStyle.display)?(s.addParent(n,e.DEFINED,i.FROM),n.addChild(s,e.DEFINED,i.TO)):(s.addChild(n,e.DEFINED,i.FROM),n.addParent(s,e.DEFINED,i.TO));const r=new O({ea:this.ea,page:s,isInferred:!1,isCentral:!0,isSibling:!1,friendGateOnLeft:!0});r.ea=this.ea,r.setCenter({x:0,y:0});const o=new O({ea:this.ea,page:n,isInferred:!1,isCentral:!1,isSibling:!1,friendGateOnLeft:!1});o.ea=this.ea;let l=t.CHILD;a.friends.contains(this.demoLinkStyle.display)?(o.setCenter({x:-300,y:0}),l=t.FRIEND):a.parents.contains(this.demoLinkStyle.display)?(o.setCenter({x:0,y:-150}),l=t.PARENT):o.setCenter({x:0,y:150});const h=new x(r,o,l,e.DEFINED,"base",this.ea,this.plugin.settings,this.plugin);r.style=Object.assign(Object.assign({},this.plugin.settings.baseNodeStyle),this.plugin.settings.centralNodeStyle),r.render(),o.style=Object.assign(Object.assign({},this.demoNodeStyle.getInheritedStyle()),this.demoNodeStyle.style),o.render(),h.style=Object.assign(Object.assign({},this.demoLinkStyle.getInheritedStyle()),this.demoLinkStyle.style),h.render(!1);const g=await this.ea.createSVG(null,!0,{withBackground:!0,withTheme:!1},null,"",40);g.removeAttribute("width"),g.removeAttribute("height"),this.demoLinkImg.setAttribute("src",d(g.outerHTML))}async hide(){var e;this.dirty&&(""===this.plugin.settings.ontologySuggesterParentTrigger&&(this.plugin.settings.ontologySuggesterParentTrigger="::p"),""===this.plugin.settings.ontologySuggesterChildTrigger&&(this.plugin.settings.ontologySuggesterChildTrigger="::c"),""===this.plugin.settings.ontologySuggesterFriendTrigger&&(this.plugin.settings.ontologySuggesterFriendTrigger="::c"),""===this.plugin.settings.ontologySuggesterTrigger&&(this.plugin.settings.ontologySuggesterTrigger=":::"),""===this.plugin.settings.ontologySuggesterMidSentenceTrigger&&(this.plugin.settings.ontologySuggesterMidSentenceTrigger="("),this.plugin.setHierarchyLinkStylesExtended(),this.plugin.settings.tagStyleList=Object.keys(this.plugin.settings.tagNodeStyles),this.plugin.loadCustomNodeLabelFunction(),this.plugin.saveSettings(),this.updateTimer&&this.plugin.scene&&!this.plugin.scene.terminated&&this.plugin.scene.setTimer(),null===(e=this.plugin.scene)||void 0===e||e.reRender())}colorpicker(e,t,i,n,a,r,o,l){let h,d,g,c,p,u;const f=new s.Setting(e).setName(t);i&&f.setDesc(F(i));const y=e=>{e?f.settingEl.addClass(I):f.settingEl.removeClass(I),d.disabled=e,d.style.opacity=e?"0.3":"1",h.setDisabled(e),h.sliderEl.style.opacity=e?"0.3":"1",c.style.opacity=e?"0.3":"1",p.style.opacity=e?"0.3":"1",u.style.opacity=e?"0.3":"1"};o&&f.addToggle((e=>{g=e,e.toggleEl.addClass("excalibrain-settings-toggle"),e.setValue(void 0!==n()).setTooltip(N("NODESTYLE_INCLUDE_TOGGLE")).onChange((e=>{if(this.dirty=!0,!e)return y(!0),void r();a(d.value+k(h.getValue())),y(!1)}))})),f.settingEl.removeClass("mod-toggle"),c=createEl("span",{text:"color:",cls:"excalibrain-settings-colorlabel"}),f.controlEl.appendChild(c),d=createEl("input",{type:"color",cls:"excalibrain-settings-colorpicker"},(e=>{var t;e.value=(null!==(t=n())&&void 0!==t?t:l).substring(0,7),e.onchange=()=>{a(e.value+k(h.getValue())),this.dirty=!0}})),f.controlEl.appendChild(d),p=createEl("span",{text:"opacity:",cls:"excalibrain-settings-opacitylabel"}),f.controlEl.appendChild(p),f.addSlider((e=>{var t,i;h=e,e.setLimits(0,1,.1).setValue((i=null!==(t=n())&&void 0!==t?t:l,parseInt(i.substring(7,9),16)/255)).onChange((e=>{a(d.value+k(e)),u.innerText=` ${e.toString()}`,d.style.opacity=e.toString(),this.dirty=!0}))})),u=createDiv({text:`${h.getValue().toString()}`,cls:"excalibrain-settings-sliderlabel"}),f.controlEl.appendChild(u),d.style.opacity=h.getValue().toString(),y(o&&!g.getValue())}numberslider(e,t,i,n,a,r,o,l,h){let d,g,c;const p=new s.Setting(e).setName(t),u=e=>{e?p.settingEl.addClass(I):p.settingEl.removeClass(I),c.setDisabled(e),c.sliderEl.style.opacity=e?"0.3":"1",d.style.opacity=e?"0.3":"1"};l&&p.addToggle((e=>{g=e,e.toggleEl.addClass("excalibrain-settings-toggle"),e.setValue(void 0!==a()).setTooltip(N("NODESTYLE_INCLUDE_TOGGLE")).onChange((e=>{if(this.dirty=!0,!e)return u(!0),void o();r(c.getValue()),u(!1)}))})),p.addSlider((e=>{var t;c=e,e.setLimits(n.min,n.max,n.step).setValue(null!==(t=a())&&void 0!==t?t:h).onChange((async e=>{d.innerText=` ${e.toString()}`,r(e),this.dirty=!0}))})),i&&p.setDesc(F(i)),p.settingEl.createDiv("",(e=>{d=e,e.style.minWidth="2.3em",e.style.textAlign="right",e.innerText=` ${c.getValue().toString()}`})),u(l&&!g.getValue())}toggle(e,t,i,n,a,r,o,l){let h,d;const g=new s.Setting(e).setName(t),c=e=>{e?g.settingEl.addClass(I):g.settingEl.removeClass(I),d.setDisabled(e),d.toggleEl.style.opacity=e?"0.3":"1"};o&&g.addToggle((e=>{h=e,e.toggleEl.addClass("excalibrain-settings-toggle"),e.setValue(void 0!==n()).setTooltip(N("NODESTYLE_INCLUDE_TOGGLE")).onChange((e=>{if(this.dirty=!0,!e)return c(!0),void r();a(d.getValue()),c(!1)}))})),g.addToggle((e=>{var t;d=e,e.setValue(null!==(t=n())&&void 0!==t?t:l).onChange((async e=>{a(e),this.dirty=!0}))})),i&&g.setDesc(F(i)),c(o&&!h.getValue())}dropdownpicker(e,t,i,n,a,r,o,l,h){let d,g;const c=new s.Setting(e).setName(t),p=e=>{e?c.settingEl.addClass(I):c.settingEl.removeClass(I),d.setDisabled(e),d.selectEl.style.opacity=e?"0.3":"1"};l&&c.addToggle((e=>{g=e,e.toggleEl.addClass("excalibrain-settings-toggle"),e.setValue(void 0!==a()).setTooltip(N("NODESTYLE_INCLUDE_TOGGLE")).onChange((e=>{if(this.dirty=!0,!e)return p(!0),void o();r(d.getValue()),p(!1)}))})),c.addDropdown((e=>{var t;d=e,e.addOptions(n).setValue(null!==(t=a())&&void 0!==t?t:h).onChange((e=>{r(e),this.dirty=!0}))})),i&&c.setDesc(F(i)),p(l&&!g.getValue())}nodeSettings(e,t,i=!0,n){let a,r;const o=new s.Setting(e).setName(N("NODESTYLE_PREFIX_NAME")).setDesc(F(N("NODESTYLE_PREFIX_DESC"))),l=e=>{e?o.settingEl.addClass(I):o.settingEl.removeClass(I),a.setDisabled(e),a.inputEl.style.opacity=e?"0.3":"1"};i&&o.addToggle((e=>{r=e,e.toggleEl.addClass("excalibrain-settings-toggle"),e.setValue(void 0!==t.prefix).setTooltip(N("NODESTYLE_INCLUDE_TOGGLE")).onChange((e=>{if(this.dirty=!0,!e)return l(!0),t.prefix=void 0,void this.updateNodeDemoImg();l(!1)}))})),o.addText((e=>{var i;a=e,e.setValue(null!==(i=t.prefix)&&void 0!==i?i:n.prefix).onChange((e=>{t.prefix=e,this.updateNodeDemoImg(),this.dirty=!0}))})),l(i&&!r.getValue()),this.colorpicker(e,N("NODESTYLE_BGCOLOR"),null,(()=>t.backgroundColor),(e=>{t.backgroundColor=e,this.updateNodeDemoImg()}),(()=>{delete t.backgroundColor,this.updateNodeDemoImg()}),i,n.backgroundColor),this.dropdownpicker(e,N("NODESTYLE_BG_FILLSTYLE"),null,{hachure:"Hachure","cross-hatch":"Cross-hatch",solid:"Solid"},(()=>{var e;return null===(e=t.fillStyle)||void 0===e?void 0:e.toString()}),(e=>{t.fillStyle=e,this.updateNodeDemoImg()}),(()=>{delete t.fillStyle,this.updateNodeDemoImg()}),i,n.fillStyle.toString()),this.colorpicker(e,N("NODESTYLE_TEXTCOLOR"),null,(()=>t.textColor),(e=>{t.textColor=e,this.updateNodeDemoImg()}),(()=>{delete t.textColor,this.updateNodeDemoImg()}),i,n.textColor),this.colorpicker(e,N("NODESTYLE_BORDERCOLOR"),null,(()=>t.borderColor),(e=>{t.borderColor=e,this.updateNodeDemoImg()}),(()=>{delete t.borderColor,this.updateNodeDemoImg()}),i,n.borderColor),this.numberslider(e,N("NODESTYLE_FONTSIZE"),null,{min:10,max:50,step:5},(()=>t.fontSize),(e=>{t.fontSize=e,this.updateNodeDemoImg()}),(()=>{delete t.fontSize,this.updateNodeDemoImg()}),i,n.fontSize),this.dropdownpicker(e,N("NODESTYLE_FONTFAMILY"),null,{1:"Hand-drawn",2:"Normal",3:"Code",4:"Fourth (custom) Font"},(()=>{var e;return null===(e=t.fontFamily)||void 0===e?void 0:e.toString()}),(e=>{t.fontFamily=parseInt(e),this.updateNodeDemoImg()}),(()=>{delete t.fontFamily,this.updateNodeDemoImg()}),i,n.fontFamily.toString()),this.numberslider(e,N("NODESTYLE_MAXLABELLENGTH_NAME"),N("NODESTYLE_MAXLABELLENGTH_DESC"),{min:15,max:100,step:5},(()=>t.maxLabelLength),(e=>{t.maxLabelLength=e,this.updateNodeDemoImg()}),(()=>{delete t.maxLabelLength,this.updateNodeDemoImg()}),i,n.maxLabelLength),this.dropdownpicker(e,N("NODESTYLE_ROUGHNESS"),null,{0:"Architect",1:"Artist",2:"Cartoonist"},(()=>{var e;return null===(e=t.roughness)||void 0===e?void 0:e.toString()}),(e=>{t.roughness=parseInt(e),this.updateNodeDemoImg()}),(()=>{delete t.roughness,this.updateNodeDemoImg()}),i,n.roughness.toString()),this.dropdownpicker(e,N("NODESTYLE_SHARPNESS"),null,{sharp:"Sharp",round:"Round"},(()=>t.strokeShaprness),(e=>{t.strokeShaprness=e,this.updateNodeDemoImg()}),(()=>{delete t.strokeShaprness,this.updateNodeDemoImg()}),i,n.strokeShaprness),this.numberslider(e,N("NODESTYLE_STROKEWIDTH"),null,{min:.5,max:6,step:.5},(()=>t.strokeWidth),(e=>{t.strokeWidth=e,this.updateNodeDemoImg()}),(()=>{delete t.strokeWidth,this.updateNodeDemoImg()}),i,n.strokeWidth),this.dropdownpicker(e,N("NODESTYLE_STROKESTYLE"),null,{solid:"Solid",dashed:"Dashed",dotted:"Dotted"},(()=>t.strokeStyle),(e=>{t.strokeStyle=e,this.updateNodeDemoImg()}),(()=>{delete t.strokeStyle,this.updateNodeDemoImg()}),i,n.strokeStyle),this.numberslider(e,N("NODESTYLE_RECTANGLEPADDING"),null,{min:5,max:50,step:5},(()=>t.padding),(e=>{t.padding=e,this.updateNodeDemoImg()}),(()=>{delete t.padding,this.updateNodeDemoImg()}),i,n.padding),this.numberslider(e,N("NODESTYLE_GATE_RADIUS_NAME"),N("NODESTYLE_GATE_RADIUS_DESC"),{min:3,max:10,step:1},(()=>t.gateRadius),(e=>{t.gateRadius=e,this.updateNodeDemoImg()}),(()=>{delete t.gateRadius,this.updateNodeDemoImg()}),i,n.gateRadius),this.numberslider(e,N("NODESTYLE_GATE_OFFSET_NAME"),N("NODESTYLE_GATE_OFFSET_DESC"),{min:0,max:25,step:1},(()=>t.gateOffset),(e=>{t.gateOffset=e,this.updateNodeDemoImg()}),(()=>{delete t.gateOffset,this.updateNodeDemoImg()}),i,n.gateOffset),this.colorpicker(e,N("NODESTYLE_GATE_COLOR"),null,(()=>t.gateStrokeColor),(e=>{t.gateStrokeColor=e,this.updateNodeDemoImg()}),(()=>{delete t.gateStrokeColor,this.updateNodeDemoImg()}),i,n.gateStrokeColor),this.colorpicker(e,N("NODESTYLE_GATE_BGCOLOR_NAME"),N("NODESTYLE_GATE_BGCOLOR_DESC"),(()=>t.gateBackgroundColor),(e=>{t.gateBackgroundColor=e,this.updateNodeDemoImg()}),(()=>{delete t.gateBackgroundColor,this.updateNodeDemoImg()}),i,n.gateBackgroundColor),this.dropdownpicker(e,N("NODESTYLE_GATE_FILLSTYLE"),null,{hachure:"Hachure","cross-hatch":"Cross-hatch",solid:"Solid"},(()=>{var e;return null===(e=t.gateFillStyle)||void 0===e?void 0:e.toString()}),(e=>{t.gateFillStyle=e,this.updateNodeDemoImg()}),(()=>{delete t.gateFillStyle,this.updateNodeDemoImg()}),i,n.gateFillStyle.toString())}linkSettings(e,t,i=!0,s){this.colorpicker(e,N("LINKSTYLE_COLOR"),null,(()=>t.strokeColor),(e=>{t.strokeColor=e,this.updateLinkDemoImg()}),(()=>{delete t.strokeColor,this.updateLinkDemoImg()}),i,s.strokeColor),this.numberslider(e,N("LINKSTYLE_WIDTH"),null,{min:.5,max:10,step:.5},(()=>t.strokeWidth),(e=>{t.strokeWidth=e,this.updateLinkDemoImg()}),(()=>{delete t.strokeWidth,this.updateLinkDemoImg()}),i,s.strokeWidth),this.dropdownpicker(e,N("LINKSTYLE_ROUGHNESS"),null,{0:"Architect",1:"Artist",2:"Cartoonist"},(()=>{var e;return null===(e=t.roughness)||void 0===e?void 0:e.toString()}),(e=>{t.roughness=parseInt(e),this.updateLinkDemoImg()}),(()=>{delete t.roughness,this.updateLinkDemoImg()}),i,s.roughness.toString()),this.dropdownpicker(e,N("LINKSTYLE_STROKE"),null,{solid:"Solid",dashed:"Dashed",dotted:"Dotted"},(()=>t.strokeStyle),(e=>{t.strokeStyle=e,this.updateLinkDemoImg()}),(()=>{delete t.strokeStyle,this.updateLinkDemoImg()}),i,s.strokeStyle),this.dropdownpicker(e,N("LINKSTYLE_ARROWSTART"),null,{none:"None",arrow:"Arrow",bar:"Bar",dot:"Dot",triangle:"Triangle"},(()=>t.startArrowHead),(e=>{t.startArrowHead=""===e?null:e,this.updateLinkDemoImg()}),(()=>{delete t.startArrowHead,this.updateLinkDemoImg()}),i,s.startArrowHead),this.dropdownpicker(e,N("LINKSTYLE_ARROWEND"),null,{none:"None",arrow:"Arrow",bar:"Bar",dot:"Dot",triangle:"Triangle"},(()=>t.endArrowHead),(e=>{t.endArrowHead=""===e?null:e,this.updateLinkDemoImg()}),(()=>{delete t.endArrowHead,this.updateLinkDemoImg()}),i,s.endArrowHead),this.toggle(e,N("LINKSTYLE_SHOWLABEL"),null,(()=>t.showLabel),(e=>{t.showLabel=e,this.updateLinkDemoImg()}),(()=>{delete t.showLabel,this.updateLinkDemoImg()}),i,s.showLabel),this.colorpicker(e,N("NODESTYLE_TEXTCOLOR"),null,(()=>t.textColor),(e=>{t.textColor=e,this.updateLinkDemoImg()}),(()=>{delete t.textColor,this.updateLinkDemoImg()}),i,s.textColor),this.numberslider(e,N("LINKSTYLE_FONTSIZE"),null,{min:6,max:30,step:3},(()=>t.fontSize),(e=>{t.fontSize=e,this.updateLinkDemoImg()}),(()=>{delete t.fontSize,this.updateLinkDemoImg()}),i,s.fontSize),this.dropdownpicker(e,N("LINKSTYLE_FONTFAMILY"),null,{1:"Hand-drawn",2:"Normal",3:"Code",4:"Fourth (custom) Font"},(()=>{var e;return null===(e=t.fontFamily)||void 0===e?void 0:e.toString()}),(e=>{t.fontFamily=parseInt(e),this.updateLinkDemoImg()}),(()=>{delete t.fontFamily,this.updateLinkDemoImg()}),i,s.fontFamily.toString())}getUnusedFieldNames(){const e=new Set;this.plugin.DVAPI.index.pages.forEach((t=>{const i=null==t?void 0:t.fields.keys();if(!i)return;let s;for(;!(s=i.next()).done;)s.value.contains(",")||s.value.startsWith("**")&&s.value.endsWith("**")||e.add(s.value)}));const t=new Map;e.forEach((e=>{t.set(e,e.toLowerCase().replaceAll(" ","-"))}));const i=new Set;return this.plugin.settings.hierarchy.parents.forEach((e=>i.add(e.toLowerCase().replaceAll(" ","-")))),this.plugin.settings.hierarchy.children.forEach((e=>i.add(e.toLowerCase().replaceAll(" ","-")))),this.plugin.settings.hierarchy.friends.forEach((e=>i.add(e.toLowerCase().replaceAll(" ","-")))),this.plugin.settings.hierarchy.exclusions.forEach((e=>i.add(e.toLowerCase().replaceAll(" ","-")))),Array.from(t.entries()).forEach((([e,s])=>i.has(e.toLowerCase().replaceAll(" ","-"))||i.has(s)?(t.delete(e),void t.delete(s)):void(e!==s&&t.delete(s)))),Array.from(t.keys()).sort(((e,t)=>e.toLowerCase()<t.toLowerCase()?-1:1)).join(", ")}async display(){const t=this.plugin.settings.navigationHistory;await this.plugin.loadSettings(),this.plugin.settings.navigationHistory=t,this.ea=S();const n=new y(null,"This is a demo node that is 46 characters long",null,this.plugin),a=new y(null,"This is a child node",null,this.plugin);n.addChild(a,e.DEFINED,i.FROM),a.addParent(n,e.DEFINED,i.TO),this.demoNode=new O({ea:this.ea,page:n,isInferred:!1,isCentral:!1,isSibling:!1,friendGateOnLeft:!0}),this.demoNode.ea=this.ea,this.demoNode.setCenter({x:0,y:0});const{containerEl:r}=this;this.containerEl.empty();const o=r.createDiv("coffee");o.addClass("ex-coffee-div"),o.createEl("a",{href:"https://ko-fi.com/zsolt"}).createEl("img",{attr:{src:"https://cdn.ko-fi.com/cdn/kofi3.png?v=3"}}).height=45,new s.Setting(r).setName(N("EXCALIBRAIN_FILE_NAME")).setDesc(F(N("EXCALIBRAIN_FILE_DESC"))).addText((e=>e.setValue(this.plugin.settings.excalibrainFilepath).onChange((t=>{this.dirty=!0,t.endsWith(".md")||(t+=t.endsWith(".m")?"d":t.endsWith(".")?"md":".md"),this.app.vault.getAbstractFileByPath(t)?new C(this.app,"⚠ File Exists",`${t} already exists in your Vault. Is it ok to overwrite this file?`).show((i=>{i&&(this.plugin.settings.excalibrainFilepath=t,this.dirty=!0,e.inputEl.value=t)})):(this.plugin.settings.excalibrainFilepath=t,this.dirty=!0)})).inputEl.onblur=()=>{e.setValue(this.plugin.settings.excalibrainFilepath)})),this.numberslider(r,N("INDEX_REFRESH_FREQ_NAME"),N("INDEX_REFRESH_FREQ_DESC"),{min:5,max:120,step:5},(()=>this.plugin.settings.indexUpdateInterval/1e3),(e=>{this.plugin.settings.indexUpdateInterval=1e3*e,this.updateTimer=!0}),(()=>{}),!1,5e3),this.containerEl.createEl("h1",{cls:"excalibrain-settings-h1",text:N("HIERARCHY_HEAD")}),this.containerEl.createEl("p",{}).innerHTML=N("HIERARCHY_DESC");let l=()=>{};const h=new s.Setting(r).setName(N("PARENTS_NAME")).addTextArea((e=>{e.inputEl.style.height="90px",e.inputEl.style.width="100%",e.setValue(this.plugin.settings.hierarchy.parents.join(", ")).onChange((e=>{this.plugin.settings.hierarchy.parents=e.split(",").map((e=>e.trim())).sort(((e,t)=>e.toLowerCase()<t.toLowerCase()?-1:1)),this.plugin.hierarchyLowerCase.parents=[],this.plugin.settings.hierarchy.parents.forEach((e=>this.plugin.hierarchyLowerCase.parents.push(e.toLowerCase().replaceAll(" ","-")))),l(),this.dirty=!0}))}));h.nameEl.addClass("excalibrain-setting-nameEl"),h.descEl.addClass("excalibrain-setting-descEl"),h.controlEl.addClass("excalibrain-setting-controlEl");const d=new s.Setting(r).setName(N("CHILDREN_NAME")).addTextArea((e=>{e.inputEl.style.height="90px",e.inputEl.style.width="100%",e.setValue(this.plugin.settings.hierarchy.children.join(", ")).onChange((e=>{this.plugin.settings.hierarchy.children=e.split(",").map((e=>e.trim())).sort(((e,t)=>e.toLowerCase()<t.toLowerCase()?-1:1)),this.plugin.hierarchyLowerCase.children=[],this.plugin.settings.hierarchy.children.forEach((e=>this.plugin.hierarchyLowerCase.children.push(e.toLowerCase().replaceAll(" ","-")))),l(),this.dirty=!0}))}));d.nameEl.addClass("excalibrain-setting-nameEl"),d.descEl.addClass("excalibrain-setting-descEl"),d.controlEl.addClass("excalibrain-setting-controlEl");const g=new s.Setting(r).setName(N("FRIENDS_NAME")).addTextArea((e=>{e.inputEl.style.height="90px",e.inputEl.style.width="100%",e.setValue(this.plugin.settings.hierarchy.friends.join(", ")).onChange((e=>{this.plugin.settings.hierarchy.friends=e.split(",").map((e=>e.trim())).sort(((e,t)=>e.toLowerCase()<t.toLowerCase()?-1:1)),this.plugin.hierarchyLowerCase.friends=[],this.plugin.settings.hierarchy.friends.forEach((e=>this.plugin.hierarchyLowerCase.friends.push(e.toLowerCase().replaceAll(" ","-")))),l(),this.dirty=!0}))}));g.nameEl.addClass("excalibrain-setting-nameEl"),g.descEl.addClass("excalibrain-setting-descEl"),g.controlEl.addClass("excalibrain-setting-controlEl");const c=new s.Setting(r).setName(N("EXCLUSIONS_NAME")).setDesc(N("EXCLUSIONS_DESC")).addTextArea((e=>{e.inputEl.style.height="90px",e.inputEl.style.width="100%",e.setValue(this.plugin.settings.hierarchy.exclusions.join(", ")).onChange((e=>{this.plugin.settings.hierarchy.exclusions=e.split(",").map((e=>e.trim())).sort(((e,t)=>e.toLowerCase()<t.toLowerCase()?-1:1)),l(),this.dirty=!0}))}));let p;c.nameEl.addClass("excalibrain-setting-nameEl"),c.descEl.addClass("excalibrain-setting-descEl"),c.controlEl.addClass("excalibrain-setting-controlEl");const u=new s.Setting(r).setName(N("UNASSIGNED_NAME")).setDesc(N("UNASSIGNED_DESC")).addTextArea((e=>{p=e,e.inputEl.style.height="90px",e.inputEl.style.width="100%",e.setValue(this.getUnusedFieldNames()),e.setDisabled(!0)}));let f,E,m,w,b,T;u.nameEl.addClass("excalibrain-setting-nameEl"),u.descEl.addClass("excalibrain-setting-descEl"),u.controlEl.addClass("excalibrain-setting-controlEl"),new s.Setting(r).setName(N("INFER_NAME")).setDesc(F(N("INFER_DESC"))).addToggle((e=>e.setValue(this.plugin.settings.inferAllLinksAsFriends).onChange((e=>{this.plugin.settings.inferAllLinksAsFriends=e,this.dirty=!0})))),new s.Setting(r).setName(N("REVERSE_NAME")).setDesc(F(N("REVERSE_DESC"))).addToggle((e=>e.setValue(this.plugin.settings.inverseInfer).onChange((e=>{this.plugin.settings.inverseInfer=e,this.dirty=!0})))),new s.Setting(r).setName(N("ONTOLOGY_SUGGESTER_NAME")).setDesc(N("ONTOLOGY_SUGGESTER_DESC")).addToggle((e=>e.setValue(this.plugin.settings.allowOntologySuggester).onChange((e=>{this.plugin.settings.allowOntologySuggester=e,w.setDisabled(!e),f.setDisabled(!e),E.setDisabled(!e),m.setDisabled(!e),b.setDisabled(!e),T.setDisabled(!e),this.dirty=!0})))),w=new s.Setting(r).setName(N("ONTOLOGY_SUGGESTER_ALL_NAME")).setDisabled(!this.plugin.settings.allowOntologySuggester).addText((e=>e.setValue(this.plugin.settings.ontologySuggesterTrigger).onChange((e=>{this.plugin.settings.ontologySuggesterTrigger=e,this.dirty=!0})))),f=new s.Setting(r).setName(N("ONTOLOGY_SUGGESTER_PARENT_NAME")).setDisabled(!this.plugin.settings.allowOntologySuggester).addText((e=>e.setValue(this.plugin.settings.ontologySuggesterParentTrigger).onChange((e=>{this.plugin.settings.ontologySuggesterParentTrigger=e,this.dirty=!0})))),E=new s.Setting(r).setName(N("ONTOLOGY_SUGGESTER_CHILD_NAME")).setDisabled(!this.plugin.settings.allowOntologySuggester).addText((e=>e.setValue(this.plugin.settings.ontologySuggesterChildTrigger).onChange((e=>{this.plugin.settings.ontologySuggesterChildTrigger=e,this.dirty=!0})))),m=new s.Setting(r).setName(N("ONTOLOGY_SUGGESTER_FRIEND_NAME")).setDisabled(!this.plugin.settings.allowOntologySuggester).addText((e=>e.setValue(this.plugin.settings.ontologySuggesterFriendTrigger).onChange((e=>{this.plugin.settings.ontologySuggesterFriendTrigger=e,this.dirty=!0})))),b=new s.Setting(r).setName(N("MID_SENTENCE_SUGGESTER_TRIGGER_NAME")).setDesc(F(N("MID_SENTENCE_SUGGESTER_TRIGGER_DESC"))).addDropdown((e=>{e.addOption("(","(").addOption("[","[").setValue(this.plugin.settings.ontologySuggesterMidSentenceTrigger).onChange((e=>{this.plugin.settings.ontologySuggesterMidSentenceTrigger=e,this.dirty=!0}))})),T=new s.Setting(r).setName(N("BOLD_FIELDS_NAME")).setDesc(F(N("BOLD_FIELDS_DESC"))).addToggle((e=>e.setValue(this.plugin.settings.boldFields).onChange((e=>{this.plugin.settings.boldFields=e,this.dirty=!0})))),this.containerEl.createEl("h1",{cls:"excalibrain-settings-h1",text:N("DISPLAY_HEAD")});const L=new s.Setting(r).setName(N("EXCLUDE_PATHLIST_NAME")).setDesc(F(N("EXCLUDE_PATHLIST_DESC"))).addTextArea((e=>{e.inputEl.style.height="100px",e.inputEl.style.width="100%",e.setValue(this.plugin.settings.excludeFilepaths.join(", ")).onChange((e=>{const t=(e=e.replaceAll("\n"," ")).split(",").map((e=>e.trim()));this.plugin.settings.excludeFilepaths=t.filter((e=>""!==e)),this.dirty=!0}))}));L.descEl.style.width="90%",L.controlEl.style.width="90%",new s.Setting(r).setName(N("SHOW_FULL_TAG_PATH_NAME")).setDesc(F(N("SHOW_FULL_TAG_PATH_DESC"))).addToggle((e=>e.setValue(this.plugin.settings.showFullTagName).onChange((e=>{this.plugin.settings.showFullTagName=e,this.dirty=!0})))),new s.Setting(r).setName(N("RENDERALIAS_NAME")).setDesc(F(N("RENDERALIAS_DESC"))).addToggle((e=>e.setValue(this.plugin.settings.renderAlias).onChange((e=>{this.plugin.settings.renderAlias=e,this.dirty=!0}))));const D=new s.Setting(r).setName(N("NODETITLE_SCRIPT_NAME")).setDesc(F(N("NODETITLE_SCRIPT_DESC"))).addTextArea((e=>{e.inputEl.style.height="200px",e.inputEl.style.width="100%",e.setValue(this.plugin.settings.nodeTitleScript).onChange((e=>{this.plugin.settings.nodeTitleScript=e,this.dirty=!0}))}));let x,A;D.descEl.style.width="90%",D.controlEl.style.width="90%",new s.Setting(r).setName(N("SHOWINFERRED_NAME")).setDesc(F(N("SHOWINFERRED_DESC"))).addToggle((e=>e.setValue(this.plugin.settings.showInferredNodes).onChange((e=>{this.plugin.settings.showInferredNodes=e,this.dirty=!0})))),new s.Setting(r).setName(N("SHOWATTACHMENTS_NAME")).setDesc(F(N("SHOWATTACHMENTS_DESC"))).addToggle((e=>e.setValue(this.plugin.settings.showAttachments).onChange((e=>{this.plugin.settings.showAttachments=e,this.dirty=!0})))),new s.Setting(r).setName(N("SHOWVIRTUAL_NAME")).setDesc(F(N("SHOWVIRTUAL_DESC"))).addToggle((e=>e.setValue(this.plugin.settings.showVirtualNodes).onChange((e=>{this.plugin.settings.showVirtualNodes=e,this.dirty=!0})))),this.numberslider(r,N("MAX_ITEMCOUNT_NAME"),N("MAX_ITEMCOUNT_DESC"),{min:5,max:150,step:5},(()=>this.plugin.settings.maxItemCount),(e=>this.plugin.settings.maxItemCount=e),(()=>{}),!1,30),new s.Setting(r).setName(N("SHOW_COUNT_NAME")).setDesc(F(N("SHOW_COUNT_DESC"))).addToggle((e=>e.setValue(this.plugin.settings.showNeighborCount).onChange((e=>{this.plugin.settings.showNeighborCount=e,this.dirty=!0})))),new s.Setting(r).setName(N("ALLOW_AUTOZOOM_NAME")).setDesc(F(N("ALLOW_AUTOZOOM_DESC"))).addToggle((e=>e.setValue(this.plugin.settings.allowAutozoom).onChange((e=>{this.plugin.settings.allowAutozoom=e,this.dirty=!0})))),new s.Setting(r).setName(N("ALLOW_AUTOFOCUS_ON_SEARCH_NAME")).setDesc(F(N("ALLOW_AUTOFOCUS_ON_SEARCH_DESC"))).addToggle((e=>e.setValue(this.plugin.settings.allowAutofocuOnSearch).onChange((e=>{this.plugin.settings.allowAutofocuOnSearch=e,this.dirty=!0})))),r.createEl("h1",{cls:"excalibrain-settings-h1",text:N("STYLE_HEAD")}),this.containerEl.createEl("p",{}).innerHTML=N("STYLE_DESC"),this.colorpicker(r,N("CANVAS_BGCOLOR"),null,(()=>this.plugin.settings.backgroundColor),(e=>{this.plugin.settings.backgroundColor=e,this.updateNodeDemoImg()}),(()=>{}),!1,this.plugin.settings.backgroundColor);const k=e=>{A.empty();const t=this.plugin.nodeStyles[e];this.nodeSettings(A,t.style,t.allowOverride,t.getInheritedStyle()),this.demoNodeStyle=t,this.updateNodeDemoImg()},P=new s.Setting(r).setName(N("TAGLIST_NAME")).setDesc(N("TAGLIST_DESC")).addTextArea((e=>{e.inputEl.style.height="200px",e.inputEl.style.width="100%",e.setValue(this.plugin.settings.tagStyleList.sort(((e,t)=>e.toLowerCase()<t.toLowerCase()?-1:1)).join(", ")).onChange((e=>{const t=this.plugin.settings.tagNodeStyles,i=this.plugin.nodeStyles,s=(e=e.replaceAll("\n"," ")).split(",").map((e=>e.trim())).sort(((e,t)=>e.toLocaleLowerCase()<t.toLocaleLowerCase()?-1:1));this.plugin.settings.tagStyleList=s,Object.keys(t).forEach((e=>{s.contains(e)||(delete t[e],delete i[e])})),s.forEach((e=>{Object.keys(t).contains(e)||(t[e]={},i[e]={style:t[e],allowOverride:!0,userStyle:!0,display:e,getInheritedStyle:()=>this.plugin.settings.baseNodeStyle})}));const n=x.getValue();for(let e=x.selectEl.options.length-1;e>=0;e--)x.selectEl.remove(e);Object.entries(i).forEach((e=>{x.addOption(e[0],e[1].display)})),i[n]?x.setValue(n):(x.setValue("base"),k("base")),this.dirty=!0}))}));P.descEl.style.width="90%",P.controlEl.style.width="90%";const H=r.createDiv({cls:"setting-item"}),M=H.createDiv({cls:"setting-item-info"});let V;x=new s.DropdownComponent(M),H.createDiv({text:"Show inherited",cls:"setting-item-name"}).style.marginRight="10px";let G=!1;const W=new s.ToggleComponent(H);W.setValue(!0).setTooltip("Show/Hide Inherited Properties").onChange((e=>{G?G=!1:(e?_("excalibrain-hide-disabled"):R("excalibrain-hide-disabled",I),G=!0,V.setValue(e))})),Object.entries(this.plugin.nodeStyles).forEach((e=>{x.addOption(e[0],e[1].display)})),this.demoNodeImg=r.createEl("img",{cls:"excalibrain-settings-demoimg"}),A=r.createDiv({cls:"excalibrain-setting-style-section"}),_("excalibrain-hide-disabled"),x.setValue("base").onChange(k);const B=this.plugin.nodeStyles.base;let Y,j;this.nodeSettings(A,B.style,B.allowOverride,B.getInheritedStyle()),this.demoNodeStyle=B,this.updateNodeDemoImg();const U=e=>{j.empty();const t=this.plugin.linkStyles[e];this.linkSettings(j,t.style,t.allowOverride,t.getInheritedStyle()),this.demoLinkStyle=t,this.updateLinkDemoImg()},z=r.createDiv({cls:"setting-item"}),X=z.createDiv({cls:"setting-item-info"});Y=new s.DropdownComponent(X),z.createDiv({text:"Show inherited",cls:"setting-item-name"}).style.marginRight="10px",V=new s.ToggleComponent(z),V.setValue(!0).setTooltip("Show/Hide Inherited Properties").onChange((e=>{G?G=!1:(e?_("excalibrain-hide-disabled"):R("excalibrain-hide-disabled",I),G=!0,W.setValue(e))})),Object.entries(this.plugin.linkStyles).forEach((e=>{Y.addOption(e[0],e[1].display)})),this.demoLinkImg=r.createEl("img",{cls:"excalibrain-settings-demoimg"}),j=r.createDiv({cls:"excalibrain-setting-nodestyle-section"}),Y.setValue("base").onChange(U);const K=this.plugin.linkStyles.base;this.linkSettings(j,K.style,K.allowOverride,K.getInheritedStyle()),this.demoLinkStyle=K,this.updateLinkDemoImg(),l=()=>{p.setValue(this.getUnusedFieldNames());const e=this.plugin.settings.hierarchyLinkStyles,t=this.plugin.linkStyles;Object.keys(t).forEach((i=>{v.contains(i)||this.hierarchyStyleList.contains(i)||(delete t[i],delete e[i])})),this.hierarchyStyleList.forEach((i=>{Object.keys(e).contains(i)||v.contains(i)||(e[i]={},t[i]={style:e[i],allowOverride:!0,userStyle:!0,display:i,getInheritedStyle:()=>this.plugin.settings.baseLinkStyle})}));const i=Y.getValue();for(let e=Y.selectEl.options.length-1;e>=0;e--)Y.selectEl.remove(e);const s=this.plugin.settings.hierarchy,n=e=>v.includes(e)?"0"+e.toLowerCase():s.parents.includes(e)?"1"+e.toLowerCase():s.children.includes(e)?"2"+e.toLowerCase():"3"+e.toLowerCase();Object.entries(t).sort(((e,t)=>n(e[0])<n(t[0])?-1:1)).forEach((e=>{Y.addOption(e[0],this.plugin.settings.hierarchy.parents.includes(e[1].display)?"Parent > "+e[1].display:this.plugin.settings.hierarchy.children.includes(e[1].display)?"Child > "+e[1].display:this.plugin.settings.hierarchy.friends.includes(e[1].display)?"Friend > "+e[1].display:e[1].display)})),t[i]?Y.setValue(i):(Y.setValue("base"),U("base"))},l()}}var H={};Object.defineProperty(H,"__esModule",{value:!0});var M=H.getAPI=e=>{var t;return e?null===(t=e.plugins.plugins.dataview)||void 0===t?void 0:t.api:window.DataviewAPI};H.isPluginEnabled=e=>e.plugins.enabledPlugins.has("dataview");class V{constructor(e){this.pages=new Map,this.forEach=this.pages.forEach.bind(this.pages),this.app=e.app,this.plugin=e}add(e,t){this.pages.set(e,t)}has(e){return this.pages.has(e)}get(e){return this.pages.get(e)}getPages(){return Array.from(this.pages.values())}get size(){return this.pages.size}delete(e){const t=this.pages.get(e);t&&(t.neighbours.forEach(((t,i)=>{const s=this.pages.get(i);s&&(s.unlinkNeighbour(e),s.file||0!==s.neighbours.size||this.pages.delete(i))})),this.pages.delete(e))}addResolvedLinks(t){const s=this.app.metadataCache.resolvedLinks;Object.keys(s).forEach((n=>{if(t&&t.path!==n)return;const a=this.pages.get(n);Object.keys(s[n]).forEach((t=>{let s=this.pages.get(t);s||(s=this.pages.get(this.plugin.lowercasePathMap.get(t.toLowerCase()))),this.plugin.settings.inferAllLinksAsFriends?(s.addFriend(a,e.INFERRED,i.FROM),a.addFriend(s,e.INFERRED,i.TO)):this.plugin.settings.inverseInfer?(s.addChild(a,e.INFERRED,i.FROM),a.addParent(s,e.INFERRED,i.TO)):(s.addParent(a,e.INFERRED,i.FROM),a.addChild(s,e.INFERRED,i.TO))}))}))}addUnresolvedLinks(t){if(t&&(t.isFolder||t.isTag))return;const s=this.app.metadataCache.unresolvedLinks;Object.keys(s).forEach((n=>{if(t&&t.path!==n)return;let a=this.pages.get(n);a&&n!==this.plugin.settings.excalibrainFilepath&&Object.keys(s[n]).forEach((t=>{var s;const n=null!==(s=this.get(t))&&void 0!==s?s:new y(this,t,null,this.plugin);this.plugin.settings.inferAllLinksAsFriends?(n.addFriend(a,e.INFERRED,i.FROM),a.addFriend(n,e.INFERRED,i.TO)):this.plugin.settings.inverseInfer?(n.addChild(a,e.INFERRED,i.FROM),a.addParent(n,e.INFERRED,i.TO)):(n.addParent(a,e.INFERRED,i.FROM),a.addChild(n,e.INFERRED,i.TO)),this.add(t,n)}))}))}}const G=`---\n\nexcalidraw-plugin: parsed\nexcalidraw-default-mode: view\nexcalidraw-export-dark: false\nexcalidraw-export-transparent: false\nexcalidraw-linkbutton-opacity: 0.3\nexcalidraw-onload-script: "app.plugins.plugins[${String.fromCharCode(96)}excalibrain${String.fromCharCode(96)}].start(ea.targetView.leaf);"\n\ntags: [excalidraw]\n\n---\n\n# Text Elements\nOpen a document in another pane and click it to get started.\n\nFor the best experience enable 'Open in adjacent pane'\nin Excalidraw settings under 'Links and Transclusion'. ^4mylk7KK\n\n%%\n# Drawing\n${String.fromCharCode(96,96,96)}json\n{\n\t"type": "excalidraw",\n\t"version": 2,\n\t"source": "https://excalidraw.com",\n\t"elements": [\n\t\t{\n\t\t\t"type": "text",\n\t\t\t"version": 1,\n\t\t\t"versionNonce": 423577018,\n\t\t\t"isDeleted": false,\n\t\t\t"id": "4mylk7KK",\n\t\t\t"fillStyle": "hachure",\n\t\t\t"strokeWidth": 1,\n\t\t\t"strokeStyle": "solid",\n\t\t\t"roughness": 1,\n\t\t\t"opacity": 100,\n\t\t\t"angle": 0,\n\t\t\t"x": 0,\n\t\t\t"y": 0,\n\t\t\t"strokeColor": "white",\n\t\t\t"backgroundColor": "transparent",\n\t\t\t"width": 703,\n\t\t\t"height": 96,\n\t\t\t"seed": 4429,\n\t\t\t"groupIds": [],\n\t\t\t"strokeSharpness": "sharp",\n\t\t\t"boundElements": [],\n\t\t\t"updated": 1650784785611,\n\t\t\t"link": null,\n\t\t\t"locked": false,\n\t\t\t"fontSize": 20,\n\t\t\t"fontFamily": 3,\n\t\t\t"text": "Open a document in another pane and click it to get started.\\n\\nFor the best experience enable 'Open in adjacent pane'\\nin Excalidraw settings under 'Links and Transclusion'.",\n\t\t\t"rawText": "Open a document in another pane and click it to get started.\\n\\nFor the best experience enable 'Open in adjacent pane'\\nin Excalidraw settings under 'Links and Transclusion'.",\n\t\t\t"baseline": 91,\n\t\t\t"textAlign": "center",\n\t\t\t"verticalAlign": "top",\n\t\t\t"containerId": null,\n\t\t\t"originalText": "Open a document in another pane and click it to get started.\\n\\nFor the best experience enable 'Open in adjacent pane'\\nin Excalidraw settings under 'Links and Transclusion'."\n\t\t}\n\t],\n\t"appState": {\n\t\t"theme": "dark",\n\t\t"viewBackgroundColor": "hsl(208, 80%, 23%)",\n\t\t"currentItemStrokeColor": "#000000",\n\t\t"currentItemBackgroundColor": "transparent",\n\t\t"currentItemFillStyle": "hachure",\n\t\t"currentItemStrokeWidth": 2,\n\t\t"currentItemStrokeStyle": "solid",\n\t\t"currentItemRoughness": 1,\n\t\t"currentItemOpacity": 100,\n\t\t"currentItemFontFamily": 1,\n\t\t"currentItemFontSize": 16,\n\t\t"currentItemTextAlign": "left",\n\t\t"currentItemStrokeSharpness": "sharp",\n\t\t"currentItemStartArrowhead": null,\n\t\t"currentItemEndArrowhead": "arrow",\n\t\t"currentItemLinearStrokeSharpness": "round",\n\t\t"gridSize": null,\n\t\t"colorPalette": {}\n\t},\n\t"files": {}\n}\n${String.fromCharCode(96,96,96)}\n%%\n`;class W{constructor(e){this.nodes=[],this.renderedNodes=[],this.spec=e}layout(e=this.spec.columns){const t=this.nodes.sort(((e,t)=>e.title.toLowerCase()<t.title.toLowerCase()?-1:1)),i=t.length;if(0===i)return;const s=Math.ceil(i/e);this.renderedNodes=Array(s).fill(null).map(((n,a)=>{return a+1<s||i%e==0?Array(e).fill(null).map(((i,s)=>t[a*e+s])):(r=i%e,e%2?(t=>{const i=[];let s=0;for(s=e/2;s>t[0];s--)i.push(null);for(s=0;s<t[0];s++)i.push(s+1);for(s=0;s<e/2;s++)i.push(s<t[1]?t[0]+s+1:null);return i})(r%2?[(r+1)/2,(r-1)/2]:[r/2,r/2]):(e=>{const t=[];let i=1,s=!0;return e.map((e=>Math.floor(e))).forEach((e=>{for(let n=0;n<e;n++)t.push(s?null:i++);s=!s})),t})(r%2?[(e-r)/2,r,(e-r)/2]:[(e-r)/2,r/2,1,r/2,(e-r)/2])).map((i=>i?t[a*e+i-1]:null));var r}))}render(){this.layout();const e=this.renderedNodes.length*this.spec.rowHeight,t=null===this.spec.top&&null===this.spec.bottom?this.spec.origoY-e/2:null!==this.spec.top?this.spec.origoY-e/2<this.spec.top?this.spec.top:this.spec.origoY-e/2:this.spec.origoY+e/2>this.spec.bottom?this.spec.bottom-e:this.spec.origoY-e/2,i=this.spec.origoX-(1===this.spec.columns?0:(this.spec.columns-1)/2*this.spec.columnWidth),s=t;this.renderedNodes.forEach(((e,t)=>e.forEach(((e,n)=>{e&&(e.setCenter({x:i+n*this.spec.columnWidth,y:s+t*this.spec.rowHeight}),e.render())}))))}}class B{constructor(e){this.plugin=e,this.links=new Map,this.reverseLinks=new Set}addLink(e,s,n,a,r,o,l,h){const d=e.page.path+"|:?:|"+s.page.path;if(this.links.has(d)||this.reverseLinks.has(d))return;const g=s.page.path+"|:?:|"+e.page.path,c=new x(o===i.FROM?s:e,o===i.FROM?e:s,o===i.FROM?n===t.FRIEND?t.FRIEND:n===t.CHILD?t.PARENT:t.CHILD:n,a,r,l,h,this.plugin);this.links.set(d,c),this.reverseLinks.add(g)}render(e){this.links.forEach((t=>t.render(e.some((e=>{var i;return null===(i=t.hierarchyDefinition)||void 0===i?void 0:i.includes(e)}))||t.isInferred&&e.includes("inferred-link"))))}}class Y{constructor(e,t,i,s,n,a=!0){this.getVal=t,this.updateIndex=a,this.button=s.createEl("button",{cls:"excalibrain-button"}),this.button.createSpan({text:n.display}),this.button.ariaLabel=n.tooltip,this.setColor(),this.button.onclick=()=>{var s;i(!t()),e.saveSettings(),this.setColor(),null===(s=e.scene)||void 0===s||s.reRender(this.updateIndex)}}setColor(){if(this.getVal())return this.button.removeClass("off"),void this.button.addClass("on");this.button.removeClass("on"),this.button.addClass("off")}}var j="top",U="bottom",z="right",X="left",K=[j,U,z,X],$=K.reduce((function(e,t){return e.concat([t+"-start",t+"-end"])}),[]),q=[].concat(K,["auto"]).reduce((function(e,t){return e.concat([t,t+"-start",t+"-end"])}),[]),J=["beforeRead","read","afterRead","beforeMain","main","afterMain","beforeWrite","write","afterWrite"];function Z(e){return e?(e.nodeName||"").toLowerCase():null}function Q(e){if(null==e)return window;if("[object Window]"!==e.toString()){var t=e.ownerDocument;return t&&t.defaultView||window}return e}function ee(e){return e instanceof Q(e).Element||e instanceof Element}function te(e){return e instanceof Q(e).HTMLElement||e instanceof HTMLElement}function ie(e){return"undefined"!=typeof ShadowRoot&&(e instanceof Q(e).ShadowRoot||e instanceof ShadowRoot)}var se={name:"applyStyles",enabled:!0,phase:"write",fn:function(e){var t=e.state;Object.keys(t.elements).forEach((function(e){var i=t.styles[e]||{},s=t.attributes[e]||{},n=t.elements[e];te(n)&&Z(n)&&(Object.assign(n.style,i),Object.keys(s).forEach((function(e){var t=s[e];!1===t?n.removeAttribute(e):n.setAttribute(e,!0===t?"":t)})))}))},effect:function(e){var t=e.state,i={popper:{position:t.options.strategy,left:"0",top:"0",margin:"0"},arrow:{position:"absolute"},reference:{}};return Object.assign(t.elements.popper.style,i.popper),t.styles=i,t.elements.arrow&&Object.assign(t.elements.arrow.style,i.arrow),function(){Object.keys(t.elements).forEach((function(e){var s=t.elements[e],n=t.attributes[e]||{},a=Object.keys(t.styles.hasOwnProperty(e)?t.styles[e]:i[e]).reduce((function(e,t){return e[t]="",e}),{});te(s)&&Z(s)&&(Object.assign(s.style,a),Object.keys(n).forEach((function(e){s.removeAttribute(e)})))}))}},requires:["computeStyles"]};function ne(e){return e.split("-")[0]}var ae=Math.max,re=Math.min,oe=Math.round;function le(e,t){void 0===t&&(t=!1);var i=e.getBoundingClientRect(),s=1,n=1;if(te(e)&&t){var a=e.offsetHeight,r=e.offsetWidth;r>0&&(s=oe(i.width)/r||1),a>0&&(n=oe(i.height)/a||1)}return{width:i.width/s,height:i.height/n,top:i.top/n,right:i.right/s,bottom:i.bottom/n,left:i.left/s,x:i.left/s,y:i.top/n}}function he(e){var t=le(e),i=e.offsetWidth,s=e.offsetHeight;return Math.abs(t.width-i)<=1&&(i=t.width),Math.abs(t.height-s)<=1&&(s=t.height),{x:e.offsetLeft,y:e.offsetTop,width:i,height:s}}function de(e,t){var i=t.getRootNode&&t.getRootNode();if(e.contains(t))return!0;if(i&&ie(i)){var s=t;do{if(s&&e.isSameNode(s))return!0;s=s.parentNode||s.host}while(s)}return!1}function ge(e){return Q(e).getComputedStyle(e)}function ce(e){return["table","td","th"].indexOf(Z(e))>=0}function pe(e){return((ee(e)?e.ownerDocument:e.document)||window.document).documentElement}function ue(e){return"html"===Z(e)?e:e.assignedSlot||e.parentNode||(ie(e)?e.host:null)||pe(e)}function fe(e){return te(e)&&"fixed"!==ge(e).position?e.offsetParent:null}function ye(e){for(var t=Q(e),i=fe(e);i&&ce(i)&&"static"===ge(i).position;)i=fe(i);return i&&("html"===Z(i)||"body"===Z(i)&&"static"===ge(i).position)?t:i||function(e){var t=-1!==navigator.userAgent.toLowerCase().indexOf("firefox");if(-1!==navigator.userAgent.indexOf("Trident")&&te(e)&&"fixed"===ge(e).position)return null;var i=ue(e);for(ie(i)&&(i=i.host);te(i)&&["html","body"].indexOf(Z(i))<0;){var s=ge(i);if("none"!==s.transform||"none"!==s.perspective||"paint"===s.contain||-1!==["transform","perspective"].indexOf(s.willChange)||t&&"filter"===s.willChange||t&&s.filter&&"none"!==s.filter)return i;i=i.parentNode}return null}(e)||t}function Ee(e){return["top","bottom"].indexOf(e)>=0?"x":"y"}function me(e,t,i){return ae(e,re(t,i))}function Se(e){return Object.assign({},{top:0,right:0,bottom:0,left:0},e)}function we(e,t){return t.reduce((function(t,i){return t[i]=e,t}),{})}var ve={name:"arrow",enabled:!0,phase:"main",fn:function(e){var t,i=e.state,s=e.name,n=e.options,a=i.elements.arrow,r=i.modifiersData.popperOffsets,o=ne(i.placement),l=Ee(o),h=[X,z].indexOf(o)>=0?"height":"width";if(a&&r){var d=function(e,t){return Se("number"!=typeof(e="function"==typeof e?e(Object.assign({},t.rects,{placement:t.placement})):e)?e:we(e,K))}(n.padding,i),g=he(a),c="y"===l?j:X,p="y"===l?U:z,u=i.rects.reference[h]+i.rects.reference[l]-r[l]-i.rects.popper[h],f=r[l]-i.rects.reference[l],y=ye(a),E=y?"y"===l?y.clientHeight||0:y.clientWidth||0:0,m=u/2-f/2,S=d[c],w=E-g[h]-d[p],v=E/2-g[h]/2+m,b=me(S,v,w),T=l;i.modifiersData[s]=((t={})[T]=b,t.centerOffset=b-v,t)}},effect:function(e){var t=e.state,i=e.options.element,s=void 0===i?"[data-popper-arrow]":i;null!=s&&("string"!=typeof s||(s=t.elements.popper.querySelector(s)))&&de(t.elements.popper,s)&&(t.elements.arrow=s)},requires:["popperOffsets"],requiresIfExists:["preventOverflow"]};function be(e){return e.split("-")[1]}var Te={top:"auto",right:"auto",bottom:"auto",left:"auto"};function Le(e){var t,i=e.popper,s=e.popperRect,n=e.placement,a=e.variation,r=e.offsets,o=e.position,l=e.gpuAcceleration,h=e.adaptive,d=e.roundOffsets,g=e.isFixed,c=r.x,p=void 0===c?0:c,u=r.y,f=void 0===u?0:u,y="function"==typeof d?d({x:p,y:f}):{x:p,y:f};p=y.x,f=y.y;var E=r.hasOwnProperty("x"),m=r.hasOwnProperty("y"),S=X,w=j,v=window;if(h){var b=ye(i),T="clientHeight",L="clientWidth";b===Q(i)&&"static"!==ge(b=pe(i)).position&&"absolute"===o&&(T="scrollHeight",L="scrollWidth"),b=b,(n===j||(n===X||n===z)&&"end"===a)&&(w=U,f-=(g&&b===v&&v.visualViewport?v.visualViewport.height:b[T])-s.height,f*=l?1:-1),n!==X&&(n!==j&&n!==U||"end"!==a)||(S=z,p-=(g&&b===v&&v.visualViewport?v.visualViewport.width:b[L])-s.width,p*=l?1:-1)}var D,N=Object.assign({position:o},h&&Te),C=!0===d?function(e){var t=e.x,i=e.y,s=window.devicePixelRatio||1;return{x:oe(t*s)/s||0,y:oe(i*s)/s||0}}({x:p,y:f}):{x:p,y:f};return p=C.x,f=C.y,l?Object.assign({},N,((D={})[w]=m?"0":"",D[S]=E?"0":"",D.transform=(v.devicePixelRatio||1)<=1?"translate("+p+"px, "+f+"px)":"translate3d("+p+"px, "+f+"px, 0)",D)):Object.assign({},N,((t={})[w]=m?f+"px":"",t[S]=E?p+"px":"",t.transform="",t))}var De={passive:!0},Ne={left:"right",right:"left",bottom:"top",top:"bottom"};function Ce(e){return e.replace(/left|right|bottom|top/g,(function(e){return Ne[e]}))}var Oe={start:"end",end:"start"};function xe(e){return e.replace(/start|end/g,(function(e){return Oe[e]}))}function Ae(e){var t=Q(e);return{scrollLeft:t.pageXOffset,scrollTop:t.pageYOffset}}function Ie(e){return le(pe(e)).left+Ae(e).scrollLeft}function ke(e){var t=ge(e),i=t.overflow,s=t.overflowX,n=t.overflowY;return/auto|scroll|overlay|hidden/.test(i+n+s)}function Fe(e){return["html","body","#document"].indexOf(Z(e))>=0?e.ownerDocument.body:te(e)&&ke(e)?e:Fe(ue(e))}function _e(e,t){var i;void 0===t&&(t=[]);var s=Fe(e),n=s===(null==(i=e.ownerDocument)?void 0:i.body),a=Q(s),r=n?[a].concat(a.visualViewport||[],ke(s)?s:[]):s,o=t.concat(r);return n?o:o.concat(_e(ue(r)))}function Re(e){return Object.assign({},e,{left:e.x,top:e.y,right:e.x+e.width,bottom:e.y+e.height})}function Pe(e,t){return"viewport"===t?Re(function(e){var t=Q(e),i=pe(e),s=t.visualViewport,n=i.clientWidth,a=i.clientHeight,r=0,o=0;return s&&(n=s.width,a=s.height,/^((?!chrome|android).)*safari/i.test(navigator.userAgent)||(r=s.offsetLeft,o=s.offsetTop)),{width:n,height:a,x:r+Ie(e),y:o}}(e)):ee(t)?function(e){var t=le(e);return t.top=t.top+e.clientTop,t.left=t.left+e.clientLeft,t.bottom=t.top+e.clientHeight,t.right=t.left+e.clientWidth,t.width=e.clientWidth,t.height=e.clientHeight,t.x=t.left,t.y=t.top,t}(t):Re(function(e){var t,i=pe(e),s=Ae(e),n=null==(t=e.ownerDocument)?void 0:t.body,a=ae(i.scrollWidth,i.clientWidth,n?n.scrollWidth:0,n?n.clientWidth:0),r=ae(i.scrollHeight,i.clientHeight,n?n.scrollHeight:0,n?n.clientHeight:0),o=-s.scrollLeft+Ie(e),l=-s.scrollTop;return"rtl"===ge(n||i).direction&&(o+=ae(i.clientWidth,n?n.clientWidth:0)-a),{width:a,height:r,x:o,y:l}}(pe(e)))}function He(e){var t,i=e.reference,s=e.element,n=e.placement,a=n?ne(n):null,r=n?be(n):null,o=i.x+i.width/2-s.width/2,l=i.y+i.height/2-s.height/2;switch(a){case j:t={x:o,y:i.y-s.height};break;case U:t={x:o,y:i.y+i.height};break;case z:t={x:i.x+i.width,y:l};break;case X:t={x:i.x-s.width,y:l};break;default:t={x:i.x,y:i.y}}var h=a?Ee(a):null;if(null!=h){var d="y"===h?"height":"width";switch(r){case"start":t[h]=t[h]-(i[d]/2-s[d]/2);break;case"end":t[h]=t[h]+(i[d]/2-s[d]/2)}}return t}function Me(e,t){void 0===t&&(t={});var i=t,s=i.placement,n=void 0===s?e.placement:s,a=i.boundary,r=void 0===a?"clippingParents":a,o=i.rootBoundary,l=void 0===o?"viewport":o,h=i.elementContext,d=void 0===h?"popper":h,g=i.altBoundary,c=void 0!==g&&g,p=i.padding,u=void 0===p?0:p,f=Se("number"!=typeof u?u:we(u,K)),y="popper"===d?"reference":"popper",E=e.rects.popper,m=e.elements[c?y:d],S=function(e,t,i){var s="clippingParents"===t?function(e){var t=_e(ue(e)),i=["absolute","fixed"].indexOf(ge(e).position)>=0&&te(e)?ye(e):e;return ee(i)?t.filter((function(e){return ee(e)&&de(e,i)&&"body"!==Z(e)})):[]}(e):[].concat(t),n=[].concat(s,[i]),a=n[0],r=n.reduce((function(t,i){var s=Pe(e,i);return t.top=ae(s.top,t.top),t.right=re(s.right,t.right),t.bottom=re(s.bottom,t.bottom),t.left=ae(s.left,t.left),t}),Pe(e,a));return r.width=r.right-r.left,r.height=r.bottom-r.top,r.x=r.left,r.y=r.top,r}(ee(m)?m:m.contextElement||pe(e.elements.popper),r,l),w=le(e.elements.reference),v=He({reference:w,element:E,strategy:"absolute",placement:n}),b=Re(Object.assign({},E,v)),T="popper"===d?b:w,L={top:S.top-T.top+f.top,bottom:T.bottom-S.bottom+f.bottom,left:S.left-T.left+f.left,right:T.right-S.right+f.right},D=e.modifiersData.offset;if("popper"===d&&D){var N=D[n];Object.keys(L).forEach((function(e){var t=[z,U].indexOf(e)>=0?1:-1,i=[j,U].indexOf(e)>=0?"y":"x";L[e]+=N[i]*t}))}return L}var Ge={name:"flip",enabled:!0,phase:"main",fn:function(e){var t=e.state,i=e.options,s=e.name;if(!t.modifiersData[s]._skip){for(var n=i.mainAxis,a=void 0===n||n,r=i.altAxis,o=void 0===r||r,l=i.fallbackPlacements,h=i.padding,d=i.boundary,g=i.rootBoundary,c=i.altBoundary,p=i.flipVariations,u=void 0===p||p,f=i.allowedAutoPlacements,y=t.options.placement,E=ne(y),m=l||(E!==y&&u?function(e){if("auto"===ne(e))return[];var t=Ce(e);return[xe(e),t,xe(t)]}(y):[Ce(y)]),S=[y].concat(m).reduce((function(e,i){return e.concat("auto"===ne(i)?function(e,t){void 0===t&&(t={});var i=t,s=i.placement,n=i.boundary,a=i.rootBoundary,r=i.padding,o=i.flipVariations,l=i.allowedAutoPlacements,h=void 0===l?q:l,d=be(s),g=d?o?$:$.filter((function(e){return be(e)===d})):K,c=g.filter((function(e){return h.indexOf(e)>=0}));0===c.length&&(c=g);var p=c.reduce((function(t,i){return t[i]=Me(e,{placement:i,boundary:n,rootBoundary:a,padding:r})[ne(i)],t}),{});return Object.keys(p).sort((function(e,t){return p[e]-p[t]}))}(t,{placement:i,boundary:d,rootBoundary:g,padding:h,flipVariations:u,allowedAutoPlacements:f}):i)}),[]),w=t.rects.reference,v=t.rects.popper,b=new Map,T=!0,L=S[0],D=0;D<S.length;D++){var N=S[D],C=ne(N),O="start"===be(N),x=[j,U].indexOf(C)>=0,A=x?"width":"height",I=Me(t,{placement:N,boundary:d,rootBoundary:g,altBoundary:c,padding:h}),k=x?O?z:X:O?U:j;w[A]>v[A]&&(k=Ce(k));var F=Ce(k),_=[];if(a&&_.push(I[C]<=0),o&&_.push(I[k]<=0,I[F]<=0),_.every((function(e){return e}))){L=N,T=!1;break}b.set(N,_)}if(T)for(var R=function(e){var t=S.find((function(t){var i=b.get(t);if(i)return i.slice(0,e).every((function(e){return e}))}));if(t)return L=t,"break"},P=u?3:1;P>0&&"break"!==R(P);P--);t.placement!==L&&(t.modifiersData[s]._skip=!0,t.placement=L,t.reset=!0)}},requiresIfExists:["offset"],data:{_skip:!1}};function We(e,t,i){return void 0===i&&(i={x:0,y:0}),{top:e.top-t.height-i.y,right:e.right-t.width+i.x,bottom:e.bottom-t.height+i.y,left:e.left-t.width-i.x}}function Be(e){return[j,z,U,X].some((function(t){return e[t]>=0}))}function Ye(e,t,i){void 0===i&&(i=!1);var s,n,a=te(t),r=te(t)&&function(e){var t=e.getBoundingClientRect(),i=oe(t.width)/e.offsetWidth||1,s=oe(t.height)/e.offsetHeight||1;return 1!==i||1!==s}(t),o=pe(t),l=le(e,r),h={scrollLeft:0,scrollTop:0},d={x:0,y:0};return(a||!a&&!i)&&(("body"!==Z(t)||ke(o))&&(h=(s=t)!==Q(s)&&te(s)?{scrollLeft:(n=s).scrollLeft,scrollTop:n.scrollTop}:Ae(s)),te(t)?((d=le(t,!0)).x+=t.clientLeft,d.y+=t.clientTop):o&&(d.x=Ie(o))),{x:l.left+h.scrollLeft-d.x,y:l.top+h.scrollTop-d.y,width:l.width,height:l.height}}function je(e){var t=new Map,i=new Set,s=[];function n(e){i.add(e.name),[].concat(e.requires||[],e.requiresIfExists||[]).forEach((function(e){if(!i.has(e)){var s=t.get(e);s&&n(s)}})),s.push(e)}return e.forEach((function(e){t.set(e.name,e)})),e.forEach((function(e){i.has(e.name)||n(e)})),s}var Ue={placement:"bottom",modifiers:[],strategy:"absolute"};function ze(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return!t.some((function(e){return!(e&&"function"==typeof e.getBoundingClientRect)}))}var Ke,$e=function(e){void 0===e&&(e={});var t=e,i=t.defaultModifiers,s=void 0===i?[]:i,n=t.defaultOptions,a=void 0===n?Ue:n;return function(e,t,i){void 0===i&&(i=a);var n,r,o={placement:"bottom",orderedModifiers:[],options:Object.assign({},Ue,a),modifiersData:{},elements:{reference:e,popper:t},attributes:{},styles:{}},l=[],h=!1,d={state:o,setOptions:function(i){var n="function"==typeof i?i(o.options):i;g(),o.options=Object.assign({},a,o.options,n),o.scrollParents={reference:ee(e)?_e(e):e.contextElement?_e(e.contextElement):[],popper:_e(t)};var r,h,c=function(e){var t=je(e);return J.reduce((function(e,i){return e.concat(t.filter((function(e){return e.phase===i})))}),[])}((r=[].concat(s,o.options.modifiers),h=r.reduce((function(e,t){var i=e[t.name];return e[t.name]=i?Object.assign({},i,t,{options:Object.assign({},i.options,t.options),data:Object.assign({},i.data,t.data)}):t,e}),{}),Object.keys(h).map((function(e){return h[e]}))));return o.orderedModifiers=c.filter((function(e){return e.enabled})),o.orderedModifiers.forEach((function(e){var t=e.name,i=e.options,s=void 0===i?{}:i,n=e.effect;if("function"==typeof n){var a=n({state:o,name:t,instance:d,options:s});l.push(a||function(){})}})),d.update()},forceUpdate:function(){if(!h){var e=o.elements,t=e.reference,i=e.popper;if(ze(t,i)){o.rects={reference:Ye(t,ye(i),"fixed"===o.options.strategy),popper:he(i)},o.reset=!1,o.placement=o.options.placement,o.orderedModifiers.forEach((function(e){return o.modifiersData[e.name]=Object.assign({},e.data)}));for(var s=0;s<o.orderedModifiers.length;s++)if(!0!==o.reset){var n=o.orderedModifiers[s],a=n.fn,r=n.options,l=void 0===r?{}:r,g=n.name;"function"==typeof a&&(o=a({state:o,options:l,name:g,instance:d})||o)}else o.reset=!1,s=-1}}},update:(n=function(){return new Promise((function(e){d.forceUpdate(),e(o)}))},function(){return r||(r=new Promise((function(e){Promise.resolve().then((function(){r=void 0,e(n())}))}))),r}),destroy:function(){g(),h=!0}};if(!ze(e,t))return d;function g(){l.forEach((function(e){return e()})),l=[]}return d.setOptions(i).then((function(e){!h&&i.onFirstUpdate&&i.onFirstUpdate(e)})),d}}({defaultModifiers:[{name:"eventListeners",enabled:!0,phase:"write",fn:function(){},effect:function(e){var t=e.state,i=e.instance,s=e.options,n=s.scroll,a=void 0===n||n,r=s.resize,o=void 0===r||r,l=Q(t.elements.popper),h=[].concat(t.scrollParents.reference,t.scrollParents.popper);return a&&h.forEach((function(e){e.addEventListener("scroll",i.update,De)})),o&&l.addEventListener("resize",i.update,De),function(){a&&h.forEach((function(e){e.removeEventListener("scroll",i.update,De)})),o&&l.removeEventListener("resize",i.update,De)}},data:{}},{name:"popperOffsets",enabled:!0,phase:"read",fn:function(e){var t=e.state,i=e.name;t.modifiersData[i]=He({reference:t.rects.reference,element:t.rects.popper,strategy:"absolute",placement:t.placement})},data:{}},{name:"computeStyles",enabled:!0,phase:"beforeWrite",fn:function(e){var t=e.state,i=e.options,s=i.gpuAcceleration,n=void 0===s||s,a=i.adaptive,r=void 0===a||a,o=i.roundOffsets,l=void 0===o||o,h={placement:ne(t.placement),variation:be(t.placement),popper:t.elements.popper,popperRect:t.rects.popper,gpuAcceleration:n,isFixed:"fixed"===t.options.strategy};null!=t.modifiersData.popperOffsets&&(t.styles.popper=Object.assign({},t.styles.popper,Le(Object.assign({},h,{offsets:t.modifiersData.popperOffsets,position:t.options.strategy,adaptive:r,roundOffsets:l})))),null!=t.modifiersData.arrow&&(t.styles.arrow=Object.assign({},t.styles.arrow,Le(Object.assign({},h,{offsets:t.modifiersData.arrow,position:"absolute",adaptive:!1,roundOffsets:l})))),t.attributes.popper=Object.assign({},t.attributes.popper,{"data-popper-placement":t.placement})},data:{}},se,{name:"offset",enabled:!0,phase:"main",requires:["popperOffsets"],fn:function(e){var t=e.state,i=e.options,s=e.name,n=i.offset,a=void 0===n?[0,0]:n,r=q.reduce((function(e,i){return e[i]=function(e,t,i){var s=ne(e),n=[X,j].indexOf(s)>=0?-1:1,a="function"==typeof i?i(Object.assign({},t,{placement:e})):i,r=a[0],o=a[1];return r=r||0,o=(o||0)*n,[X,z].indexOf(s)>=0?{x:o,y:r}:{x:r,y:o}}(i,t.rects,a),e}),{}),o=r[t.placement],l=o.x,h=o.y;null!=t.modifiersData.popperOffsets&&(t.modifiersData.popperOffsets.x+=l,t.modifiersData.popperOffsets.y+=h),t.modifiersData[s]=r}},Ge,{name:"preventOverflow",enabled:!0,phase:"main",fn:function(e){var t=e.state,i=e.options,s=e.name,n=i.mainAxis,a=void 0===n||n,r=i.altAxis,o=void 0!==r&&r,l=i.boundary,h=i.rootBoundary,d=i.altBoundary,g=i.padding,c=i.tether,p=void 0===c||c,u=i.tetherOffset,f=void 0===u?0:u,y=Me(t,{boundary:l,rootBoundary:h,padding:g,altBoundary:d}),E=ne(t.placement),m=be(t.placement),S=!m,w=Ee(E),v="x"===w?"y":"x",b=t.modifiersData.popperOffsets,T=t.rects.reference,L=t.rects.popper,D="function"==typeof f?f(Object.assign({},t.rects,{placement:t.placement})):f,N="number"==typeof D?{mainAxis:D,altAxis:D}:Object.assign({mainAxis:0,altAxis:0},D),C=t.modifiersData.offset?t.modifiersData.offset[t.placement]:null,O={x:0,y:0};if(b){if(a){var x,A="y"===w?j:X,I="y"===w?U:z,k="y"===w?"height":"width",F=b[w],_=F+y[A],R=F-y[I],P=p?-L[k]/2:0,H="start"===m?T[k]:L[k],M="start"===m?-L[k]:-T[k],V=t.elements.arrow,G=p&&V?he(V):{width:0,height:0},W=t.modifiersData["arrow#persistent"]?t.modifiersData["arrow#persistent"].padding:{top:0,right:0,bottom:0,left:0},B=W[A],Y=W[I],K=me(0,T[k],G[k]),$=S?T[k]/2-P-K-B-N.mainAxis:H-K-B-N.mainAxis,q=S?-T[k]/2+P+K+Y+N.mainAxis:M+K+Y+N.mainAxis,J=t.elements.arrow&&ye(t.elements.arrow),Z=J?"y"===w?J.clientTop||0:J.clientLeft||0:0,Q=null!=(x=null==C?void 0:C[w])?x:0,ee=F+q-Q,te=me(p?re(_,F+$-Q-Z):_,F,p?ae(R,ee):R);b[w]=te,O[w]=te-F}if(o){var ie,se="x"===w?j:X,oe="x"===w?U:z,le=b[v],de="y"===v?"height":"width",ge=le+y[se],ce=le-y[oe],pe=-1!==[j,X].indexOf(E),ue=null!=(ie=null==C?void 0:C[v])?ie:0,fe=pe?ge:le-T[de]-L[de]-ue+N.altAxis,Se=pe?le+T[de]+L[de]-ue-N.altAxis:ce,we=p&&pe?function(e,t,i){var s=me(e,t,i);return s>i?i:s}(fe,le,Se):me(p?fe:ge,le,p?Se:ce);b[v]=we,O[v]=we-le}t.modifiersData[s]=O}},requiresIfExists:["offset"]},ve,{name:"hide",enabled:!0,phase:"main",requiresIfExists:["preventOverflow"],fn:function(e){var t=e.state,i=e.name,s=t.rects.reference,n=t.rects.popper,a=t.modifiersData.preventOverflow,r=Me(t,{elementContext:"reference"}),o=Me(t,{altBoundary:!0}),l=We(r,s),h=We(o,n,a),d=Be(l),g=Be(h);t.modifiersData[i]={referenceClippingOffsets:l,popperEscapeOffsets:h,isReferenceHidden:d,hasPopperEscaped:g},t.attributes.popper=Object.assign({},t.attributes.popper,{"data-popper-reference-hidden":d,"data-popper-escaped":g})}}]});class qe{constructor(e,t,i,s=30){this.owner=e,this.containerEl=t,this.limit=s,this.owner=e,this.containerEl=t,t.on("click",".suggestion-item",this.onSuggestionClick.bind(this)),t.on("mousemove",".suggestion-item",this.onSuggestionMouseover.bind(this)),i.register([],"ArrowUp",(e=>{if(!e.isComposing)return this.setSelectedItem(this.selectedItem-1,!0),!1})),i.register([],"ArrowDown",(e=>{if(!e.isComposing)return this.setSelectedItem(this.selectedItem+1,!0),!1})),i.register([],"Enter",(e=>{if(!e.isComposing)return this.useSelectedItem(e),!1}))}onSuggestionClick(e,t){e.preventDefault();const i=this.suggestions.indexOf(t);this.setSelectedItem(i,!1),this.useSelectedItem(e)}onSuggestionMouseover(e,t){const i=this.suggestions.indexOf(t);this.setSelectedItem(i,!1)}setSuggestions(e){this.containerEl.empty();const t=[];e.slice(0,this.limit).forEach((e=>{const i=this.containerEl.createDiv("suggestion-item");this.owner.renderSuggestion(e,i),t.push(i)})),this.values=e,this.suggestions=t,this.setSelectedItem(0,!1)}useSelectedItem(e){const t=this.values[this.selectedItem];t&&this.owner.selectSuggestion(t,e)}setSelectedItem(e,t){const i=(e%(s=this.suggestions.length)+s)%s;var s;const n=this.suggestions[this.selectedItem],a=this.suggestions[i];null==n||n.removeClass("is-selected"),null==a||a.addClass("is-selected"),this.selectedItem=i,t&&a.scrollIntoView(!1)}}!function(e){e[e.TemplateFiles=0]="TemplateFiles",e[e.ScriptFiles=1]="ScriptFiles"}(Ke||(Ke={}));class Je extends class{constructor(e,t,i){this.app=e,this.inputEl=t,this.containerEl=i,this.scope=new s.Scope,this.suggestEl=i.createDiv("suggestion-container");const n=this.suggestEl.createDiv("suggestion");this.suggest=new qe(this,n,this.scope),this.scope.register([],"Escape",this.close.bind(this)),this.inputEl.addEventListener("input",this.onInputChanged.bind(this)),this.inputEl.addEventListener("focus",this.onInputChanged.bind(this)),this.inputEl.addEventListener("blur",this.close.bind(this)),this.suggestEl.on("mousedown",".suggestion-container",(e=>{e.preventDefault()}))}onInputChanged(){const e=this.inputEl.value,t=this.getSuggestions(e);t&&t.length>0?(this.suggest.setSuggestions(t),this.open(this.containerEl,this.inputEl)):this.close()}open(e,t){this.app.keymap.pushScope(this.scope),e.appendChild(this.suggestEl),this.popper=$e(t,this.suggestEl,{placement:"bottom-start",modifiers:[{name:"sameWidth",enabled:!0,fn:({state:e,instance:t})=>{const i=`${e.rects.reference.width}px`;e.styles.popper.width!==i&&(e.styles.popper.width=i,t.update())},phase:"beforeWrite",requires:["computeStyles"]}]})}close(){this.app.keymap.popScope(this.scope),this.suggest.setSuggestions([]),this.popper&&this.popper.destroy(),this.suggestEl.detach()}}{constructor(e,t,i,s){super(e,t,s),this.plugin=i}getSuggestions(e){var t,i,n;if(""===e)return this.plugin.starred;const a=e.toLowerCase(),r=null===(t=this.plugin.pages)||void 0===t?void 0:t.getPages().filter((e=>(!e.file||(this.plugin.settings.showAttachments||"md"===e.file.extension)&&!this.plugin.settings.excludeFilepaths.some((t=>e.path.startsWith(t))))&&(e.file||(this.plugin.settings.showFolderNodes||!e.path.startsWith("folder:"))&&(this.plugin.settings.showTagNodes||!e.path.startsWith("tag:")))&&e.name.toLowerCase().contains(a)));if(r.length>30)return r;const o=r.concat(null===(i=this.plugin.pages)||void 0===i?void 0:i.getPages().filter((e=>!r.contains(e)&&(!e.file||(this.plugin.settings.showAttachments||"md"===e.file.extension)&&!this.plugin.settings.excludeFilepaths.some((t=>e.path.startsWith(t))))&&(e.file||(this.plugin.settings.showFolderNodes||!e.path.startsWith("folder:"))&&(this.plugin.settings.showTagNodes||!e.path.startsWith("tag:")))&&e.path.toLowerCase().contains(a))));if(o.length>30)return o;const l=s.prepareFuzzySearch(e);return o.concat(null===(n=this.plugin.pages)||void 0===n?void 0:n.getPages().filter((e=>!e.isVirtual&&(!e.file||(this.plugin.settings.showAttachments||"md"===e.file.extension)&&!this.plugin.settings.excludeFilepaths.some((t=>e.path.startsWith(t))))&&(e.file||(this.plugin.settings.showFolderNodes||!e.path.startsWith("folder:"))&&(this.plugin.settings.showTagNodes||!e.path.startsWith("tag:")))&&!o.contains(e)&&l(e.path))))}renderSuggestion(e,t){t.ariaLabel=e.path,t.setText(e.isFolder||e.isTag?e.path:e.name)}selectSuggestion(e){this.inputEl.value=e.path,this.inputEl.trigger("input"),this.close()}}class Ze{constructor(e,t,i,s){this.label="",this.selected=!1,this.value=e,this.label=t,this.multiple=i,this.onChange=s,this.createOptionElement(),this.createListeners()}select(e=!0){this.selected=!0,this.setAttribute(),e&&this.onChange(this)}deselect(e=!0){this.selected=!1,this.setAttribute(),e&&this.onChange(this)}createOptionElement(){const e=document.createElement("div");e.classList.add("option"),this.singleSelectTextSpanRef=document.createElement("span"),this.singleSelectTextSpanRef.classList.add("option-text"),this.singleSelectTextSpanRef.innerText=this.label,e.appendChild(this.singleSelectTextSpanRef),e.appendChild(this.createCheckbox()),this.optionRef=e}createCheckbox(){const e=document.createElement("label");e.classList.add("checkbox-wrapper");const t=document.createElement("span");t.classList.add("checkbox-text"),t.innerText=this.label;const i=document.createElement("input");i.setAttribute("type","checkbox"),this.checkboxRef=i;const s=document.createElement("span");return s.classList.add("checkbox-checkmark"),e.appendChild(t),e.appendChild(i),e.appendChild(s),e}setAttribute(){this.multiple?this.selected?this.checkboxRef.setAttribute("checked","checked"):this.checkboxRef.removeAttribute("checked"):this.selected?this.singleSelectTextSpanRef.classList.add("selected"):this.singleSelectTextSpanRef.classList.remove("selected")}createListeners(){this.multiple?this.checkboxRef.addEventListener("change",(()=>{this.selected=this.checkboxRef.checked,this.onChange(this)})):this.singleSelectTextSpanRef.addEventListener("click",(()=>{this.selected=!0,this.onChange(this)}))}}class Qe{constructor(e){if(this.options=[],this.dropdownOpened=!1,this.destroyed=!1,this.rendered=!1,this.documentClickDropdownToggle=e=>{this.selectWrapperRef.contains(e.target)||this.handleDropdownToggle(!1,this.dropdownOpened)},this.config=e,this.assignConfig(),this.setOrigin(),!this.origin)throw"You have to pass origin element!";this.init()}init(){this.destroyed=!1,this.dropdownOpened=!1,this.createSelect(),this.createListeners()}destroy(){this.destroyed=!0,this.rendered=!1,this.hide(),document.removeEventListener("click",this.documentClickDropdownToggle),this.selectWrapperRef.cloneNode(!0),this.origin=null,this.selectHeaderRef=null,this.selectWrapperRef=null,this.selectedValueRef=null,this.optionsWrapperRef=null,this.options=[]}reset(){this.options.forEach((e=>e.deselect(!1))),this.updateSelection()}hide(){this.origin.innerHTML="",this.rendered=!1}render(){if(this.destroyed)throw"But you destroyed me... :(";if(this.origin.innerText.trim())throw"Hey! I am rendered already!";this.origin.appendChild(this.selectWrapperRef),this.rendered=!0,this.selectHeaderRef&&this.origin.prepend(this.selectHeaderRef)}assignConfig(){var e,t;this.origin=this.config.origin,this.configOptions=this.config.options,this.multiple=null===(e=this.config.multiple)||void 0===e||e,this.singularNominativeLabel=this.config.singularNominativeLabel,this.pluralNominativeLabel=this.config.pluralNominativeLabel,this.pluralGenitiveLabel=this.config.pluralGenitiveLabel,this.placeholder=null!==(t=this.config.placeholder)&&void 0!==t?t:"",this.headerLabel=this.config.headerLabel,this.selected=this.config.selected,this.onDropdownOpen=this.config.onDropdownOpen,this.onDropdownClose=this.config.onDropdownClose,this.onSelectionChange=this.config.onSelectionChange}setOrigin(){this.origin&&this.origin.classList.add("multiselect-container")}createHeader(){this.headerLabel&&(this.selectHeaderRef=document.createElement("div"),this.selectHeaderRef.classList.add("multiselect-header"),this.selectHeaderRef.innerText=this.headerLabel)}createSelect(){this.selectWrapperRef=document.createElement("div"),this.selectWrapperRef.classList.add("multiselect-wrapper"),this.multiple||this.selectWrapperRef.classList.add("single-select"),this.selectedValueRef=document.createElement("div"),this.selectedValueRef.classList.add("selected-value"),this.selectWrapperRef.appendChild(this.selectedValueRef),this.optionsWrapperRef=document.createElement("div"),this.optionsWrapperRef.classList.add("options-wrapper"),this.configOptions.forEach((e=>{var t;const i=new Ze(e.value,e.label,this.multiple,this.onSelectChange.bind(this));(null===(t=this.selected)||void 0===t?void 0:t.includes(e.value))&&i.select(!1),this.options.push(i),this.optionsWrapperRef.appendChild(i.optionRef)})),this.updateSelection(),this.selectWrapperRef.appendChild(this.optionsWrapperRef),this.createHeader(),this.render()}createListeners(){this.selectWrapperRef.addEventListener("click",(e=>{this.selectWrapperRef.contains(e.target)&&!this.optionsWrapperRef.contains(e.target)&&this.handleDropdownToggle(!this.dropdownOpened)})),document.addEventListener("click",this.documentClickDropdownToggle)}handleDropdownToggle(e,t=!0){this.dropdownOpened=e,this.dropdownOpened?(this.selectWrapperRef.classList.add("opened"),this.onDropdownOpen&&t&&this.onDropdownOpen()):(this.selectWrapperRef.classList.remove("opened"),this.onDropdownClose&&t&&this.onDropdownClose(this.selected))}onSelectChange(e){this.multiple||(this.options.forEach((e=>e.deselect(!1))),e.select(!1)),this.updateSelection(),this.onSelectionChange&&this.onSelectionChange(this.selected),this.multiple||this.handleDropdownToggle(!1)}updateSelection(){this.selected=this.options.filter((e=>!!e.selected)).map((e=>e.value));const e=this.options.filter((e=>!!e.selected)).map((e=>e.label));let t=this.placeholder;1===e.length?t=e[0]:e.length>1&&(t=`${e.length} ${this.transformPluralLabel(e.length)}`),this.selectedValueRef.innerText=t}transformPluralLabel(e){var t,i,s;return 1===e?null!==(t=this.singularNominativeLabel)&&void 0!==t?t:"items":e%10>=2&&e%10<=4&&(e%100<10||e%100>=20)?null!==(i=this.pluralNominativeLabel)&&void 0!==i?i:"items":null!==(s=this.pluralGenitiveLabel)&&void 0!==s?s:"items"}}class et{constructor(e,t){this.plugin=e,this.selectedLinks=new Set,this.selectedTags=new Set,this.isOpen=!1,this.filterDiv=t.createDiv({attr:{id:"filter"}})}render(){if(this.isOpen)return;if(this.filterDiv.empty(),!this.plugin.scene)return;const e=Array.from(this.selectedTags);this.selectedLinks.forEach((t=>e.push("link::"+t)));const t=[],i=new Set(this.selectedLinks.keys());this.plugin.scene.links.links.forEach((e=>{var t;null===(t=e.hierarchyDefinition)||void 0===t||t.split(",").map((e=>e.trim())).forEach((e=>i.add(e))),e.hierarchyDefinition||(e.isInferred?i.add("inferred-link"):i.add("normal-link"))})),i.forEach((e=>t.push({label:e,value:"link::"+e})));const s=new Set(this.selectedTags.keys());this.plugin.scene.nodesMap.forEach((e=>{e.page.primaryStyleTag&&s.add(e.page.primaryStyleTag)})),s.forEach((e=>t.push({label:e,value:e})));const n=new Qe({origin:this.filterDiv,placeholder:"filter links and tags",options:t.sort(((e,t)=>e.label>t.label?1:-1)),selected:e,onDropdownOpen:()=>{this.isOpen=!0,this.selectedItems=n.selected},onSelectionChange:e=>{var t;this.selectedLinks.clear(),this.selectedTags.clear(),e.forEach((e=>{e.startsWith("link::")?this.selectedLinks.add(e.substring(6)):this.selectedTags.add(e)})),null===(t=this.plugin.scene)||void 0===t||t.reRender(!1)},onDropdownClose:e=>{var t;this.isOpen=!1,e!==this.selectedItems&&(null===(t=this.plugin.scene)||void 0===t||t.reRender(!1))}})}}class tt{constructor(e,t){this.contentEl=e,this.plugin=t,this.buttons=[],e.addClass("excalibrain-contentEl"),this.wrapperDiv=this.contentEl.createDiv({cls:"excalibrain-toolspanel-wrapper"});const i=this.wrapperDiv.createDiv({cls:"excalibrain-dropdown-wrapper"}),s=i.createEl("input",{type:"text",cls:"excalibrain-searchinput"});s.ariaLabel=N("SEARCH_IN_VAULT"),s.oninput=()=>{var e;const t=this.plugin.pages.get(s.value);t&&(null===(e=this.plugin.scene)||void 0===e||e.renderGraphForPath(t.path))},s.onblur=()=>{s.value=""},new Je(this.plugin.app,s,this.plugin,e),this.searchElement=s,this.linkTagFilter=new et(t,i),this.linkTagFilter.render();const n=this.wrapperDiv.createDiv({cls:"excalibrain-buttons"}),a=n.createEl("button",{cls:"excalibrain-button",text:"✏"});a.ariaLabel=N("OPEN_DRAWING"),a.onclick=()=>{const e=this.plugin.EA.getExcalidrawAPI().getSceneElements(),t=this.plugin.EA.getExcalidrawAPI().getAppState(),i=this.plugin.EA;i.reset(),i.canvas.viewBackgroundColor=t.viewBackgroundColor,i.canvas.theme="light",e.forEach((e=>i.elementsDict[e.id]=e)),i.create({filename:`ExcaliBrain Snapshot - ${g(this.plugin.scene.centralPagePath).basename}`,onNewPane:!0})},this.buttons.push(new Y(this.plugin,(()=>this.plugin.settings.showAttachments),(e=>this.plugin.settings.showAttachments=e),n,{display:"📎",tooltip:N("SHOW_HIDE_ATTACHMENTS")})),this.buttons.push(new Y(this.plugin,(()=>this.plugin.settings.showVirtualNodes),(e=>this.plugin.settings.showVirtualNodes=e),n,{display:"∅",tooltip:N("SHOW_HIDE_VIRTUAL")},!1)),this.buttons.push(new Y(this.plugin,(()=>this.plugin.settings.showInferredNodes),(e=>this.plugin.settings.showInferredNodes=e),n,{display:"🤔",tooltip:N("SHOW_HIDE_INFERRED")})),this.buttons.push(new Y(this.plugin,(()=>this.plugin.settings.showPageNodes),(e=>this.plugin.settings.showPageNodes=e),n,{display:"📄",tooltip:N("SHOW_HIDE_PAGES")})),this.buttons.push(new Y(this.plugin,(()=>this.plugin.settings.showFolderNodes),(e=>this.plugin.settings.showFolderNodes=e),n,{display:"📂",tooltip:N("SHOW_HIDE_FOLDER")},!0)),this.buttons.push(new Y(this.plugin,(()=>this.plugin.settings.showTagNodes),(e=>this.plugin.settings.showTagNodes=e),n,{display:"#",tooltip:N("SHOW_HIDE_TAG")},!1)),this.buttons.push(new Y(this.plugin,(()=>this.plugin.settings.renderAlias),(e=>this.plugin.settings.renderAlias=e),n,{display:"🧥",tooltip:N("SHOW_HIDE_ALIAS")},!1)),this.buttons.push(new Y(this.plugin,(()=>this.plugin.scene.pinLeaf),(e=>this.plugin.scene.pinLeaf=e),n,{display:"📌",tooltip:N("PIN_LEAF")},!1)),this.buttons.push(new Y(this.plugin,(()=>this.plugin.settings.renderSiblings),(e=>this.plugin.settings.renderSiblings=e),n,{display:"👨‍👩‍👧‍👦",tooltip:N("SHOW_HIDE_SIBLINGS")},!1)),this.contentEl.appendChild(this.wrapperDiv)}rerender(){this.buttons.forEach((e=>e.setColor())),this.linkTagFilter.render()}terminate(){var e;if(this.contentEl&&this.contentEl.removeClass("excalibrain-contentEl"),this.wrapperDiv){try{null===(e=this.contentEl)||void 0===e||e.removeChild(this.wrapperDiv)}catch(e){}this.wrapperDiv=null}}}class it{constructor(e,t){this.contentEl=e,this.plugin=t,this.wrapperDiv=this.contentEl.createDiv({cls:"excalibrain-history-wrapper"}),this.rerender(),this.contentEl.appendChild(this.wrapperDiv)}rerender(){this.wrapperDiv.empty();const e=this.wrapperDiv.createDiv({cls:"excalibrain-history-container"}),t=this.plugin.settings.navigationHistory;for(let i=t.length-1;i>=0;i--){i!==t.length-1&&e.createDiv({text:"•",cls:"excalibrain-history-divider"});let s="",n="";const a=this.plugin.pages.get(t[i]);if(!a)return;const r=a.path.startsWith("folder:")?this.plugin.settings.folderNodeStyle:a.path.startsWith("tag:")?this.plugin.settings.tagNodeStyle:Object.assign(Object.assign({},this.plugin.settings.baseNodeStyle),l(o(a.dvPage,this.plugin.settings),this.plugin.settings));a.file?(s=r.prefix+a.getTitle(),n=a.path):(s=r.prefix+a.name,n=a.path),e.createDiv({text:s,cls:"excalibrain-history-item"},(e=>{e.onclick=()=>{var e;return null===(e=this.plugin.scene)||void 0===e?void 0:e.renderGraphForPath(n)}}))}}terminate(){var e;if(this.wrapperDiv){try{null===(e=this.contentEl)||void 0===e||e.removeChild(this.wrapperDiv)}catch(e){}this.wrapperDiv=null}}}class st{constructor(e,t,i){this.disregardLeafChange=!1,this.nodesMap=new Map,this.layouts=[],this.blockUpdateTimer=!1,this.vaultFileChanged=!1,this.pinLeaf=!1,this.focusSearchAfterInitiation=!0,this.zoomToFitOnNextBrainLeafActivate=!1,this.ea=e.EA,this.plugin=e,this.app=e.app,this.leaf=null!=i?i:app.workspace.getLeaf(t),this.terminated=!1,this.links=new B(e)}async initialize(e){var t;this.focusSearchAfterInitiation=e,await this.plugin.loadSettings(),(null===(t=this.leaf)||void 0===t?void 0:t.view)&&(this.toolsPanel=new tt(this.leaf.view.contentEl,this.plugin),this.initializeScene())}isActive(){var e;return!this.terminated&&app.workspace.getLeafById(null===(e=this.leaf)||void 0===e?void 0:e.id)}async reRender(e=!0){this.isActive()&&this.centralLeaf&&this.centralPagePath&&(e&&(this.vaultFileChanged=!1,await this.plugin.createIndex()),await this.render())}async renderGraphForPath(e,t=!0){var i;if(!this.isActive())return;this.blockUpdateTimer=!0;const s=this.plugin.pages.get(e);if(!s)return void(this.blockUpdateTimer=!1);const n=!(s.isFolder||s.isTag||s.isVirtual);if(n&&!s.file)return void(this.blockUpdateTimer=!1);if(!(null===(i=this.ea.targetView)||void 0===i?void 0:i.file)||this.ea.targetView.file.path!==this.plugin.settings.excalibrainFilepath)return void this.unloadScene();if(n&&s.file.path===this.ea.targetView.file.path)return void(this.blockUpdateTimer=!1);const a=this.plugin.pages.get(this.centralPagePath);a&&a.path===e&&n&&s.file.stat.mtime===a.mtime?this.blockUpdateTimer=!1:(n&&t?(this.centralLeaf&&app.workspace.getLeafById(this.centralLeaf.id)?this.centralLeaf.openFile(s.file,{active:!1}):this.centralLeaf=this.ea.openFileInNewOrAdjacentLeaf(s.file),this.addToHistory(s.file.path)):this.addToHistory(s.path),s.isFolder&&!this.plugin.settings.showFolderNodes&&(this.plugin.settings.showFolderNodes=!0,this.toolsPanel.rerender()),s.isTag&&!this.plugin.settings.showTagNodes&&(this.plugin.settings.showTagNodes=!0,this.toolsPanel.rerender()),this.centralPagePath=e,await this.render())}async addToHistory(e){const t=this.plugin.settings.navigationHistory;if(t.last()===e)return;const i=t.indexOf(e);i>-1&&t.splice(i,1),t.length>50&&t.shift(),t.push(e)}static async openExcalidrawLeaf(e,t,i){let n=0,a=app.vault.getAbstractFileByPath(t.excalibrainFilepath);if(!a||a instanceof s.TFile){if(!a)for(a=await app.vault.create(t.excalibrainFilepath,G);a instanceof s.TFile&&!e.isExcalidrawFile(a)&&n++<10;)await sleep(50);n=0,a&&a instanceof s.TFile&&!e.isExcalidrawFile(a)?new C(app,"⚠ File Exists",`${a.path} already exists in your Vault. Is it ok to overwrite this file? If not, change ExcaliBrain file path in plugin settings.`).show((async r=>{if(r){for(await app.vault.modify(a,G);a instanceof s.TFile&&!e.isExcalidrawFile(a)&&n++<10;)await sleep(50);st.openExcalidrawLeaf(e,t,i)}else new s.Notice("Could not start ExcaliBrain. Please change the ExcaliBrain file path in plugin settings.")})):await(null!=i?i:app.workspace.getLeaf(!0)).openFile(a)}else new s.Notice(`Please check settings. ExcaliBrain path (${t.excalibrainFilepath}) points to a folder, not a file`)}async initializeScene(){this.disregardLeafChange=!1;const e=this.ea,t=this.plugin.settings.baseNodeStyle;let i=0;for(e.clear(),e.setView(this.leaf.view);!e.targetView.excalidrawAPI&&i++<10;)await sleep(50);if(!e.targetView.excalidrawAPI)return void new s.Notice("Error initializing Excalidraw view");const n=e.getExcalidrawAPI();this.ea.registerThisAsViewEA(),this.ea.targetView.semaphores.saving=!0,n.setMobileModeAllowed(!1),e.style.fontFamily=t.fontFamily,e.style.fontSize=t.fontSize,this.textSize=e.measureText("m".repeat(t.maxLabelLength+3)),this.nodeWidth=this.textSize.width+3*t.padding,this.nodeHeight=2*(this.textSize.height+2*t.padding),(()=>{n.updateScene({appState:{viewModeEnabled:!0,activeTool:{lastActiveToolBeforeEraser:null,locked:!1,type:"selection"},theme:"light",viewBackgroundColor:this.plugin.settings.backgroundColor},elements:[]})})(),e.style.strokeColor=t.textColor,e.addText(0,0,"🚀 To get started\nselect a document using the search in the top left or\nopen a document in another pane.\n\n✨ For the best experience enable 'Open in adjacent pane'\nin Excalidraw settings under 'Links and Transclusion'.\n\n⚠ ExcaliBrain may need to wait for DataView to initialize its index.\nThis can take up to a few minutes after starting Obsidian.",{textAlign:"center"}),e.addElementsToView(),(()=>{this.plugin.settings.allowAutozoom&&n.zoomToFit(null,5,.15),e.targetView.linksAlwaysOpenInANewPane=!0,this.addEventHandler(),this.historyPanel=new it(this.leaf.view.contentEl,this.plugin),new s.Notice("ExcaliBrain On")})()}addNodes(t){t.neighbours.forEach((i=>{if(i.page.path===this.ea.targetView.file.path)return;const s=new O({ea:this.ea,page:i.page,isInferred:i.relationType===e.INFERRED,isCentral:t.isCentral,isSibling:t.isSibling,friendGateOnLeft:t.friendGateOnLeft});this.nodesMap.set(i.page.path,s),t.layout.nodes.push(s)}))}async render(){var e,i;if(this.historyPanel&&this.historyPanel.rerender(),!this.centralPagePath)return;let s=this.plugin.pages.get(this.centralPagePath);if(!s&&(this.centralPagePath=this.plugin.lowercasePathMap.get(this.centralPagePath.toLowerCase()),s=this.plugin.pages.get(this.centralPagePath),!s))return;const n=this.ea;this.zoomToFitOnNextBrainLeafActivate=!n.targetView.containerEl.isShown(),n.clear(),n.getExcalidrawAPI().updateScene({elements:[]}),n.style.verticalAlign="middle";const a=s.getParents().filter((e=>!(e.page.path===s.path||this.plugin.settings.excludeFilepaths.some((t=>e.page.path.startsWith(t)))||e.page.primaryStyleTag&&this.toolsPanel.linkTagFilter.selectedTags.has(e.page.primaryStyleTag)))).slice(0,this.plugin.settings.maxItemCount),r=a.map((e=>e.page.path)),o=s.getChildren().filter((e=>!(e.page.path===s.path||this.plugin.settings.excludeFilepaths.some((t=>e.page.path.startsWith(t)))||e.page.primaryStyleTag&&this.toolsPanel.linkTagFilter.selectedTags.has(e.page.primaryStyleTag)))).slice(0,this.plugin.settings.maxItemCount),l=s.getFriends().filter((e=>!(e.page.path===s.path||this.plugin.settings.excludeFilepaths.some((t=>e.page.path.startsWith(t)))||e.page.primaryStyleTag&&this.toolsPanel.linkTagFilter.selectedTags.has(e.page.primaryStyleTag)))).slice(0,this.plugin.settings.maxItemCount),h=s.getSiblings().filter((e=>!(a.some((t=>t.page.path===e.page.path))||o.some((t=>t.page.path===e.page.path))||l.some((t=>t.page.path===e.page.path))||this.plugin.settings.excludeFilepaths.some((t=>e.page.path.startsWith(t))))&&e.page.path!==s.path)).filter((e=>e.page.getParents().map((e=>e.page.path)).some((e=>r.includes(e)))&&(!e.page.primaryStyleTag||!this.toolsPanel.linkTagFilter.selectedTags.has(e.page.primaryStyleTag)))).slice(0,this.plugin.settings.maxItemCount);this.nodesMap=new Map,this.links=new B(this.plugin),this.layouts=[];const d=l.length>=10,g=this.plugin.settings.baseNodeStyle,c=h.length>=20?3:h.length>=10?2:1,p=o.length<=12?[1,1,2,3,3,3,3,4,4,5,5,4,4][o.length]:5,u=a.length<5?[1,1,2,3,2][a.length]:3,f=new W({origoX:0,origoY:0,top:null,bottom:null,columns:1,columnWidth:this.nodeWidth,rowHeight:this.nodeHeight});this.layouts.push(f);const y=new W({origoX:0,origoY:2.5*this.nodeHeight,top:2*this.nodeHeight,bottom:null,columns:p,columnWidth:this.nodeWidth,rowHeight:this.nodeHeight});this.layouts.push(y);const E=new W({origoX:-((d?1:0)+Math.max(p,u)+1.9)/2.4*this.nodeWidth,origoY:0,top:null,bottom:null,columns:1,columnWidth:this.nodeWidth,rowHeight:this.nodeHeight});this.layouts.push(E);const m=new W({origoX:0,origoY:-2.5*this.nodeHeight,top:null,bottom:-2*this.nodeHeight,columns:u,columnWidth:this.nodeWidth,rowHeight:this.nodeHeight});this.layouts.push(m);const S=this.plugin.settings.siblingNodeStyle,w=null!==(e=S.padding)&&void 0!==e?e:g.padding,v=null!==(i=S.maxLabelLength)&&void 0!==i?i:g.maxLabelLength;n.style.fontFamily=S.fontFamily,n.style.fontSize=S.fontSize;const b=n.measureText("m".repeat(v+3)),T=b.width+3*w,L=2*(b.height+2*w),D=new W({origoX:this.nodeWidth*((u-1)/2+(c+1.5)/3),origoY:-2.5*this.nodeHeight,top:null,bottom:-this.nodeHeight/2,columns:c,columnWidth:T,rowHeight:L});this.layouts.push(D);const N=new O({ea:n,page:s,isInferred:!1,isCentral:!0,isSibling:!1,friendGateOnLeft:!0});this.nodesMap.set(s.path,N),f.nodes.push(N),this.addNodes({neighbours:a,layout:m,isCentral:!1,isSibling:!1,friendGateOnLeft:!0}),this.addNodes({neighbours:o,layout:y,isCentral:!1,isSibling:!1,friendGateOnLeft:!0}),this.addNodes({neighbours:l,layout:E,isCentral:!1,isSibling:!1,friendGateOnLeft:!1}),this.plugin.settings.renderSiblings&&this.addNodes({neighbours:h,layout:D,isCentral:!1,isSibling:!0,friendGateOnLeft:!0});const C=(e,t,i)=>{t.forEach((t=>{const s=this.nodesMap.get(t.page.path);s&&this.links.addLink(e,s,i,t.relationType,t.typeDefinition,t.linkDirection,n,this.plugin.settings)}))};Array.from(this.nodesMap.values()).forEach((e=>{C(e,e.page.getChildren(),t.CHILD),C(e,e.page.getParents(),t.PARENT),C(e,e.page.getFriends(),t.FRIEND)})),n.style.opacity=100,this.layouts.forEach((e=>e.render()));const x=n.getElements();this.links.render(Array.from(this.toolsPanel.linkTagFilter.selectedLinks));const A=n.getElements().filter((e=>!x.includes(e)));n.getExcalidrawAPI().updateScene({elements:A.concat(x)}),n.getExcalidrawAPI().updateScene({appState:{viewBackgroundColor:this.plugin.settings.backgroundColor}}),this.plugin.settings.allowAutozoom&&n.getExcalidrawAPI().zoomToFit(null,5,.15),this.toolsPanel.rerender(),this.focusSearchAfterInitiation&&this.plugin.settings.allowAutofocuOnSearch&&(this.toolsPanel.searchElement.focus(),this.focusSearchAfterInitiation=!1),this.blockUpdateTimer=!1}isCentralLeafStillThere(){return null!==app.workspace.getLeafById(this.centralLeaf.id)}async addEventHandler(){const e=this,t=async t=>{var i;if(this.disregardLeafChange)return;if(e.blockUpdateTimer=!0,await sleep(100),this.pinLeaf&&!this.isCentralLeafStillThere()&&(this.pinLeaf=!1,this.toolsPanel.rerender()),this.pinLeaf&&t!==this.centralLeaf)return;if(!(null===(i=e.ea.targetView)||void 0===i?void 0:i.file)||e.ea.targetView.file.path!==e.plugin.settings.excalibrainFilepath)return void e.unloadScene();if(!((null==t?void 0:t.view)&&t.view instanceof s.FileView&&t.view.file))return void(e.blockUpdateTimer=!1);const n=t.view.file;if(n.path===e.ea.targetView.file.path)return this.vaultFileChanged&&(this.zoomToFitOnNextBrainLeafActivate=!1,await this.reRender(!0)),this.zoomToFitOnNextBrainLeafActivate&&(this.zoomToFitOnNextBrainLeafActivate=!1,e.plugin.settings.allowAutozoom&&e.ea.getExcalidrawAPI().zoomToFit(null,5,.15)),void(e.blockUpdateTimer=!1);const a=e.plugin.pages.get(e.centralPagePath);a&&a.path===n.path&&n.stat.mtime===a.mtime?e.blockUpdateTimer=!1:(e.plugin.pages.get(n.path)||await e.plugin.createIndex(),this.addToHistory(n.path),e.centralPagePath=n.path,e.centralLeaf=t,e.render())},i=()=>{this.vaultFileChanged=!0};app.workspace.on("active-leaf-change",t),this.removeEH=()=>app.workspace.off("active-leaf-change",t),this.setTimer(),app.vault.on("rename",i),this.removeOnRename=()=>app.vault.off("rename",i),app.vault.on("modify",i),this.removeOnModify=()=>app.vault.off("modify",i),app.vault.on("create",i),this.removeOnCreate=()=>app.vault.off("create",i),app.vault.on("delete",i),this.removeOnDelete=()=>app.vault.off("delete",i);const n=[];app.workspace.iterateAllLeaves((e=>{e.view instanceof s.FileView&&e.view.file&&e.view.file.path!==this.ea.targetView.file.path&&n.push(e)})),await this.plugin.createIndex();let a=n[0];if(n.length>0){const e=app.workspace.getLastOpenFiles()[0];if(e&&""!==e){const t=n.filter((t=>{var i;return(null===(i=t.view)||void 0===i?void 0:i.file.path)===e}));t.length>0&&(a=t[0])}t(a)}}setTimer(){this.removeTimer&&(this.removeTimer(),this.removeTimer=void 0);const e=setInterval((async()=>{this.blockUpdateTimer||this.vaultFileChanged&&(this.vaultFileChanged=!1,await this.plugin.createIndex(),this.centralPagePath&&(this.plugin.pages.get(this.centralPagePath)||this.centralLeaf&&this.centralLeaf.view&&this.centralLeaf.view.file&&(this.centralPagePath=this.centralLeaf.view.file.path)),this.render())}),this.plugin.settings.indexUpdateInterval);this.removeTimer=()=>clearInterval(e)}unloadScene(){var e,t;if(this.removeEH&&(this.removeEH(),this.removeEH=void 0),this.removeTimer&&(this.removeTimer(),this.removeTimer=void 0),this.removeOnRename&&(this.removeOnRename(),this.removeOnRename=void 0),this.removeOnModify&&(this.removeOnModify(),this.removeOnModify=void 0),this.removeOnCreate&&(this.removeOnCreate(),this.removeOnCreate=void 0),this.removeOnDelete&&(this.removeOnDelete(),this.removeOnDelete=void 0),this.ea.targetView&&isBoolean(this.ea.targetView.linksAlwaysOpenInANewPane)&&(this.ea.targetView.linksAlwaysOpenInANewPane=!1),this.ea.targetView&&this.ea.targetView.excalidrawAPI)try{this.ea.targetView.semaphores.saving=!1,this.ea.targetView.excalidrawAPI.setMobileModeAllowed(!0),this.ea.targetView.excalidrawAPI.updateScene({appState:{viewModeEnabled:!1}})}catch(e){}if(this.ea.targetView&&this.ea.targetView._loaded)try{this.ea.deregisterThisAsViewEA()}catch(e){}(async()=>{const e=this.plugin.settings.navigationHistory.slice();await this.plugin.loadSettings(),this.plugin.settings.navigationHistory=e,await this.plugin.saveSettings()})(),null===(e=this.toolsPanel)||void 0===e||e.terminate(),this.toolsPanel=void 0,null===(t=this.historyPanel)||void 0===t||t.terminate(),this.historyPanel=void 0,this.ea.targetView=void 0,this.leaf=void 0,this.centralLeaf=void 0,this.centralPagePath=void 0,this.terminated=!0,app.plugins.plugins["obsidian-excalidraw-plugin"]||(this.plugin.EA=null),new s.Notice("Brain Graph Off")}}class nt extends s.EditorSuggest{constructor(e){super(e.app),this.getKeys=()=>{const e=this.plugin.settings.hierarchy,t=this.suggestType;return"all"===t?e.parents.concat(e.children).concat(e.friends).sort(((e,t)=>e.toLowerCase()>t.toLowerCase()?1:-1)):"parent"===t?e.parents:"child"===t?e.children:e.friends},this.getTrigger=()=>{const e=this.suggestType,t=this.plugin.settings;return"all"===e?t.ontologySuggesterTrigger:"parent"===e?t.ontologySuggesterParentTrigger:"child"===e?t.ontologySuggesterChildTrigger:t.ontologySuggesterFriendTrigger},this.getSuggestions=e=>{const t=e.query.toLowerCase();return this.getKeys().filter((e=>e.toLowerCase().includes(t)))},this.plugin=e}onTrigger(e,t,i){const s=this.plugin.settings;if(s.allowOntologySuggester){const i=t.getLine(e.line).substring(0,e.ch),n=new RegExp(`(^${s.ontologySuggesterTrigger}|\\${s.ontologySuggesterMidSentenceTrigger+s.ontologySuggesterTrigger}|^${s.ontologySuggesterParentTrigger}|\\${s.ontologySuggesterMidSentenceTrigger+s.ontologySuggesterParentTrigger}|^${s.ontologySuggesterChildTrigger}|\\${s.ontologySuggesterMidSentenceTrigger+s.ontologySuggesterChildTrigger}|^${s.ontologySuggesterFriendTrigger}|\\${s.ontologySuggesterMidSentenceTrigger+s.ontologySuggesterFriendTrigger})([^\\s\\${s.ontologySuggesterTrigger}]*)`,"g");let a,r,o;const l=i.matchAll(n);for(;!(o=l.next()).done;)r=o.value[1],a=o.value[2];if(void 0!==a){switch(r){case s.ontologySuggesterTrigger:case s.ontologySuggesterMidSentenceTrigger+s.ontologySuggesterTrigger:this.suggestType="all";break;case s.ontologySuggesterParentTrigger:case s.ontologySuggesterMidSentenceTrigger+s.ontologySuggesterParentTrigger:this.suggestType="parent";break;case s.ontologySuggesterChildTrigger:case s.ontologySuggesterMidSentenceTrigger+s.ontologySuggesterChildTrigger:this.suggestType="child";break;default:this.suggestType="friend"}return this.latestTriggerInfo={end:e,start:{ch:e.ch-a.length-this.getTrigger().length,line:e.line},query:a},this.latestTriggerInfo}}return null}renderSuggestion(e,t){t.createEl("b",{text:e})}selectSuggestion(e){const{context:t}=this;if(t){const i=this.plugin.settings.boldFields,s=(i?"**":"")+e+(i?"**":"")+":: ";if(t.editor.replaceRange(s,this.latestTriggerInfo.start,this.latestTriggerInfo.end),this.latestTriggerInfo.start.ch===this.latestTriggerInfo.end.ch){const e=this.latestTriggerInfo.end;e.ch+=s.length,t.editor.setCursor(e)}}}}class at extends s.Plugin{constructor(e,t){super(e,t),this.hierarchyLowerCase={parents:[],children:[],friends:[]},this.scene=null,this.pluginLoaded=!1,this.starred=[],this.focusSearchAfterInitiation=!1,this.starred=[new y(null,"Initializing index, please wait",null,this,!1,!1,"Initializing index, please wait")]}async onload(){await this.loadSettings(),this.addSettingTab(new P(this.app,this)),this.registerEditorSuggest(new nt(this)),this.app.workspace.onLayoutReady((()=>{this.DVAPI=M(),this.DVAPI?this.DVAPI.version.compare(">=","0.5.31")?(this.EA=S(),this.EA?this.EA.verifyMinimumPluginVersion("1.6.33")?(this.registerCommands(),this.registerExcalidrawAutomateHooks(),this.pluginLoaded=!0):new C(app,"⚠ ExcaliBrain Disabled: Please upgrade Excalidraw and try again",N("EXCALIDRAW_MINAPP_VERSION")).show((async e=>{new s.Notice("Disabling ExcaliBrain Plugin",8e3),h({fn:this.onload,where:"main.ts/onload()",message:"ExcaliBrain requires a new version of Excalidraw"}),this.app.plugins.disablePlugin("excalibrain")})):new C(app,"⚠ ExcaliBrain Disabled: Excalidraw Plugin not found",N("EXCALIDRAW_NOT_FOUND")).show((async e=>{new s.Notice("Disabling ExcaliBrain Plugin",8e3),h({fn:this.onload,where:"main.ts/onload()",message:"Excalidraw not found"}),this.app.plugins.disablePlugin("excalibrain")}))):new C(app,"⚠ ExcaliBrain Disabled: Dataview upgrade requried",N("DATAVIEW_UPGRADE")).show((async e=>{new s.Notice("Disabling ExcaliBrain Plugin",8e3),h({fn:this.onload,where:"main.ts/onload()",message:"Dataview version error"}),this.app.plugins.disablePlugin("excalibrain")})):new C(app,"⚠ ExcaliBrain Disabled: DataView Plugin not found",N("DATAVIEW_NOT_FOUND")).show((async e=>{new s.Notice("Disabling ExcaliBrain Plugin",8e3),h({fn:this.onload,where:"main.ts/onload()",message:"Dataview not found"}),this.app.plugins.disablePlugin("excalibrain")}))}))}async createIndex(){this.pages=new V(this),this.lowercasePathMap=new Map;let t=0;for(;this.app.metadataCache.inProgressTaskCount>0||this.DVAPI.index.importer.reloadQueue.length>0;)t++%100==10&&new s.Notice("ExcaliBrain is waiting for Dataview to update its index",1e3),await sleep(100);const n=(t,a)=>{t.children.forEach((t=>{if(t instanceof s.TFolder){const s=new y(this.pages,"folder:"+t.path,null,this,!0,!1,t.name);return this.pages.add("folder:"+t.path,s),s.addParent(a,e.DEFINED,i.FROM,"file-tree"),a.addChild(s,e.DEFINED,i.TO,"file-tree"),void n(t,s)}{this.lowercasePathMap.set(t.path.toLowerCase(),t.path);const s=new y(this.pages,t.path,t,this);this.pages.add(t.path,s),s.addParent(a,e.DEFINED,i.FROM,"file-tree"),a.addChild(s,e.DEFINED,i.TO,"file-tree")}}))},a=app.vault.getRoot(),r=new y(this.pages,"folder:/",null,this,!0,!1,"/");this.pages.add("folder:/",r),n(a,r);const o=Object.keys(app.metadataCache.getTags()).map((e=>e.substring(1).split("/")));o.forEach((t=>{const s=[];t.forEach(((t,n,a)=>{const r=a.slice(0,n+1).join("/"),o="tag:"+r;let l=this.pages.get(o);if(l)s.push(l);else if(l=new y(this.pages,o,null,this,!1,!0,this.settings.showFullTagName?r:t),this.pages.add(o,l),s.push(l),n>0){const t=s[n-1];l.addParent(t,e.DEFINED,i.FROM,"tag-tree"),t.addChild(l,e.DEFINED,i.TO,"tag-tree")}}))})),this.pages.addUnresolvedLinks(),this.pages.addResolvedLinks();const l=this;setTimeout((async()=>{const e=app.internalPlugins.getPluginById("starred");e&&(l.starred=(await e.loadData()).items.filter((e=>"file"===e.type)).map((e=>e.path)).filter((e=>e!==l.settings.excalibrainFilepath&&l.pages.has(e))).map((e=>l.pages.get(e))))}))}excalidrawAvailable(){const e=S();return e?(!this.EA!==e&&(this.EA=e,this.registerExcalidrawAutomateHooks()),!0):(this.EA=null,this.scene&&this.scene.unloadScene(),new s.Notice("ExcaliBrain: Please start Excalidraw and try again.",4e3),!1)}revealBrainLeaf(){var e;if(!this.scene||this.scene.terminated)return;app.workspace.revealLeaf(this.scene.leaf);const t=app.plugins.getPlugin("obsidian-hover-editor");if(t){const e=t.activePopovers.filter((e=>e.leaves()[0]===this.scene.leaf))[0];e&&0===this.scene.leaf.view.containerEl.offsetHeight&&e.titleEl.querySelector("a.popover-action.mod-minimize").click()}const i=null===(e=this.scene.toolsPanel)||void 0===e?void 0:e.searchElement;null==i||i.focus()}registerCommands(){const e=(e,t)=>{var i;const n=null===(i=app.workspace.activeLeaf)||void 0===i?void 0:i.view;if(e)return n instanceof s.MarkdownView&&"source"===n.getMode();if(!(n instanceof s.MarkdownView)||"source"!==n.getMode())return!1;const a=n.editor.getCursor(),r=n.editor.getLine(a.line).match(/^([^\:]*)::/);return!!r&&((async()=>{const e=this.settings.navigationHistory;if(await this.loadSettings(),this.settings.navigationHistory=e,this.settings.hierarchy.parents.includes(r[1]))new s.Notice(`${r[1]} is already registered as a PARENT`);else if(this.settings.hierarchy.children.includes(r[1]))new s.Notice(`${r[1]} is already registered as a CHILD`);else if(this.settings.hierarchy.friends.includes(r[1]))new s.Notice(`${r[1]} is already registered as a FRIEND`);else{switch(t){case"parent":this.settings.hierarchy.parents.push(r[1]),this.settings.hierarchy.parents=this.settings.hierarchy.parents.sort(((e,t)=>e.toLowerCase()<t.toLowerCase()?-1:1)),this.hierarchyLowerCase.parents=[],this.settings.hierarchy.parents.forEach((e=>this.hierarchyLowerCase.parents.push(e.toLowerCase().replaceAll(" ","-"))));break;case"child":this.settings.hierarchy.children.push(r[1]),this.settings.hierarchy.children=this.settings.hierarchy.children.sort(((e,t)=>e.toLowerCase()<t.toLowerCase()?-1:1)),this.hierarchyLowerCase.children=[],this.settings.hierarchy.children.forEach((e=>this.hierarchyLowerCase.children.push(e.toLowerCase().replaceAll(" ","-"))));break;default:this.settings.hierarchy.friends.push(r[1]),this.settings.hierarchy.friends=this.settings.hierarchy.friends.sort(((e,t)=>e.toLowerCase()<t.toLowerCase()?-1:1)),this.hierarchyLowerCase.friends=[],this.settings.hierarchy.friends.forEach((e=>this.hierarchyLowerCase.friends.push(e.toLowerCase().replaceAll(" ","-"))))}await this.saveSettings(),this.scene&&!this.scene.terminated&&(this.scene.vaultFileChanged=!0),new s.Notice(`Added ${r[1]} as ${t}`)}})(),!0)};this.addCommand({id:"excalibrain-addParentField",name:N("COMMAND_ADD_PARENT_FIELD"),checkCallback:t=>e(t,"parent")}),this.addCommand({id:"excalibrain-addChildField",name:N("COMMAND_ADD_CHILD_FIELD"),checkCallback:t=>e(t,"child")}),this.addCommand({id:"excalibrain-addFriendField",name:N("COMMAND_ADD_FRIEND_FIELD"),checkCallback:t=>e(t,"friend")}),this.addCommand({id:"excalibrain-start",name:N("COMMAND_START"),checkCallback:e=>{if(e)return this.excalidrawAvailable();if(!this.excalidrawAvailable())return;if(this.scene&&!this.scene.terminated)return void this.revealBrainLeaf();const t=this.getBrainLeaf();if(t)return this.scene=new st(this,!0,t),this.scene.initialize(!0),void this.revealBrainLeaf();this.focusSearchAfterInitiation=!0,st.openExcalidrawLeaf(window.ExcalidrawAutomate,this.settings,t)}}),this.addCommand({id:"excalibrain-start-popout",name:N("COMMAND_START_POPOUT"),checkCallback:e=>{if(e)return!app.isMobile&&this.excalidrawAvailable();if(!this.excalidrawAvailable()||app.isMobile)return;if(this.scene&&!this.scene.terminated)return void this.revealBrainLeaf();const t=this.getBrainLeaf();if(t)return this.scene=new st(this,!0,t),this.scene.initialize(!0),void this.revealBrainLeaf();this.focusSearchAfterInitiation=!0,st.openExcalidrawLeaf(window.ExcalidrawAutomate,this.settings,app.workspace.openPopoutLeaf())}}),this.addCommand({id:"excalibrain-open-hover",name:N("COMMAND_START_HOVER"),checkCallback:e=>{const t=app.plugins.getPlugin("obsidian-hover-editor");if(e)return t&&this.excalidrawAvailable();if(this.excalidrawAvailable()&&t)if(!this.scene||this.scene.terminated)try{const e=this.getBrainLeaf();if(e){const i=t.activePopovers.filter((t=>t.leaves()[0]===e))[0];if(i)return app.workspace.revealLeaf(e),0===e.view.containerEl.offsetHeight&&i.titleEl.querySelector("a.popover-action.mod-maximize").click(),this.scene=new st(this,!0,e),void this.scene.initialize(!0)}const i=t.spawnPopover(void 0,(()=>{if(this.app.workspace.setActiveLeaf(i,!1,!0),!t.activePopovers.filter((e=>e.leaves()[0]===i))[0])return new s.Notice(N("HOVER_EDITOR_ERROR"),6e3),!1;setTimeout((()=>app.commands.executeCommandById("obsidian-hover-editor:snap-active-popover-to-viewport"))),this.focusSearchAfterInitiation=!0,st.openExcalidrawLeaf(window.ExcalidrawAutomate,this.settings,i)}))}catch(e){new s.Notice(N("HOVER_EDITOR_ERROR"),6e3)}else this.revealBrainLeaf()}})}getBrainLeaf(){let e;return app.workspace.iterateAllLeaves((t=>{t.view&&this.EA.isExcalidrawView(t.view)&&t.view instanceof s.TextFileView&&t.view.file.path===this.settings.excalibrainFilepath&&(e=t)})),e}registerExcalidrawAutomateHooks(){this.EA.onViewModeChangeHook=e=>{var t;this.EA.targetView&&(null===(t=this.EA.targetView.file)||void 0===t?void 0:t.path)===this.settings.excalibrainFilepath&&(e||this.stop())},this.EA.onLinkHoverHook=(e,t)=>{var i;return!(this.scene&&this.EA.targetView&&(null===(i=this.EA.targetView.file)||void 0===i?void 0:i.path)===this.settings.excalibrainFilepath&&this.EA.targetView.excalidrawAPI&&this.EA.targetView.excalidrawAPI.getAppState().viewModeEnabled&&(this.scene.disregardLeafChange=!0,this.disregardLeafChangeTimer&&clearTimeout(this.disregardLeafChangeTimer),this.disregardLeafChangeTimer=setTimeout((()=>{this.disregardLeafChangeTimer=null,this.scene&&(this.scene.disregardLeafChange=!1)}),1e3),0))},this.EA.onLinkClickHook=(e,t,i)=>{var n,a,r,o,l,h,d,g,c,p,u;const f=t.match(/\[\[([^\]]*)/)[1],y=this.pages.get(f);if(!i.shiftKey&&y&&y.isVirtual)return null===(n=this.scene)||void 0===n||n.renderGraphForPath(f),!1;if(!t.startsWith("[[folder:")&&!t.startsWith("[[tag:")){if((null===(l=null===(o=null===(r=null===(a=this.scene)||void 0===a?void 0:a.centralLeaf)||void 0===r?void 0:r.view)||void 0===o?void 0:o.file)||void 0===l?void 0:l.path)===f)return null===(h=this.scene)||void 0===h||h.renderGraphForPath(f),!1;if((null===(d=this.scene)||void 0===d?void 0:d.pinLeaf)&&(null===(g=this.scene)||void 0===g?void 0:g.isCentralLeafStillThere())){const e=app.vault.getAbstractFileByPath(f.split("#")[0]);if(e&&e instanceof s.TFile)return this.scene.centralLeaf.openFile(e),this.scene.renderGraphForPath(f),!1}if(null===(c=this.scene)||void 0===c?void 0:c.isCentralLeafStillThere()){const e=app.vault.getAbstractFileByPath(f.split("#")[0]);if(e&&e instanceof s.TFile)return this.scene.centralLeaf.openFile(e),this.scene.renderGraphForPath(f),!1}return null===(p=this.scene)||void 0===p||p.renderGraphForPath(f,!1),!0}return null===(u=this.scene)||void 0===u||u.renderGraphForPath(f),!1},this.EA.onViewUnloadHook=e=>{this.scene&&this.scene.leaf===e.leaf&&this.stop()}}onunload(){this.scene&&(this.scene.unloadScene(),this.scene=null)}setHierarchyLinkStylesExtended(){this.hierarchyLinkStylesExtended={},Object.entries(this.settings.hierarchyLinkStyles).forEach((e=>{const t=e[0].toLowerCase().replaceAll(" ","-");this.hierarchyLinkStylesExtended[e[0]]=e[1],e[0]!==t&&(this.hierarchyLinkStylesExtended[t]=e[1])}))}loadCustomNodeLabelFunction(){if(this.settings.nodeTitleScript)try{this.customNodeLabel=new Function("dvPage","defaultName","return "+this.settings.nodeTitleScript)}catch(e){h({fn:this.loadCustomNodeLabelFunction,message:"error processing custom node label script",where:"loadCustomNodeLabelFunction()",data:this.settings.nodeTitleScript,error:e}),new s.Notice("Could not load custom node label function. See Developer console for details"),this.customNodeLabel=null}else this.customNodeLabel=null}async loadSettings(){this.settings=Object.assign({},A,await this.loadData()),this.settings.hierarchy.exclusions||(this.settings.hierarchy.exclusions=A.hierarchy.exclusions),this.loadCustomNodeLabelFunction(),this.settings.baseLinkStyle=Object.assign(Object.assign({},b),this.settings.baseLinkStyle),this.settings.baseNodeStyle=Object.assign(Object.assign({},T),this.settings.baseNodeStyle),this.hierarchyLowerCase.parents=[],this.settings.hierarchy.parents=this.settings.hierarchy.parents.sort(((e,t)=>e.toLowerCase()<t.toLowerCase()?-1:1)),this.settings.hierarchy.parents.forEach((e=>this.hierarchyLowerCase.parents.push(e.toLowerCase().replaceAll(" ","-")))),this.hierarchyLowerCase.children=[],this.settings.hierarchy.children=this.settings.hierarchy.children.sort(((e,t)=>e.toLowerCase()<t.toLowerCase()?-1:1)),this.settings.hierarchy.children.forEach((e=>this.hierarchyLowerCase.children.push(e.toLowerCase().replaceAll(" ","-")))),this.hierarchyLowerCase.friends=[],this.settings.hierarchy.friends=this.settings.hierarchy.friends.sort(((e,t)=>e.toLowerCase()<t.toLowerCase()?-1:1)),this.settings.hierarchy.friends.forEach((e=>this.hierarchyLowerCase.friends.push(e.toLowerCase().replaceAll(" ","-")))),this.settings.hierarchy.exclusions=this.settings.hierarchy.exclusions.sort(((e,t)=>e.toLowerCase()<t.toLowerCase()?-1:1)),this.setHierarchyLinkStylesExtended(),this.linkStyles={},this.linkStyles.base={style:this.settings.baseLinkStyle,allowOverride:!1,userStyle:!1,display:N("LINKSTYLE_BASE"),getInheritedStyle:()=>this.settings.baseLinkStyle},this.linkStyles.inferred={style:this.settings.inferredLinkStyle,allowOverride:!0,userStyle:!1,display:N("LINKSTYLE_INFERRED"),getInheritedStyle:()=>this.settings.baseLinkStyle},this.linkStyles["file-tree"]={style:this.settings.folderLinkStyle,allowOverride:!0,userStyle:!1,display:N("LINKSTYLE_FOLDER"),getInheritedStyle:()=>this.settings.baseLinkStyle},this.linkStyles["tag-tree"]={style:this.settings.tagLinkStyle,allowOverride:!0,userStyle:!1,display:N("LINKSTYLE_TAG"),getInheritedStyle:()=>this.settings.baseLinkStyle},Object.entries(this.settings.hierarchyLinkStyles).forEach((e=>{v.contains(e[0])||(this.linkStyles[e[0]]={style:e[1],allowOverride:!0,userStyle:!0,display:e[0],getInheritedStyle:()=>this.settings.baseLinkStyle})})),this.nodeStyles={},this.nodeStyles.base={style:this.settings.baseNodeStyle,allowOverride:!1,userStyle:!1,display:N("NODESTYLE_BASE"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.inferred={style:this.settings.inferredNodeStyle,allowOverride:!0,userStyle:!1,display:N("NODESTYLE_INFERRED"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.virtual={style:this.settings.virtualNodeStyle,allowOverride:!0,userStyle:!1,display:N("NODESTYLE_VIRTUAL"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.central={style:this.settings.centralNodeStyle,allowOverride:!0,userStyle:!1,display:N("NODESTYLE_CENTRAL"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.sibling={style:this.settings.siblingNodeStyle,allowOverride:!0,userStyle:!1,display:N("NODESTYLE_SIBLING"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.attachment={style:this.settings.attachmentNodeStyle,allowOverride:!0,userStyle:!1,display:N("NODESTYLE_ATTACHMENT"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.folder={style:this.settings.folderNodeStyle,allowOverride:!0,userStyle:!1,display:N("NODESTYLE_FOLDER"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.tag={style:this.settings.tagNodeStyle,allowOverride:!0,userStyle:!1,display:N("NODESTYLE_TAG"),getInheritedStyle:()=>this.settings.baseNodeStyle},Object.entries(this.settings.tagNodeStyles).sort(((e,t)=>e[0].toLowerCase()<t[0].toLowerCase()?-1:1)).forEach((e=>{this.nodeStyles[e[0]]={style:e[1],allowOverride:!0,userStyle:!0,display:e[0],getInheritedStyle:()=>this.settings.baseNodeStyle}}))}async saveSettings(){await this.saveData(this.settings)}stop(){this.scene&&!this.scene.terminated&&(this.scene.unloadScene(),this.scene=null)}async start(e){if(!e.view)return;if(!(e.view instanceof s.TextFileView))return void new s.Notice("Wrong view type. Cannot start ExcaliBrain.");if(e.view.file.path!==this.settings.excalibrainFilepath)return void new s.Notice(`The brain file is not the one configured in settings!\nThe file in settings is ${this.settings.excalibrainFilepath}.\nThis file is ${e.view.file.path}.\nPlease start ExcaliBrain using the Command Palette action.`,5e3);let t=0;for(;!this.pluginLoaded&&t++<100;)await sleep(50);if(!this.pluginLoaded)return new s.Notice("ExcaliBrain plugin did not load - aborting start()"),void h({where:"ExcaliBrain.start()",fn:this.start,message:"ExcaliBrain did not load. Aborting after 5000ms of trying"});this.excalidrawAvailable()&&(this.stop(),e?(this.scene=new st(this,!0,e),this.scene.initialize(this.focusSearchAfterInitiation),this.focusSearchAfterInitiation=!1):await st.openExcalidrawLeaf(window.ExcalidrawAutomate,this.settings,this.getBrainLeaf()))}}module.exports=at;