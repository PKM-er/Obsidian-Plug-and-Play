"use strict";var e,t,i,s=require("obsidian");!function(e){e[e.DEFINED=1]="DEFINED",e[e.INFERRED=2]="INFERRED"}(e||(e={})),function(e){e[e.PARENT=0]="PARENT",e[e.CHILD=1]="CHILD",e[e.FRIEND=2]="FRIEND"}(t||(t={})),function(e){e[e.TO=1]="TO",e[e.FROM=2]="FROM",e[e.BOTH=3]="BOTH"}(i||(i={}));const n=(e,t,i)=>{const s=e.metadataCache.getFirstLinkpathDest(t,i);return s?s.path:t},a=(e,t)=>{const i=new Set,s=e.matchAll(/[^[]*\[\[(?<wikiLink>[^#\]\|]*)[^\]]*]]|\[[^\]]*]\((?<mdLink>[^)]*)\)/g);let a;for(;!(a=s.next()).done;){if(a.value.groups.wikiLink){const e=n(app,a.value.groups.wikiLink,t.path);e&&i.add(e)}if(a.value.groups.mdLink){const e=n(app,decodeURIComponent(a.value.groups.mdLink),t.path);e&&i.add(e)}}return Array.from(i)},r=(e,t,i)=>{const s=[],r=new Set;return i.forEach((i=>{const o=t[i];o&&!r.has(i)&&(r.add(i),((e,t,i)=>{const s=new Set;if(t.values){const r=Array.from(t.values());r.filter((e=>(null==e?void 0:e.type)&&("file"===e.type||"header"===e.type))).forEach((t=>{const a=n(e,t.path,i.path);a&&s.add(a)}));const o=a(r.filter((e=>"string"==typeof e)).join(" "),i),l=r.filter((e=>(null==e?void 0:e.values)&&"object"==typeof e&&"string"==typeof e.values[0])).map((t=>n(e,t.values[0],i.path)));
//! currently there is an issue with case sensitivity. DataView retains case sensitivity of links for the front matter, but not the others
return Array.from(s).concat(o).concat(l)}if(t.path){const s=n(e,t.path,i.path);return s?[s]:[]}return a(t,i)})(e.app,o,t.file).forEach((e=>s.push({link:e,field:i}))))})),s},o=(e,t)=>{var i,s,n;return e?(null!==(n=null===(s=null===(i=e.file)||void 0===i?void 0:i.tags)||void 0===s?void 0:s.values)&&void 0!==n?n:[]).filter((e=>t.tagStyleList.some((t=>e.startsWith(t)))))[0]:null},l=(e,t)=>e?t.tagNodeStyles[t.tagStyleList.filter((t=>e.startsWith(t)))[0]]:{},h=e=>{console.error(Object.assign({plugin:"ExcaliBrain"},e))};console.log.bind(window.console),console.log.bind(window.console);const d=e=>`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(e.replaceAll("&nbsp;"," "))))}`;function c(e){const t=e.lastIndexOf("/"),i=-1==t?e:e.substring(t+1);return{folderpath:s.normalizePath(e.substring(0,t)),filename:i,basename:i.replace(/\.[^/.]+$/,"")}}const g={target:null,isParent:!1,isChild:!1,isFriend:!1,direction:null},p=(e,t)=>e&&t?e+", "+t:e||t,u=(e,t)=>e?e===i.BOTH||e===t?e:i.BOTH:t,f=(t,i)=>t===e.DEFINED?e.DEFINED:t===e.INFERRED?i===e.DEFINED?e.DEFINED:e.INFERRED:i;class y{constructor(t,i,s,n,a=!1,r=!1,o){this.pages=t,this.path=i,this.file=s,this.plugin=n,this.isFolder=a,this.isTag=r,this.name=o,this.dvIndexReady=!1,this.isChild=t=>{const{pi:i,pd:s,ci:n,cd:a,fd:r}=this.getRelationVector(t);return!a||s||r?i||s||!n||a||r?null:e.INFERRED:e.DEFINED},o||(this.name=s?"md"===s.extension?s.basename:s.name:(e=>{const t=e.endsWith(".md"),i=e.substring(e.lastIndexOf("/")+1);return t?i.slice(0,-3):i})(i)),this.mtime=s?s.stat.mtime:null,this.neighbours=new Map}addDVFieldLinksToPage(){var t,s,n;if(this.dvIndexReady||this.isFolder||!this.pages)return;if(this.dvIndexReady=!0,this.isTag){const t=this.plugin.DVAPI.index.etags.invMap.get("#"+this.path.substring(4));if(!t)return;return void t.forEach((t=>{const s=this.pages.get(t);s&&(s.addParent(this,e.DEFINED,i.FROM,"tag-tree"),this.addChild(s,e.DEFINED,i.TO,"tag-tree"))}))}if(!this.file)return;const a=this.plugin.DVAPI.page(this.file.path);if(!a)return;if(this.dvPage=a,!a)return;this.primaryStyleTag=o(this.dvPage,this.plugin.settings),(null!==(n=null===(s=null===(t=a.file)||void 0===t?void 0:t.etags)||void 0===s?void 0:s.values)&&void 0!==n?n:[]).forEach((t=>{t="tag:"+t.substring(1);const s=this.pages.get(t);s&&(this.addParent(s,e.DEFINED,i.FROM,"tag-tree"),s.addChild(this,e.DEFINED,i.TO,"tag-tree"))}));const l=this.plugin.hierarchyLowerCase.parents;r(this.plugin,a,l).forEach((t=>{const s=this.pages.get(t.link);s&&(this.addParent(s,e.DEFINED,i.TO,t.field),s.addChild(this,e.DEFINED,i.FROM,t.field))}));const h=this.plugin.hierarchyLowerCase.children;r(this.plugin,a,h).forEach((t=>{const s=this.pages.get(t.link);s&&(this.addChild(s,e.DEFINED,i.TO,t.field),s.addParent(this,e.DEFINED,i.FROM,t.field))}));const d=this.plugin.hierarchyLowerCase.friends;r(this.plugin,a,d).forEach((t=>{const s=this.pages.get(t.link);s&&(this.addFriend(s,e.DEFINED,i.TO,t.field),s.addFriend(this,e.DEFINED,i.FROM,t.field))}))}getTitle(){var e,t,i,s,n;const a=this.file&&this.plugin.settings.renderAlias&&null!==(s=null===(i=null===(t=null===(e=this.dvPage)||void 0===e?void 0:e.file)||void 0===t?void 0:t.aliases)||void 0===i?void 0:i.values)&&void 0!==s?s:[],r=a.length>0?a[0]:this.name;if((null===(n=this.dvPage)||void 0===n?void 0:n.file)&&this.plugin.customNodeLabel)try{return this.plugin.customNodeLabel(this.dvPage,r)}catch(e){h({fn:this.getTitle,message:"Error executing cutomer node label function. The script is: "+this.plugin.settings.nodeTitleScript,data:this.dvPage,where:"Page.getTitle()",error:e})}return r}getRelationVector(t){return{pi:t.isParent&&t.parentType===e.INFERRED,pd:t.isParent&&t.parentType===e.DEFINED,ci:t.isChild&&t.childType===e.INFERRED,cd:t.isChild&&t.childType===e.DEFINED,fd:!this.plugin.settings.inferAllLinksAsFriends&&t.isFriend||this.plugin.settings.inferAllLinksAsFriends&&t.isFriend&&!(t.parentType===e.DEFINED||t.childType===e.DEFINED)}}getNeighbours(){this.addDVFieldLinksToPage(),this.neighbours.forEach((e=>e.target.addDVFieldLinksToPage()));const{showVirtualNodes:e,showAttachments:t,showFolderNodes:i,showTagNodes:s,showPageNodes:n}=this.plugin.settings;return Array.from(this.neighbours).filter((a=>(e||!a[1].target.isVirtual)&&(t||!a[1].target.isAttachment)&&(i||!a[1].target.isFolder)&&(s||!a[1].target.isTag)&&(n||a[1].target.isFolder||a[1].target.isTag)))}get isVirtual(){return null===this.file&&!this.isFolder&&!this.isTag}get isAttachment(){return!!this.file&&"md"!==this.file.extension}get isMarkdown(){var e;return"md"===(null===(e=this.file)||void 0===e?void 0:e.extension)||!this.file}addParent(e,t,i,s){if(e.path===this.plugin.settings.excalibrainFilepath||e.path===this.path)return;const n=this.neighbours.get(e.path);if(n)return n.isParent=!0,n.parentType=f(n.parentType,t),n.parentTypeDefinition=p(s,n.parentTypeDefinition),void(n.direction=u(n.direction,i));this.neighbours.set(e.path,Object.assign(Object.assign({},g),{target:e,isParent:!0,parentType:t,parentTypeDefinition:s,direction:i}))}addChild(e,t,i,s){if(e.path===this.plugin.settings.excalibrainFilepath||e.path===this.path)return;const n=this.neighbours.get(e.path);if(n)return n.isChild=!0,n.childType=f(n.childType,t),n.childTypeDefinition=p(s,n.childTypeDefinition),void(n.direction=u(n.direction,i));this.neighbours.set(e.path,Object.assign(Object.assign({},g),{target:e,isChild:!0,childType:t,childTypeDefinition:s,direction:i}))}addFriend(e,t,i,s){if(e.path===this.plugin.settings.excalibrainFilepath||e.path===this.path)return;const n=this.neighbours.get(e.path);if(n)return n.isFriend=!0,n.friendType=f(n.friendType,t),n.friendTypeDefinition=p(s,n.friendTypeDefinition),void(n.direction=u(n.direction,i));this.neighbours.set(e.path,Object.assign(Object.assign({},g),{target:e,isFriend:!0,friendType:t,friendTypeDefinition:s,direction:i}))}unlinkNeighbour(e){this.neighbours.delete(e)}hasChildren(){return this.getNeighbours().some((t=>{const i=this.isChild(t[1]);return i&&this.plugin.settings.showInferredNodes||i===e.DEFINED}))}getChildren(){return this.getNeighbours().filter((t=>{const i=this.isChild(t[1]);return i&&this.plugin.settings.showInferredNodes||i===e.DEFINED})).map((e=>({page:e[1].target,relationType:e[1].childType,typeDefinition:e[1].childTypeDefinition,linkDirection:e[1].direction})))}isParent(t){const{pi:i,pd:s,ci:n,cd:a,fd:r}=this.getRelationVector(t);return a||!s||r?!i||s||n||a||r?null:e.INFERRED:e.DEFINED}hasParents(){return this.getNeighbours().some((t=>{const i=this.isParent(t[1]);return i&&this.plugin.settings.showInferredNodes||i===e.DEFINED}))}getParents(){return this.getNeighbours().filter((t=>{const i=this.isParent(t[1]);return i&&this.plugin.settings.showInferredNodes||i===e.DEFINED})).map((e=>({page:e[1].target,relationType:e[1].parentType,typeDefinition:e[1].parentTypeDefinition,linkDirection:e[1].direction})))}isFriend(t){const{pi:i,pd:s,ci:n,cd:a,fd:r}=this.getRelationVector(t);return r?e.DEFINED:!i||s||!n||a||r?null:e.INFERRED}hasFriends(){return this.getNeighbours().some((t=>{const i=this.isFriend(t[1]);return i&&this.plugin.settings.showInferredNodes||i===e.DEFINED}))}getFriends(){return this.getNeighbours().filter((t=>{const i=this.isFriend(t[1]);return i&&this.plugin.settings.showInferredNodes||i===e.DEFINED})).map((t=>{var i;return{page:t[1].target,relationType:null!==(i=t[1].friendType)&&void 0!==i?i:t[1].parentType===e.DEFINED&&t[1].childType===e.DEFINED?e.DEFINED:e.INFERRED,typeDefinition:t[1].friendTypeDefinition,linkDirection:t[1].direction}}))}getRelationToPage(e){const t=this.neighbours.get(e.path);return t?this.isChild(t)?{type:"child",relationType:t.childType,typeDefinition:t.childTypeDefinition}:this.isParent(t)?{type:"parent",relationType:t.parentType,typeDefinition:t.parentTypeDefinition}:{type:"friend",relationType:t.friendType,typeDefinition:t.friendTypeDefinition}:null}getSiblings(){const t=new Map;return this.getParents().forEach((i=>i.page.getChildren().forEach((i=>{t.has(i.page.path)?i.relationType===e.DEFINED&&(t.get(i.page.path).relationType=e.DEFINED):t.set(i.page.path,i)})))),Array.from(t.values())}}var m={};Object.defineProperty(m,"__esModule",{value:!0});const E=e=>{try{return window.ExcalidrawAutomate.getAPI(e)}catch(e){return console.log({message:"Excalidraw not available",fn:E}),null}};var S=m.getEA=E;const v="ExcaliBrain",w=["base","inferred","file-tree","tag-tree"],b={strokeColor:"#696969FF",strokeWidth:1,strokeStyle:"solid",roughness:0,startArrowHead:"none",endArrowHead:"none",showLabel:!1,fontSize:10,fontFamily:3,textColor:"#ffffffff"},L={prefix:"",backgroundColor:"#00000066",fillStyle:"solid",textColor:"#ffffffff",borderColor:"#00000000",fontSize:20,fontFamily:3,maxLabelLength:30,roughness:0,strokeShaprness:"round",strokeWidth:1,strokeStyle:"solid",padding:10,gateRadius:5,gateOffset:15,gateStrokeColor:"#ffffffff",gateBackgroundColor:"#ffffffff",gateFillStyle:"solid"};var D={JSON_MALFORMED:"Malformed JSON",JSON_MISSING_KEYS:'JSON must have these 3 keys: "parents", "children", "friends"',JSON_VALUES_NOT_STRING_ARRAYS:'Key values must be a non-empty array of strings. e.g. "parents": ["Parent", "Parents", "up"]',EXCALIBRAIN_FILE_NAME:"Filepath of Excalibrain drawing",EXCALIBRAIN_FILE_DESC:"⚠ This file will be overwritten by the plugin. If you stop the script and make changes to the graph, you should rename the file so your edits are preserved, because the next time you initiate ExcaliBrain your edits will be overwritten by the automatically generated ExcaliBrain graph.",HIERARCHY_HEAD:"Ontology",HIERARCHY_DESC:"Enter the Dataview field names separated by comma (,) that you will use to define link directions in your graph.<br>You can also add fields to the ontology on the fly from the markdown editor by typing the new field at the beginning of a paragraph (e.g.: 'Consits of::') and then calling one of the command palette actions to <code>Add dataview field to ontology as PARENT</code>, or <code>as CHILD</code>, or <code>as FRIEND</code>",INFER_NAME:"Infer all implicit relationships as Friend",INFER_DESC:"<b>Toggle On:</b> All implicit links in the document are interpreted as FRIENDS.<br><b>Toggle Off:</b> The following logic is used:<ul><li>A forward link is inferred as a CHILD</li><li>A backlink is inferred as a PARENT</li><li>If files mutually link to each other, they are FRIENDS</li></ul>",PARENTS_NAME:"Parents",CHILDREN_NAME:"Children",FRIENDS_NAME:"Friends",ONTOLOGY_SUGGESTER_NAME:"Ongology Suggester",ONTOLOGY_SUGGESTER_DESC:"Activate ontology suggester in the markdown editor. If enabled then typing the trigger sequence at the beginning of a paragraph will activate the suggester listing your ontology fields defined above.",ONTOLOGY_SUGGESTER_PARENT_NAME:"Character sequence to trigger parent suggester",ONTOLOGY_SUGGESTER_CHILD_NAME:"Character sequence to trigger child suggester",ONTOLOGY_SUGGESTER_FRIEND_NAME:"Character sequence to trigger friend suggester",DISPLAY_HEAD:"Display",EXCLUDE_PATHLIST_NAME:"Filepaths to exclude",EXCLUDE_PATHLIST_DESC:"Enter comma-separated list of filepaths to exclude from the index.",RENDERALIAS_NAME:"Display alias if available",RENDERALIAS_DESC:"Displays the page alias instead of the filename if it is specified in the page's front matter.",NODETITLE_SCRIPT_NAME:"Javascript for rendering node names",NODETITLE_SCRIPT_DESC:"Javascript code to render the node title. If you don't need it, just leave this field empty.<br>Function definition: <code>customNodeLabel: (dvPage: Literal, defaultName:string) => string</code><br>In your script you may refer to the dataview page object via the <code>dvPage</code> variable; and the default page name (filename or alias if available) via the <code>defaultName</code> variable. Use the following expression syntax:<br><code>dvPage['field 1']??defaultName</code> - this example will display the vaule of 'field 1' if available else the defaultName<br>⚠ Your line of code will be executed as is, make sure you add proper exception handling. Beyond <code>defaultName</code> and dataview field names, you also have the freedom to use any javascript function (e.g. <code>defaultName.toLowerCase()</code>) and any value that appears on the <code>dvPage</code> object, e.g. <code>dvPage.file.path</code>, etc. <br> To explore the dataview page object open Developer Console and enter the following code:<br><code>DataviewAPI.page('full filepath including extension')</code><br>Here's an example code that will display the value of the title field if available, else the filename, followed by the state (if available): <br><code>dvPage.title??defaultName & (dvPage.state ? ' - ' & dvPage.state : '')</code>",SHOWINFERRED_NAME:"Display inferred relationships",SHOWINFERRED_DESC:"<b>Toggle ON</b>: Display both explicitly defined and inferred links. Forward links are children, backlinks are parents, if two page mutually referes to one another then relationship is inferred to be a friendship. Explicitly defined relationships always take priority.<br><b>Toggle OFF</b>: Display only explicitely defined relationships.",SHOWVIRTUAL_NAME:"Display virtual child nodes",SHOWVIRTUAL_DESC:"<b>Toggle ON</b>: Display unresolved links.<br><b>Toggle OFF</b>: Do not display unresolved links.",SHOWATTACHMENTS_NAME:"Include attachments",SHOWATTACHMENTS_DESC:"<b>Toggle ON</b>: Display every type of file on the graph. <br><b>Toggle OFF</b>: Display only markdown files.",STYLE_HEAD:"Styling",STYLE_DESC:"Styles are applied in sequence.<br><ol><li><b>Base</b> node style</li><li><b>Inferred</b> node style (only applied if the node is inferred)</li><li><b>Virtual</b> node style (only applied if the node is virtual)</li> <li><b>Central</b> node style (only applied if the node is in the center)</li><li><b>Sibling</b> node style (only applied if the node is a sibling)</li> <li><b>Attachment</b> node style (only applied if the node is an attachment)</li><li><b>Optional</b> tag based style</li></ol>All the attributes of the base node style must be specified. All other styles may have partial definitions. e.g. You may add a prefix and override the base node-background color in the tag-based style, override the font color in the inferred-node style and set the border stroke style to dotted in the virtual-node style.",CANVAS_BGCOLOR:"Canvas color",TAGLIST_NAME:"Formatted tags",TAGLIST_DESC:"You can specify special formatting rules for Nodes based on tags. If multiple tags are present on the page the first matching a specification will be used. <br>Tagnames should start with <mark>#</mark> and may be incomplete. i.e. <code>#book</code> will match #books, #book/fiction, etc.<br>Enter a comma separated list of tags here, then select from the dropdown list to change the formatting.",MAX_ITEMCOUNT_DESC:"Maximum node count",MAX_ITEMCOUNT_NAME:"Maximum number of nodes to display in a given area of the layout.i.e. the maximum number of parents, the maximum number of children, the maximum number of friends, and the maximum number of siblings to display. If there are more items, they will be ommitted from the drawing.",NODESTYLE_INCLUDE_TOGGLE:"Toggle ON: override base node style for this attribute; OFF: apply base node style for this attribute",NODESTYLE_PREFIX_NAME:"Prefix",NODESTYLE_PREFIX_DESC:"Prefix character or emoji to display in front of the node's label",NODESTYLE_BGCOLOR:"Background color",NODESTYLE_BG_FILLSTYLE:"Bacground fill-style",NODESTYLE_TEXTCOLOR:"Text color",NODESTYLE_BORDERCOLOR:"Border color",NODESTYLE_FONTSIZE:"Font size",NODESTYLE_FONTFAMILY:"Font family",NODESTYLE_MAXLABELLENGTH_NAME:"Max label length",NODESTYLE_MAXLABELLENGTH_DESC:"Maximum number of characters to display from node title. Longer nodes will end with '...'",NODESTYLE_ROUGHNESS:"Stroke roughness",NODESTYLE_SHARPNESS:"Stroke sharpness",NODESTYLE_STROKEWIDTH:"Stroke width",NODESTYLE_STROKESTYLE:"Stroke style",NODESTYLE_RECTANGLEPADDING:"Padding of the node rectangle",NODESTYLE_GATE_RADIUS_NAME:"Gate radius",NODESTYLE_GATE_RADIUS_DESC:"The radius of the 3 small circles (alias: gates) serving as connection points for nodes",NODESTYLE_GATE_OFFSET_NAME:"Gate offset",NODESTYLE_GATE_OFFSET_DESC:"The offset to the left and right of the parent and child gates.",NODESTYLE_GATE_COLOR:"Gate border color",NODESTYLE_GATE_BGCOLOR_NAME:"Gate background color",NODESTYLE_GATE_BGCOLOR_DESC:"The fill color of the gate if it has children",NODESTYLE_GATE_FILLSTYLE:"Gate background fill-style",NODESTYLE_BASE:"Base node style",NODESTYLE_CENTRAL:"Style of central node",NODESTYLE_INFERRED:"Style of inferred nodes",NODESTYLE_VIRTUAL:"Style of virtual nodes",NODESTYLE_SIBLING:"Style of sibling nodes",NODESTYLE_ATTACHMENT:"Style of attachment nodes",NODESTYLE_FOLDER:"Style of folder nodes",NODESTYLE_TAG:"Style of tag nodes",LINKSTYLE_COLOR:"Color",LINKSTYLE_WIDTH:"Width",LINKSTYLE_STROKE:"Stroke style",LINKSTYLE_ROUGHNESS:"Roughness",LINKSTYLE_ARROWSTART:"Start arrow head",LINKSTYLE_ARROWEND:"End arrow head",LINKSTYLE_SHOWLABEL:"Show label on link",LINKSTYLE_FONTSIZE:"Label font size",LINKSTYLE_FONTFAMILY:"Label font family",LINKSTYLE_BASE:"Base link style",LINKSTYLE_INFERRED:"Style of inferred link",LINKSTYLE_FOLDER:"Style of folder link",LINKSTYLE_TAG:"Style of tag link",DATAVIEW_NOT_FOUND:`Dataview plugin not found. Please install or enable Dataview then try restarting ${v}.`,DATAVIEW_UPGRADE:`Please upgrade Dataview to 0.5.31 or newer. Please update Dataview then try restarting ${v}.`,EXCALIDRAW_NOT_FOUND:`Excalidraw plugin not found. Please install or enable Excalidraw then try restarting ${v}.`,EXCALIDRAW_MINAPP_VERSION:`ExcaliBrain requires Excalidraw 1.6.33 or higher. Please upgrade Excalidraw then try restarting ${v}.`,COMMAND_ADD_PARENT_FIELD:"Add dataview field to ontology as PARENT",COMMAND_ADD_CHILD_FIELD:"Add dataview field to ontology as CHILD",COMMAND_ADD_FRIEND_FIELD:"Add dataview field to ontology as FRIEND",COMMAND_START:"ExcaliBrain Normal",COMMAND_START_HOVER:"ExcaliBrain Hover-Editor",COMMAND_STOP:"Stop ExcaliBrain",HOVER_EDITOR_ERROR:"I am sorry. Something went wrong. Most likely there was a version update to Hover Editor which I haven't addressed properly in ExcaliBrain. Normally I should get this fixed within few days",OPEN_DRAWING:"Save snapshot for editing",SEARCH_IN_VAULT:"Starred items will be listed in empty search.\nSearch for a file, a folder or a tag in your Vault.\nToggle folders and tags on/off to show in the list.",SHOW_HIDE_ATTACHMENTS:"Show/Hide attachments",SHOW_HIDE_VIRTUAL:"Show/Hide virtual nodes",SHOW_HIDE_INFERRED:"Show/Hide inferred nodes",SHOW_HIDE_ALIAS:"Show/Hide document alias",SHOW_HIDE_SIBLINGS:"Show/Hide siblings",SHOW_HIDE_FOLDER:"Show/Hide folder nodes",SHOW_HIDE_TAG:"Show/Hide tag nodes",SHOW_HIDE_PAGES:"Show/Hide page nodes (incl. defined, inferred, virtual and attachments)",PIN_LEAF:"Link ExcaliBrain to most recent active leaf"};const T={en:D}[s.moment.locale()];function N(e){return T||h({fn:N,where:"src/lang/helpers.ts",message:"Error: locale not found",data:s.moment.locale()}),T&&T[e]||D[e]}class O extends s.Modal{constructor(e,t,i){super(e),this.title=t,this.message=i}onOpen(){this.createForm()}onClose(){}createForm(){this.titleEl.setText(this.title),this.contentEl.createDiv({cls:"excalibrain-prompt-center",text:this.message}),this.contentEl.createDiv({cls:"excalibrain-prompt-center"},(e=>{e.style.textAlign="right",e.createEl("button",{text:"Ok"}).onclick=()=>{this.resolve(!0),this.close()},e.createEl("button",{text:"Cancel"}).onclick=()=>{this.resolve(!1),this.close()}}))}show(e){this.resolve=e,this.open()}}class C{constructor(e){this.style={},this.center={x:0,y:0},this.page=e.page,this.settings=e.page.plugin.settings,this.ea=e.page.plugin.EA,this.page.isFolder?this.style=Object.assign(Object.assign(Object.assign(Object.assign({},this.settings.baseNodeStyle),e.isCentral?this.settings.centralNodeStyle:{}),e.isSibling?this.settings.siblingNodeStyle:{}),this.settings.folderNodeStyle):this.page.isTag?this.style=Object.assign(Object.assign(Object.assign(Object.assign({},this.settings.baseNodeStyle),e.isCentral?this.settings.centralNodeStyle:{}),e.isSibling?this.settings.siblingNodeStyle:{}),this.settings.tagNodeStyle):this.style=Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},this.settings.baseNodeStyle),e.isInferred?this.settings.inferredNodeStyle:{}),e.page.isVirtual?this.settings.virtualNodeStyle:{}),e.isCentral?this.settings.centralNodeStyle:{}),e.isSibling?this.settings.siblingNodeStyle:{}),e.page.isAttachment?this.settings.attachmentNodeStyle:{}),l(this.page.primaryStyleTag,this.settings)),this.friendGateOnLeft=e.friendGateOnLeft,this.title=this.page.getTitle()}displayText(){var e;const t=(null!==(e=this.style.prefix)&&void 0!==e?e:"")+this.title;return t.length>this.style.maxLabelLength?t.substring(0,this.style.maxLabelLength-1)+"...":t}setCenter(e){this.center=e}render(){var e,t;const i=this.ea,s=this.displayText();i.style.fontSize=this.style.fontSize,i.style.fontFamily=this.style.fontFamily;const n=i.measureText(s);i.style.fillStyle=this.style.fillStyle,i.style.roughness=this.style.roughness,i.style.strokeSharpness=this.style.strokeShaprness,i.style.strokeWidth=this.style.strokeWidth,i.style.strokeColor=this.style.textColor,i.style.backgroundColor="transparent",this.id=i.addText(this.center.x-n.width/2,this.center.y-n.height/2,s,{wrapAt:this.style.maxLabelLength+5,textAlign:"center",box:!0,boxPadding:this.style.padding});const a=i.getElement(this.id);a.link=`[[${null!==(t=null===(e=this.page.file)||void 0===e?void 0:e.path)&&void 0!==t?t:this.page.path}]]`,a.backgroundColor=this.style.backgroundColor,a.strokeColor=this.style.borderColor,a.strokeStyle=this.style.strokeStyle,i.style.fillStyle=this.style.gateFillStyle,i.style.strokeColor=this.style.gateStrokeColor,i.style.strokeStyle="solid",i.style.backgroundColor=this.page.hasFriends()?this.style.gateBackgroundColor:"transparent",this.friendGateId=i.addEllipse(this.friendGateOnLeft?this.center.x-2*this.style.gateRadius-this.style.padding-n.width/2:this.center.x+this.style.padding+n.width/2,this.center.y-this.style.gateRadius,2*this.style.gateRadius,2*this.style.gateRadius),i.style.backgroundColor=this.page.hasParents()?this.style.gateBackgroundColor:"transparent",this.parentGateId=i.addEllipse(this.center.x-this.style.gateRadius-this.style.gateOffset,this.center.y-2*this.style.gateRadius-this.style.padding-n.height/2,2*this.style.gateRadius,2*this.style.gateRadius),i.style.backgroundColor=this.page.hasChildren()?this.style.gateBackgroundColor:"transparent",this.childGateId=i.addEllipse(this.center.x-this.style.gateRadius+this.style.gateOffset,this.center.y+this.style.padding+n.height/2,2*this.style.gateRadius,2*this.style.gateRadius),i.addToGroup([this.friendGateId,this.parentGateId,this.childGateId,this.id,a.boundElements[0].id])}}class I{constructor(t,i,s,n,a,r,o,l){this.nodeA=t,this.nodeB=i,this.nodeBRole=s,this.hierarchyDefinition=a,this.ea=r,this.isInferred=!1;const h=null==a?void 0:a.split(",").map((e=>e.trim()));this.isInferred=n===e.INFERRED;let d={};h&&h.forEach((e=>{if(l.hierarchyLinkStylesExtended[e])d=Object.assign(Object.assign({},d),l.hierarchyLinkStylesExtended[e]);else switch(e){case"file-tree":d=Object.assign(Object.assign({},d),l.settings.folderLinkStyle);break;case"tag-tree":d=Object.assign(Object.assign({},d),l.settings.tagLinkStyle)}})),this.style=Object.assign(Object.assign(Object.assign({},o.baseLinkStyle),this.isInferred?o.inferredLinkStyle:{}),d)}render(e){const i=this.ea,s=this.style;let n,a;switch(i.style.strokeStyle=s.strokeStyle,i.style.roughness=s.roughness,i.style.strokeColor=s.strokeColor,i.style.strokeWidth=s.strokeWidth,i.style.opacity=e?10:100,this.nodeBRole){case t.CHILD:n=this.nodeA.childGateId,a=this.nodeB.parentGateId;break;case t.PARENT:n=this.nodeA.parentGateId,a=this.nodeB.childGateId;break;default:n=this.nodeA.friendGateId,a=this.nodeB.friendGateId}const r=i.connectObjects(n,null,a,null,{startArrowHead:"none"===s.startArrowHead?null:s.startArrowHead,endArrowHead:"none"===s.endArrowHead?null:s.endArrowHead});s.showLabel&&this.hierarchyDefinition&&(i.style.fontSize=s.fontSize,i.style.fontFamily=s.fontFamily,i.style.strokeColor=s.textColor,i.addLabelToLine(r,this.hierarchyDefinition))}}const x={excalibrainFilepath:"excalibrain.md",hierarchy:{parents:["Parent","Parents","up","u"],children:["Children","Child","down","d"],friends:["Friends","Friend","Jump","Jumps","j"]},inferAllLinksAsFriends:!1,renderAlias:!0,nodeTitleScript:"",backgroundColor:"#0c3e6aff",excludeFilepaths:[],showInferredNodes:!0,showAttachments:!0,showVirtualNodes:!0,showFolderNodes:!1,showTagNodes:!1,showPageNodes:!0,maxItemCount:30,renderSiblings:!0,baseNodeStyle:L,centralNodeStyle:{fontSize:30,backgroundColor:"#C49A13FF",textColor:"#000000ff"},inferredNodeStyle:{backgroundColor:"#000005b3",textColor:"#95c7f3ff"},virtualNodeStyle:{backgroundColor:"#ff000066",fillStyle:"hachure",textColor:"#ffffffff"},siblingNodeStyle:{fontSize:15},attachmentNodeStyle:{prefix:"📎 "},folderNodeStyle:{prefix:"📂 ",strokeShaprness:"sharp",borderColor:"#ffd700ff",textColor:"#ffd700ff"},tagNodeStyle:{prefix:"#",strokeShaprness:"sharp",borderColor:"#4682b4ff",textColor:"#4682b4ff"},tagNodeStyles:{},tagStyleList:[],baseLinkStyle:b,inferredLinkStyle:{strokeStyle:"dashed"},folderLinkStyle:{strokeColor:"#ffd700ff"},tagLinkStyle:{strokeColor:"#4682b4ff"},hierarchyLinkStyles:{},navigationHistory:[],allowOntologySuggester:!0,ontologySuggesterParentTrigger:"::p",ontologySuggesterChildTrigger:"::c",ontologySuggesterFriendTrigger:"::f"},A="excalibrain-settings-disabled",k=e=>(255*e|256).toString(16).slice(1),F=e=>createFragment((t=>t.createDiv().innerHTML=e)),R=e=>{const t=document.getElementById(e);if(!t)return;const i=t.parentNode;i&&i.removeChild(t)},_=(e,t)=>{const i=document.createElement("style");i.id=e,i.innerHTML=`.${t} {display: none;}`,document.body.appendChild(i)};class P extends s.PluginSettingTab{constructor(e,t){super(e,t),this.dirty=!1,this.plugin=t}get hierarchyStyleList(){return w.concat(Array.from(this.plugin.settings.hierarchy.parents)).concat(Array.from(this.plugin.settings.hierarchy.children)).concat(Array.from(this.plugin.settings.hierarchy.friends))}async updateNodeDemoImg(){this.ea.reset(),this.ea.canvas.viewBackgroundColor=this.plugin.settings.backgroundColor,this.demoNode.style=Object.assign(Object.assign({},this.demoNodeStyle.getInheritedStyle()),this.demoNodeStyle.style),this.demoNode.render();const e=await this.ea.createSVG(null,!0,{withBackground:!0,withTheme:!1},null,"",40);e.removeAttribute("width"),e.removeAttribute("height"),this.demoNodeImg.setAttribute("src",d(e.outerHTML))}async updateLinkDemoImg(){this.ea.reset(),this.ea.canvas.viewBackgroundColor=this.plugin.settings.backgroundColor;const s=new y(null,"Start node",null,this.plugin),n=new y(null,"End node",null,this.plugin),a=this.plugin.settings.hierarchy;a.friends.contains(this.demoLinkStyle.display)?(s.addFriend(n,e.DEFINED,i.FROM),n.addFriend(s,e.DEFINED,i.TO)):a.parents.contains(this.demoLinkStyle.display)?(s.addParent(n,e.DEFINED,i.FROM),n.addChild(s,e.DEFINED,i.TO)):(s.addChild(n,e.DEFINED,i.FROM),n.addParent(s,e.DEFINED,i.TO));const r=new C({page:s,isInferred:!1,isCentral:!0,isSibling:!1,friendGateOnLeft:!0});r.ea=this.ea,r.setCenter({x:0,y:0});const o=new C({page:n,isInferred:!1,isCentral:!1,isSibling:!1,friendGateOnLeft:!1});o.ea=this.ea;let l=t.CHILD;a.friends.contains(this.demoLinkStyle.display)?(o.setCenter({x:-300,y:0}),l=t.FRIEND):a.parents.contains(this.demoLinkStyle.display)?(o.setCenter({x:0,y:-150}),l=t.PARENT):o.setCenter({x:0,y:150});const h=new I(r,o,l,e.DEFINED,"base",this.ea,this.plugin.settings,this.plugin);r.style=Object.assign(Object.assign({},this.plugin.settings.baseNodeStyle),this.plugin.settings.centralNodeStyle),r.render(),o.style=Object.assign(Object.assign({},this.demoNodeStyle.getInheritedStyle()),this.demoNodeStyle.style),o.render(),h.style=Object.assign(Object.assign({},this.demoLinkStyle.getInheritedStyle()),this.demoLinkStyle.style),h.render(!1);const c=await this.ea.createSVG(null,!0,{withBackground:!0,withTheme:!1},null,"",40);c.removeAttribute("width"),c.removeAttribute("height"),this.demoLinkImg.setAttribute("src",d(c.outerHTML))}async hide(){var e;this.dirty&&(""===this.plugin.settings.ontologySuggesterParentTrigger&&(this.plugin.settings.ontologySuggesterParentTrigger="::p"),""===this.plugin.settings.ontologySuggesterChildTrigger&&(this.plugin.settings.ontologySuggesterChildTrigger="::c"),""===this.plugin.settings.ontologySuggesterFriendTrigger&&(this.plugin.settings.ontologySuggesterFriendTrigger="::c"),this.plugin.setHierarchyLinkStylesExtended(),this.plugin.settings.tagStyleList=Object.keys(this.plugin.settings.tagNodeStyles),this.plugin.loadCustomNodeLabelFunction(),this.plugin.saveSettings(),null===(e=this.plugin.scene)||void 0===e||e.reRender())}colorpicker(e,t,i,n,a,r,o,l){let h,d,c,g,p,u;const f=new s.Setting(e).setName(t);i&&f.setDesc(F(i));const y=e=>{e?f.settingEl.addClass(A):f.settingEl.removeClass(A),d.disabled=e,d.style.opacity=e?"0.3":"1",h.setDisabled(e),h.sliderEl.style.opacity=e?"0.3":"1",g.style.opacity=e?"0.3":"1",p.style.opacity=e?"0.3":"1",u.style.opacity=e?"0.3":"1"};o&&f.addToggle((e=>{c=e,e.toggleEl.addClass("excalibrain-settings-toggle"),e.setValue(void 0!==n()).setTooltip(N("NODESTYLE_INCLUDE_TOGGLE")).onChange((e=>{if(this.dirty=!0,!e)return y(!0),void r();a(d.value+k(h.getValue())),y(!1)}))})),f.settingEl.removeClass("mod-toggle"),g=createEl("span",{text:"color:",cls:"excalibrain-settings-colorlabel"}),f.controlEl.appendChild(g),d=createEl("input",{type:"color",cls:"excalibrain-settings-colorpicker"},(e=>{var t;e.value=(null!==(t=n())&&void 0!==t?t:l).substring(0,7),e.onchange=()=>{a(e.value+k(h.getValue()))}})),f.controlEl.appendChild(d),p=createEl("span",{text:"opacity:",cls:"excalibrain-settings-opacitylabel"}),f.controlEl.appendChild(p),f.addSlider((e=>{var t,i;h=e,e.setLimits(0,1,.1).setValue((i=null!==(t=n())&&void 0!==t?t:l,parseInt(i.substring(7,9),16)/255)).onChange((e=>{a(d.value+k(e)),u.innerText=` ${e.toString()}`,d.style.opacity=e.toString()}))})),u=createDiv({text:`${h.getValue().toString()}`,cls:"excalibrain-settings-sliderlabel"}),f.controlEl.appendChild(u),d.style.opacity=h.getValue().toString(),y(o&&!c.getValue())}numberslider(e,t,i,n,a,r,o,l,h){let d,c,g;const p=new s.Setting(e).setName(t),u=e=>{e?p.settingEl.addClass(A):p.settingEl.removeClass(A),g.setDisabled(e),g.sliderEl.style.opacity=e?"0.3":"1",d.style.opacity=e?"0.3":"1"};l&&p.addToggle((e=>{c=e,e.toggleEl.addClass("excalibrain-settings-toggle"),e.setValue(void 0!==a()).setTooltip(N("NODESTYLE_INCLUDE_TOGGLE")).onChange((e=>{if(this.dirty=!0,!e)return u(!0),void o();r(g.getValue()),u(!1)}))})),p.addSlider((e=>{var t;g=e,e.setLimits(n.min,n.max,n.step).setValue(null!==(t=a())&&void 0!==t?t:h).onChange((async e=>{d.innerText=` ${e.toString()}`,r(e),this.dirty=!0}))})),i&&p.setDesc(F(i)),p.settingEl.createDiv("",(e=>{d=e,e.style.minWidth="2.3em",e.style.textAlign="right",e.innerText=` ${g.getValue().toString()}`})),u(l&&!c.getValue())}toggle(e,t,i,n,a,r,o,l){let h,d;const c=new s.Setting(e).setName(t),g=e=>{e?c.settingEl.addClass(A):c.settingEl.removeClass(A),d.setDisabled(e),d.toggleEl.style.opacity=e?"0.3":"1"};o&&c.addToggle((e=>{h=e,e.toggleEl.addClass("excalibrain-settings-toggle"),e.setValue(void 0!==n()).setTooltip(N("NODESTYLE_INCLUDE_TOGGLE")).onChange((e=>{if(this.dirty=!0,!e)return g(!0),void r();a(d.getValue()),g(!1)}))})),c.addToggle((e=>{var t;d=e,e.setValue(null!==(t=n())&&void 0!==t?t:l).onChange((async e=>{a(e),this.dirty=!0}))})),i&&c.setDesc(F(i)),g(o&&!h.getValue())}dropdownpicker(e,t,i,n,a,r,o,l,h){let d,c;const g=new s.Setting(e).setName(t),p=e=>{e?g.settingEl.addClass(A):g.settingEl.removeClass(A),d.setDisabled(e),d.selectEl.style.opacity=e?"0.3":"1"};l&&g.addToggle((e=>{c=e,e.toggleEl.addClass("excalibrain-settings-toggle"),e.setValue(void 0!==a()).setTooltip(N("NODESTYLE_INCLUDE_TOGGLE")).onChange((e=>{if(this.dirty=!0,!e)return p(!0),void o();r(d.getValue()),p(!1)}))})),g.addDropdown((e=>{var t;d=e,e.addOptions(n).setValue(null!==(t=a())&&void 0!==t?t:h).onChange((e=>{r(e),this.dirty=!0}))})),i&&g.setDesc(F(i)),p(l&&!c.getValue())}nodeSettings(e,t,i=!0,n){let a,r;const o=new s.Setting(e).setName(N("NODESTYLE_PREFIX_NAME")).setDesc(F(N("NODESTYLE_PREFIX_DESC"))),l=e=>{e?o.settingEl.addClass(A):o.settingEl.removeClass(A),a.setDisabled(e),a.inputEl.style.opacity=e?"0.3":"1"};i&&o.addToggle((e=>{r=e,e.toggleEl.addClass("excalibrain-settings-toggle"),e.setValue(void 0!==t.prefix).setTooltip(N("NODESTYLE_INCLUDE_TOGGLE")).onChange((e=>{if(this.dirty=!0,!e)return l(!0),t.prefix=void 0,void this.updateNodeDemoImg();l(!1)}))})),o.addText((e=>{var i;a=e,e.setValue(null!==(i=t.prefix)&&void 0!==i?i:n.prefix).onChange((e=>{t.prefix=e,this.updateNodeDemoImg(),this.dirty=!0}))})),l(i&&!r.getValue()),this.colorpicker(e,N("NODESTYLE_BGCOLOR"),null,(()=>t.backgroundColor),(e=>{t.backgroundColor=e,this.updateNodeDemoImg()}),(()=>{delete t.backgroundColor,this.updateNodeDemoImg()}),i,n.backgroundColor),this.dropdownpicker(e,N("NODESTYLE_BG_FILLSTYLE"),null,{hachure:"Hachure","cross-hatch":"Cross-hatch",solid:"Solid"},(()=>{var e;return null===(e=t.fillStyle)||void 0===e?void 0:e.toString()}),(e=>{t.fillStyle=e,this.updateNodeDemoImg()}),(()=>{delete t.fillStyle,this.updateNodeDemoImg()}),i,n.fillStyle.toString()),this.colorpicker(e,N("NODESTYLE_TEXTCOLOR"),null,(()=>t.textColor),(e=>{t.textColor=e,this.updateNodeDemoImg()}),(()=>{delete t.textColor,this.updateNodeDemoImg()}),i,n.textColor),this.colorpicker(e,N("NODESTYLE_BORDERCOLOR"),null,(()=>t.borderColor),(e=>{t.borderColor=e,this.updateNodeDemoImg()}),(()=>{delete t.borderColor,this.updateNodeDemoImg()}),i,n.borderColor),this.numberslider(e,N("NODESTYLE_FONTSIZE"),null,{min:10,max:50,step:5},(()=>t.fontSize),(e=>{t.fontSize=e,this.updateNodeDemoImg()}),(()=>{delete t.fontSize,this.updateNodeDemoImg()}),i,n.fontSize),this.dropdownpicker(e,N("NODESTYLE_FONTFAMILY"),null,{1:"Hand-drawn",2:"Normal",3:"Code",4:"Fourth (custom) Font"},(()=>{var e;return null===(e=t.fontFamily)||void 0===e?void 0:e.toString()}),(e=>{t.fontFamily=parseInt(e),this.updateNodeDemoImg()}),(()=>{delete t.fontFamily,this.updateNodeDemoImg()}),i,n.fontFamily.toString()),this.numberslider(e,N("NODESTYLE_MAXLABELLENGTH_NAME"),N("NODESTYLE_MAXLABELLENGTH_DESC"),{min:15,max:100,step:5},(()=>t.maxLabelLength),(e=>{t.maxLabelLength=e,this.updateNodeDemoImg()}),(()=>{delete t.maxLabelLength,this.updateNodeDemoImg()}),i,n.maxLabelLength),this.dropdownpicker(e,N("NODESTYLE_ROUGHNESS"),null,{0:"Architect",1:"Artist",2:"Cartoonist"},(()=>{var e;return null===(e=t.roughness)||void 0===e?void 0:e.toString()}),(e=>{t.roughness=parseInt(e),this.updateNodeDemoImg()}),(()=>{delete t.roughness,this.updateNodeDemoImg()}),i,n.roughness.toString()),this.dropdownpicker(e,N("NODESTYLE_SHARPNESS"),null,{sharp:"Sharp",round:"Round"},(()=>t.strokeShaprness),(e=>{t.strokeShaprness=e,this.updateNodeDemoImg()}),(()=>{delete t.strokeShaprness,this.updateNodeDemoImg()}),i,n.strokeShaprness),this.numberslider(e,N("NODESTYLE_STROKEWIDTH"),null,{min:.5,max:6,step:.5},(()=>t.strokeWidth),(e=>{t.strokeWidth=e,this.updateNodeDemoImg()}),(()=>{delete t.strokeWidth,this.updateNodeDemoImg()}),i,n.strokeWidth),this.dropdownpicker(e,N("NODESTYLE_STROKESTYLE"),null,{solid:"Solid",dashed:"Dashed",dotted:"Dotted"},(()=>t.strokeStyle),(e=>{t.strokeStyle=e,this.updateNodeDemoImg()}),(()=>{delete t.strokeStyle,this.updateNodeDemoImg()}),i,n.strokeStyle),this.numberslider(e,N("NODESTYLE_RECTANGLEPADDING"),null,{min:5,max:50,step:5},(()=>t.padding),(e=>{t.padding=e,this.updateNodeDemoImg()}),(()=>{delete t.padding,this.updateNodeDemoImg()}),i,n.padding),this.numberslider(e,N("NODESTYLE_GATE_RADIUS_NAME"),N("NODESTYLE_GATE_RADIUS_DESC"),{min:3,max:10,step:1},(()=>t.gateRadius),(e=>{t.gateRadius=e,this.updateNodeDemoImg()}),(()=>{delete t.gateRadius,this.updateNodeDemoImg()}),i,n.gateRadius),this.numberslider(e,N("NODESTYLE_GATE_OFFSET_NAME"),N("NODESTYLE_GATE_OFFSET_DESC"),{min:0,max:25,step:1},(()=>t.gateOffset),(e=>{t.gateOffset=e,this.updateNodeDemoImg()}),(()=>{delete t.gateOffset,this.updateNodeDemoImg()}),i,n.gateOffset),this.colorpicker(e,N("NODESTYLE_GATE_COLOR"),null,(()=>t.gateStrokeColor),(e=>{t.gateStrokeColor=e,this.updateNodeDemoImg()}),(()=>{delete t.gateStrokeColor,this.updateNodeDemoImg()}),i,n.gateStrokeColor),this.colorpicker(e,N("NODESTYLE_GATE_BGCOLOR_NAME"),N("NODESTYLE_GATE_BGCOLOR_DESC"),(()=>t.gateBackgroundColor),(e=>{t.gateBackgroundColor=e,this.updateNodeDemoImg()}),(()=>{delete t.gateBackgroundColor,this.updateNodeDemoImg()}),i,n.gateBackgroundColor),this.dropdownpicker(e,N("NODESTYLE_GATE_FILLSTYLE"),null,{hachure:"Hachure","cross-hatch":"Cross-hatch",solid:"Solid"},(()=>{var e;return null===(e=t.gateFillStyle)||void 0===e?void 0:e.toString()}),(e=>{t.gateFillStyle=e,this.updateNodeDemoImg()}),(()=>{delete t.gateFillStyle,this.updateNodeDemoImg()}),i,n.gateFillStyle.toString())}linkSettings(e,t,i=!0,s){this.colorpicker(e,N("LINKSTYLE_COLOR"),null,(()=>t.strokeColor),(e=>{t.strokeColor=e,this.updateLinkDemoImg()}),(()=>{delete t.strokeColor,this.updateLinkDemoImg()}),i,s.strokeColor),this.numberslider(e,N("LINKSTYLE_WIDTH"),null,{min:.5,max:10,step:.5},(()=>t.strokeWidth),(e=>{t.strokeWidth=e,this.updateLinkDemoImg()}),(()=>{delete t.strokeWidth,this.updateLinkDemoImg()}),i,s.strokeWidth),this.dropdownpicker(e,N("LINKSTYLE_ROUGHNESS"),null,{0:"Architect",1:"Artist",2:"Cartoonist"},(()=>{var e;return null===(e=t.roughness)||void 0===e?void 0:e.toString()}),(e=>{t.roughness=parseInt(e),this.updateLinkDemoImg()}),(()=>{delete t.roughness,this.updateLinkDemoImg()}),i,s.roughness.toString()),this.dropdownpicker(e,N("LINKSTYLE_STROKE"),null,{solid:"Solid",dashed:"Dashed",dotted:"Dotted"},(()=>t.strokeStyle),(e=>{t.strokeStyle=e,this.updateLinkDemoImg()}),(()=>{delete t.strokeStyle,this.updateLinkDemoImg()}),i,s.strokeStyle),this.dropdownpicker(e,N("LINKSTYLE_ARROWSTART"),null,{none:"None",arrow:"Arrow",bar:"Bar",dot:"Dot",triangle:"Triangle"},(()=>t.startArrowHead),(e=>{t.startArrowHead=""===e?null:e,this.updateLinkDemoImg()}),(()=>{delete t.startArrowHead,this.updateLinkDemoImg()}),i,s.startArrowHead),this.dropdownpicker(e,N("LINKSTYLE_ARROWEND"),null,{none:"None",arrow:"Arrow",bar:"Bar",dot:"Dot",triangle:"Triangle"},(()=>t.endArrowHead),(e=>{t.endArrowHead=""===e?null:e,this.updateLinkDemoImg()}),(()=>{delete t.endArrowHead,this.updateLinkDemoImg()}),i,s.endArrowHead),this.toggle(e,N("LINKSTYLE_SHOWLABEL"),null,(()=>t.showLabel),(e=>{t.showLabel=e,this.updateLinkDemoImg()}),(()=>{delete t.showLabel,this.updateLinkDemoImg()}),i,s.showLabel),this.colorpicker(e,N("NODESTYLE_TEXTCOLOR"),null,(()=>t.textColor),(e=>{t.textColor=e,this.updateLinkDemoImg()}),(()=>{delete t.textColor,this.updateLinkDemoImg()}),i,s.textColor),this.numberslider(e,N("LINKSTYLE_FONTSIZE"),null,{min:6,max:30,step:3},(()=>t.fontSize),(e=>{t.fontSize=e,this.updateLinkDemoImg()}),(()=>{delete t.fontSize,this.updateLinkDemoImg()}),i,s.fontSize),this.dropdownpicker(e,N("LINKSTYLE_FONTFAMILY"),null,{1:"Hand-drawn",2:"Normal",3:"Code",4:"Fourth (custom) Font"},(()=>{var e;return null===(e=t.fontFamily)||void 0===e?void 0:e.toString()}),(e=>{t.fontFamily=parseInt(e),this.updateLinkDemoImg()}),(()=>{delete t.fontFamily,this.updateLinkDemoImg()}),i,s.fontFamily.toString())}async display(){const t=this.plugin.settings.navigationHistory;await this.plugin.loadSettings(),this.plugin.settings.navigationHistory=t,this.ea=S();const n=new y(null,"This is a demo node that is 46 characters long",null,this.plugin),a=new y(null,"This is a child node",null,this.plugin);n.addChild(a,e.DEFINED,i.FROM),a.addParent(n,e.DEFINED,i.TO),this.demoNode=new C({page:n,isInferred:!1,isCentral:!1,isSibling:!1,friendGateOnLeft:!0}),this.demoNode.ea=this.ea,this.demoNode.setCenter({x:0,y:0});const{containerEl:r}=this;this.containerEl.empty();const o=r.createDiv("coffee");o.addClass("ex-coffee-div"),o.createEl("a",{href:"https://ko-fi.com/zsolt"}).createEl("img",{attr:{src:"https://cdn.ko-fi.com/cdn/kofi3.png?v=3"}}).height=45,new s.Setting(r).setName(N("EXCALIBRAIN_FILE_NAME")).setDesc(F(N("EXCALIBRAIN_FILE_DESC"))).addText((e=>e.setValue(this.plugin.settings.excalibrainFilepath).onChange((t=>{this.dirty=!0,t.endsWith(".md")||(t+=t.endsWith(".m")?"d":t.endsWith(".")?"md":".md"),this.app.vault.getAbstractFileByPath(t)?new O(this.app,"⚠ File Exists",`${t} already exists in your Vault. Is it ok to overwrite this file?`).show((i=>{i&&(this.plugin.settings.excalibrainFilepath=t,this.dirty=!0,e.inputEl.value=t)})):(this.plugin.settings.excalibrainFilepath=t,this.dirty=!0)})).inputEl.onblur=()=>{e.setValue(this.plugin.settings.excalibrainFilepath)})),this.containerEl.createEl("h1",{cls:"excalibrain-settings-h1",text:N("HIERARCHY_HEAD")}),this.containerEl.createEl("p",{}).innerHTML=N("HIERARCHY_DESC");let l,h,d,c=()=>{};new s.Setting(r).setName(N("PARENTS_NAME")).addText((e=>{e.inputEl.style.width="100%",e.setValue(this.plugin.settings.hierarchy.parents.join(", ")).onChange((e=>{this.plugin.settings.hierarchy.parents=e.split(",").map((e=>e.trim())).sort(((e,t)=>e.toLowerCase()<t.toLowerCase()?-1:1)),this.plugin.hierarchyLowerCase.parents=[],this.plugin.settings.hierarchy.parents.forEach((e=>this.plugin.hierarchyLowerCase.parents.push(e.toLowerCase().replaceAll(" ","-")))),c(),this.dirty=!0}))})),new s.Setting(r).setName(N("CHILDREN_NAME")).addText((e=>{e.inputEl.style.width="100%",e.setValue(this.plugin.settings.hierarchy.children.join(", ")).onChange((e=>{this.plugin.settings.hierarchy.children=e.split(",").map((e=>e.trim())).sort(((e,t)=>e.toLowerCase()<t.toLowerCase()?-1:1)),this.plugin.hierarchyLowerCase.children=[],this.plugin.settings.hierarchy.children.forEach((e=>this.plugin.hierarchyLowerCase.children.push(e.toLowerCase().replaceAll(" ","-")))),c(),this.dirty=!0}))})),new s.Setting(r).setName(N("FRIENDS_NAME")).addText((e=>{e.inputEl.style.width="100%",e.setValue(this.plugin.settings.hierarchy.friends.join(", ")).onChange((e=>{this.plugin.settings.hierarchy.friends=e.split(",").map((e=>e.trim())).sort(((e,t)=>e.toLowerCase()<t.toLowerCase()?-1:1)),this.plugin.hierarchyLowerCase.friends=[],this.plugin.settings.hierarchy.friends.forEach((e=>this.plugin.hierarchyLowerCase.friends.push(e.toLowerCase().replaceAll(" ","-")))),c(),this.dirty=!0}))})),new s.Setting(r).setName(N("INFER_NAME")).setDesc(F(N("INFER_DESC"))).addToggle((e=>e.setValue(this.plugin.settings.inferAllLinksAsFriends).onChange((e=>{this.plugin.settings.inferAllLinksAsFriends=e,this.dirty=!0})))),new s.Setting(r).setName(N("ONTOLOGY_SUGGESTER_NAME")).setDesc(N("ONTOLOGY_SUGGESTER_DESC")).addToggle((e=>e.setValue(this.plugin.settings.allowOntologySuggester).onChange((e=>{this.plugin.settings.allowOntologySuggester=e,l.setDisabled(!e),h.setDisabled(!e),d.setDisabled(!e),this.dirty=!0})))),l=new s.Setting(r).setName(N("ONTOLOGY_SUGGESTER_PARENT_NAME")).setDisabled(!this.plugin.settings.allowOntologySuggester).addText((e=>e.setValue(this.plugin.settings.ontologySuggesterParentTrigger).onChange((e=>{this.plugin.settings.ontologySuggesterParentTrigger=e,this.dirty=!0})))),h=new s.Setting(r).setName(N("ONTOLOGY_SUGGESTER_CHILD_NAME")).setDisabled(!this.plugin.settings.allowOntologySuggester).addText((e=>e.setValue(this.plugin.settings.ontologySuggesterChildTrigger).onChange((e=>{this.plugin.settings.ontologySuggesterChildTrigger=e,this.dirty=!0})))),d=new s.Setting(r).setName(N("ONTOLOGY_SUGGESTER_FRIEND_NAME")).setDisabled(!this.plugin.settings.allowOntologySuggester).addText((e=>e.setValue(this.plugin.settings.ontologySuggesterFriendTrigger).onChange((e=>{this.plugin.settings.ontologySuggesterFriendTrigger=e,this.dirty=!0})))),this.containerEl.createEl("h1",{cls:"excalibrain-settings-h1",text:N("DISPLAY_HEAD")});const g=new s.Setting(r).setName(N("EXCLUDE_PATHLIST_NAME")).setDesc(F(N("EXCLUDE_PATHLIST_DESC"))).addTextArea((e=>{e.inputEl.style.height="100px",e.inputEl.style.width="100%",e.setValue(this.plugin.settings.excludeFilepaths.join(", ")).onChange((e=>{const t=(e=e.replaceAll("\n"," ")).split(",").map((e=>e.trim()));this.plugin.settings.excludeFilepaths=t.filter((e=>""!==e)),this.dirty=!0}))}));g.descEl.style.width="90%",g.controlEl.style.width="90%",new s.Setting(r).setName(N("RENDERALIAS_NAME")).setDesc(F(N("RENDERALIAS_DESC"))).addToggle((e=>e.setValue(this.plugin.settings.renderAlias).onChange((e=>{this.plugin.settings.renderAlias=e,this.dirty=!0}))));const p=new s.Setting(r).setName(N("NODETITLE_SCRIPT_NAME")).setDesc(F(N("NODETITLE_SCRIPT_DESC"))).addTextArea((e=>{e.inputEl.style.height="200px",e.inputEl.style.width="100%",e.setValue(this.plugin.settings.nodeTitleScript).onChange((e=>{this.plugin.settings.nodeTitleScript=e,this.dirty=!0}))}));let u,f;p.descEl.style.width="90%",p.controlEl.style.width="90%",new s.Setting(r).setName(N("SHOWINFERRED_NAME")).setDesc(F(N("SHOWINFERRED_DESC"))).addToggle((e=>e.setValue(this.plugin.settings.showInferredNodes).onChange((e=>{this.plugin.settings.showInferredNodes=e,this.dirty=!0})))),new s.Setting(r).setName(N("SHOWATTACHMENTS_NAME")).setDesc(F(N("SHOWATTACHMENTS_DESC"))).addToggle((e=>e.setValue(this.plugin.settings.showAttachments).onChange((e=>{this.plugin.settings.showAttachments=e,this.dirty=!0})))),new s.Setting(r).setName(N("SHOWVIRTUAL_NAME")).setDesc(F(N("SHOWVIRTUAL_DESC"))).addToggle((e=>e.setValue(this.plugin.settings.showVirtualNodes).onChange((e=>{this.plugin.settings.showVirtualNodes=e,this.dirty=!0})))),this.numberslider(r,N("MAX_ITEMCOUNT_NAME"),N("MAX_ITEMCOUNT_DESC"),{min:5,max:150,step:5},(()=>this.plugin.settings.maxItemCount),(e=>this.plugin.settings.maxItemCount=e),(()=>{}),!1,30),r.createEl("h1",{cls:"excalibrain-settings-h1",text:N("STYLE_HEAD")}),this.containerEl.createEl("p",{}).innerHTML=N("STYLE_DESC"),this.colorpicker(r,N("CANVAS_BGCOLOR"),null,(()=>this.plugin.settings.backgroundColor),(e=>{this.plugin.settings.backgroundColor=e,this.updateNodeDemoImg()}),(()=>{}),!1,this.plugin.settings.backgroundColor);const m=e=>{f.empty();const t=this.plugin.nodeStyles[e];this.nodeSettings(f,t.style,t.allowOverride,t.getInheritedStyle()),this.demoNodeStyle=t,this.updateNodeDemoImg()},E=new s.Setting(r).setName(N("TAGLIST_NAME")).setDesc(N("TAGLIST_DESC")).addTextArea((e=>{e.inputEl.style.height="200px",e.inputEl.style.width="100%",e.setValue(this.plugin.settings.tagStyleList.sort(((e,t)=>e.toLowerCase()<t.toLowerCase()?-1:1)).join(", ")).onChange((e=>{const t=this.plugin.settings.tagNodeStyles,i=this.plugin.nodeStyles,s=(e=e.replaceAll("\n"," ")).split(",").map((e=>e.trim())).sort(((e,t)=>e.toLocaleLowerCase()<t.toLocaleLowerCase()?-1:1));this.plugin.settings.tagStyleList=s,Object.keys(t).forEach((e=>{s.contains(e)||(delete t[e],delete i[e])})),s.forEach((e=>{Object.keys(t).contains(e)||(t[e]={},i[e]={style:t[e],allowOverride:!0,userStyle:!0,display:e,getInheritedStyle:()=>this.plugin.settings.baseNodeStyle})}));const n=u.getValue();for(let e=u.selectEl.options.length-1;e>=0;e--)u.selectEl.remove(e);Object.entries(i).forEach((e=>{u.addOption(e[0],e[1].display)})),i[n]?u.setValue(n):(u.setValue("base"),m("base")),this.dirty=!0}))}));E.descEl.style.width="90%",E.controlEl.style.width="90%";const v=r.createDiv({cls:"setting-item"}),b=v.createDiv({cls:"setting-item-info"});let L;u=new s.DropdownComponent(b),v.createDiv({text:"Show inherited",cls:"setting-item-name"}).style.marginRight="10px";let D=!1;const T=new s.ToggleComponent(v);T.setValue(!0).setTooltip("Show/Hide Inherited Properties").onChange((e=>{D?D=!1:(e?R("excalibrain-hide-disabled"):_("excalibrain-hide-disabled",A),D=!0,L.setValue(e))})),Object.entries(this.plugin.nodeStyles).forEach((e=>{u.addOption(e[0],e[1].display)})),this.demoNodeImg=r.createEl("img",{cls:"excalibrain-settings-demoimg"}),f=r.createDiv({cls:"excalibrain-setting-style-section"}),R("excalibrain-hide-disabled"),u.setValue("base").onChange(m);const I=this.plugin.nodeStyles.base;let x,k;this.nodeSettings(f,I.style,I.allowOverride,I.getInheritedStyle()),this.demoNodeStyle=I,this.updateNodeDemoImg();const P=e=>{k.empty();const t=this.plugin.linkStyles[e];this.linkSettings(k,t.style,t.allowOverride,t.getInheritedStyle()),this.demoLinkStyle=t,this.updateLinkDemoImg()},H=r.createDiv({cls:"setting-item"}),M=H.createDiv({cls:"setting-item-info"});x=new s.DropdownComponent(M),H.createDiv({text:"Show inherited",cls:"setting-item-name"}).style.marginRight="10px",L=new s.ToggleComponent(H),L.setValue(!0).setTooltip("Show/Hide Inherited Properties").onChange((e=>{D?D=!1:(e?R("excalibrain-hide-disabled"):_("excalibrain-hide-disabled",A),D=!0,T.setValue(e))})),Object.entries(this.plugin.linkStyles).forEach((e=>{x.addOption(e[0],e[1].display)})),this.demoLinkImg=r.createEl("img",{cls:"excalibrain-settings-demoimg"}),k=r.createDiv({cls:"excalibrain-setting-nodestyle-section"}),x.setValue("base").onChange(P);const V=this.plugin.linkStyles.base;this.linkSettings(k,V.style,V.allowOverride,V.getInheritedStyle()),this.demoLinkStyle=V,this.updateLinkDemoImg(),c=()=>{const e=this.plugin.settings.hierarchyLinkStyles,t=this.plugin.linkStyles;Object.keys(t).forEach((i=>{w.contains(i)||this.hierarchyStyleList.contains(i)||(delete t[i],delete e[i])})),this.hierarchyStyleList.forEach((i=>{Object.keys(e).contains(i)||w.contains(i)||(e[i]={},t[i]={style:e[i],allowOverride:!0,userStyle:!0,display:i,getInheritedStyle:()=>this.plugin.settings.baseLinkStyle})}));const i=x.getValue();for(let e=x.selectEl.options.length-1;e>=0;e--)x.selectEl.remove(e);const s=this.plugin.settings.hierarchy,n=e=>w.includes(e)?"0"+e.toLowerCase():s.parents.includes(e)?"1"+e.toLowerCase():s.children.includes(e)?"2"+e.toLowerCase():"3"+e.toLowerCase();Object.entries(t).sort(((e,t)=>n(e[0])<n(t[0])?-1:1)).forEach((e=>{x.addOption(e[0],this.plugin.settings.hierarchy.parents.includes(e[1].display)?"Parent > "+e[1].display:this.plugin.settings.hierarchy.children.includes(e[1].display)?"Child > "+e[1].display:this.plugin.settings.hierarchy.friends.includes(e[1].display)?"Friend > "+e[1].display:e[1].display)})),t[i]?x.setValue(i):(x.setValue("base"),P("base"))},c()}}var H={};Object.defineProperty(H,"__esModule",{value:!0});var M=H.getAPI=e=>{var t;return e?null===(t=e.plugins.plugins.dataview)||void 0===t?void 0:t.api:window.DataviewAPI};H.isPluginEnabled=e=>e.plugins.enabledPlugins.has("dataview");class V{constructor(e){this.pages=new Map,this.forEach=this.pages.forEach.bind(this.pages),this.app=e.app,this.plugin=e}add(e,t){this.pages.set(e,t)}has(e){return this.pages.has(e)}get(e){return this.pages.get(e)}getPages(){return Array.from(this.pages.values())}get size(){return this.pages.size}delete(e){const t=this.pages.get(e);t&&(t.neighbours.forEach(((t,i)=>{const s=this.pages.get(i);s&&(s.unlinkNeighbour(e),s.file||0!==s.neighbours.size||this.pages.delete(i))})),this.pages.delete(e))}addResolvedLinks(t){const s=this.app.metadataCache.resolvedLinks;Object.keys(s).forEach((n=>{if(t&&t.path!==n)return;const a=this.pages.get(n);Object.keys(s[n]).forEach((t=>{const s=this.pages.get(t);this.plugin.settings.inferAllLinksAsFriends?(s.addFriend(a,e.INFERRED,i.FROM),a.addFriend(s,e.INFERRED,i.TO)):(s.addParent(a,e.INFERRED,i.FROM),a.addChild(s,e.INFERRED,i.TO))}))}))}addUnresolvedLinks(t){if(t&&(t.isFolder||t.isTag))return;const s=this.app.metadataCache.unresolvedLinks;Object.keys(s).forEach((n=>{if(t&&t.path!==n)return;const a=this.pages.get(n);n!==this.plugin.settings.excalibrainFilepath&&Object.keys(s[n]).forEach((t=>{var s;const n=null!==(s=this.get(t))&&void 0!==s?s:new y(this,t,null,this.plugin);this.plugin.settings.inferAllLinksAsFriends?(n.addFriend(a,e.INFERRED,i.FROM),a.addFriend(n,e.INFERRED,i.TO)):(n.addParent(a,e.INFERRED,i.FROM),a.addChild(n,e.INFERRED,i.TO)),this.add(t,n)}))}))}}const G=`---\n\nexcalidraw-plugin: parsed\nexcalidraw-default-mode: view\nexcalidraw-export-dark: false\nexcalidraw-export-transparent: false\nexcalidraw-linkbutton-opacity: 0.3\nexcalidraw-onload-script: "app.plugins.plugins[${String.fromCharCode(96)}excalibrain${String.fromCharCode(96)}].start(ea.targetView.leaf);"\n\ntags: [excalidraw]\n\n---\n\n# Text Elements\nOpen a document in another pane and click it to get started.\n\nFor the best experience enable 'Open in adjacent pane'\nin Excalidraw settings under 'Links and Transclusion'. ^4mylk7KK\n\n%%\n# Drawing\n${String.fromCharCode(96,96,96)}json\n{\n\t"type": "excalidraw",\n\t"version": 2,\n\t"source": "https://excalidraw.com",\n\t"elements": [\n\t\t{\n\t\t\t"type": "text",\n\t\t\t"version": 1,\n\t\t\t"versionNonce": 423577018,\n\t\t\t"isDeleted": false,\n\t\t\t"id": "4mylk7KK",\n\t\t\t"fillStyle": "hachure",\n\t\t\t"strokeWidth": 1,\n\t\t\t"strokeStyle": "solid",\n\t\t\t"roughness": 1,\n\t\t\t"opacity": 100,\n\t\t\t"angle": 0,\n\t\t\t"x": 0,\n\t\t\t"y": 0,\n\t\t\t"strokeColor": "white",\n\t\t\t"backgroundColor": "transparent",\n\t\t\t"width": 703,\n\t\t\t"height": 96,\n\t\t\t"seed": 4429,\n\t\t\t"groupIds": [],\n\t\t\t"strokeSharpness": "sharp",\n\t\t\t"boundElements": [],\n\t\t\t"updated": 1650784785611,\n\t\t\t"link": null,\n\t\t\t"locked": false,\n\t\t\t"fontSize": 20,\n\t\t\t"fontFamily": 3,\n\t\t\t"text": "Open a document in another pane and click it to get started.\\n\\nFor the best experience enable 'Open in adjacent pane'\\nin Excalidraw settings under 'Links and Transclusion'.",\n\t\t\t"rawText": "Open a document in another pane and click it to get started.\\n\\nFor the best experience enable 'Open in adjacent pane'\\nin Excalidraw settings under 'Links and Transclusion'.",\n\t\t\t"baseline": 91,\n\t\t\t"textAlign": "center",\n\t\t\t"verticalAlign": "top",\n\t\t\t"containerId": null,\n\t\t\t"originalText": "Open a document in another pane and click it to get started.\\n\\nFor the best experience enable 'Open in adjacent pane'\\nin Excalidraw settings under 'Links and Transclusion'."\n\t\t}\n\t],\n\t"appState": {\n\t\t"theme": "dark",\n\t\t"viewBackgroundColor": "hsl(208, 80%, 23%)",\n\t\t"currentItemStrokeColor": "#000000",\n\t\t"currentItemBackgroundColor": "transparent",\n\t\t"currentItemFillStyle": "hachure",\n\t\t"currentItemStrokeWidth": 2,\n\t\t"currentItemStrokeStyle": "solid",\n\t\t"currentItemRoughness": 1,\n\t\t"currentItemOpacity": 100,\n\t\t"currentItemFontFamily": 1,\n\t\t"currentItemFontSize": 16,\n\t\t"currentItemTextAlign": "left",\n\t\t"currentItemStrokeSharpness": "sharp",\n\t\t"currentItemStartArrowhead": null,\n\t\t"currentItemEndArrowhead": "arrow",\n\t\t"currentItemLinearStrokeSharpness": "round",\n\t\t"gridSize": null,\n\t\t"colorPalette": {}\n\t},\n\t"files": {}\n}\n${String.fromCharCode(96,96,96)}\n%%\n`;class W{constructor(e){this.nodes=[],this.renderedNodes=[],this.spec=e}layout(e=this.spec.columns){const t=this.nodes.sort(((e,t)=>e.title.toLowerCase()<t.title.toLowerCase()?-1:1)),i=t.length;if(0===i)return;const s=Math.ceil(i/e);this.renderedNodes=Array(s).fill(null).map(((n,a)=>{return a+1<s||i%e==0?Array(e).fill(null).map(((i,s)=>t[a*e+s])):(r=i%e,(e=>{const t=[];let i=1,s=!0;return e.map((e=>Math.floor(e))).forEach((e=>{for(let n=0;n<e;n++)t.push(s?null:i++);s=!s})),t})(r%2?[(e-r)/2,r,(e-r)/2]:[(e-r)/2,r/2,1,r/2,(e-r)/2])).map((i=>i?t[a*e+i-1]:null));var r}))}render(){this.layout();const e=this.renderedNodes.length*this.spec.rowHeight,t=null===this.spec.top&&null===this.spec.bottom?this.spec.origoY-e/2:null!==this.spec.top?this.spec.origoY-e/2<this.spec.top?this.spec.top:this.spec.origoY-e/2:this.spec.origoY+e/2>this.spec.bottom?this.spec.bottom-e:this.spec.origoY-e/2,i=this.spec.origoX-(1===this.spec.columns?0:(this.spec.columns-1)/2*this.spec.columnWidth),s=t;this.renderedNodes.forEach(((e,t)=>e.forEach(((e,n)=>{e&&(e.setCenter({x:i+n*this.spec.columnWidth,y:s+t*this.spec.rowHeight}),e.render())}))))}}class Y{constructor(e){this.plugin=e,this.links=new Map,this.reverseLinks=new Set}addLink(e,s,n,a,r,o,l,h){const d=e.page.path+"|:?:|"+s.page.path;if(this.links.has(d)||this.reverseLinks.has(d))return;const c=s.page.path+"|:?:|"+e.page.path,g=new I(o===i.FROM?s:e,o===i.FROM?e:s,o===i.FROM?n===t.FRIEND?t.FRIEND:n===t.CHILD?t.PARENT:t.CHILD:n,a,r,l,h,this.plugin);this.links.set(d,g),this.reverseLinks.add(c)}render(e){this.links.forEach((t=>t.render(e.some((e=>{var i;return null===(i=t.hierarchyDefinition)||void 0===i?void 0:i.includes(e)}))||t.isInferred&&e.includes("inferred-link"))))}}class B{constructor(e,t,i,s,n,a=!0){this.getVal=t,this.updateIndex=a,this.button=s.createEl("button",{cls:"excalibrain-button"}),this.button.createSpan({text:n.display}),this.button.ariaLabel=n.tooltip,this.setColor(),this.button.onclick=()=>{var s;i(!t()),e.saveSettings(),this.setColor(),null===(s=e.scene)||void 0===s||s.reRender(this.updateIndex)}}setColor(){if(this.getVal())return this.button.removeClass("off"),void this.button.addClass("on");this.button.removeClass("on"),this.button.addClass("off")}}var j="top",U="bottom",z="right",K="left",X=[j,U,z,K],$=X.reduce((function(e,t){return e.concat([t+"-start",t+"-end"])}),[]),q=[].concat(X,["auto"]).reduce((function(e,t){return e.concat([t,t+"-start",t+"-end"])}),[]),J=["beforeRead","read","afterRead","beforeMain","main","afterMain","beforeWrite","write","afterWrite"];function Z(e){return e?(e.nodeName||"").toLowerCase():null}function Q(e){if(null==e)return window;if("[object Window]"!==e.toString()){var t=e.ownerDocument;return t&&t.defaultView||window}return e}function ee(e){return e instanceof Q(e).Element||e instanceof Element}function te(e){return e instanceof Q(e).HTMLElement||e instanceof HTMLElement}function ie(e){return"undefined"!=typeof ShadowRoot&&(e instanceof Q(e).ShadowRoot||e instanceof ShadowRoot)}var se={name:"applyStyles",enabled:!0,phase:"write",fn:function(e){var t=e.state;Object.keys(t.elements).forEach((function(e){var i=t.styles[e]||{},s=t.attributes[e]||{},n=t.elements[e];te(n)&&Z(n)&&(Object.assign(n.style,i),Object.keys(s).forEach((function(e){var t=s[e];!1===t?n.removeAttribute(e):n.setAttribute(e,!0===t?"":t)})))}))},effect:function(e){var t=e.state,i={popper:{position:t.options.strategy,left:"0",top:"0",margin:"0"},arrow:{position:"absolute"},reference:{}};return Object.assign(t.elements.popper.style,i.popper),t.styles=i,t.elements.arrow&&Object.assign(t.elements.arrow.style,i.arrow),function(){Object.keys(t.elements).forEach((function(e){var s=t.elements[e],n=t.attributes[e]||{},a=Object.keys(t.styles.hasOwnProperty(e)?t.styles[e]:i[e]).reduce((function(e,t){return e[t]="",e}),{});te(s)&&Z(s)&&(Object.assign(s.style,a),Object.keys(n).forEach((function(e){s.removeAttribute(e)})))}))}},requires:["computeStyles"]};function ne(e){return e.split("-")[0]}var ae=Math.max,re=Math.min,oe=Math.round;function le(e,t){void 0===t&&(t=!1);var i=e.getBoundingClientRect(),s=1,n=1;if(te(e)&&t){var a=e.offsetHeight,r=e.offsetWidth;r>0&&(s=oe(i.width)/r||1),a>0&&(n=oe(i.height)/a||1)}return{width:i.width/s,height:i.height/n,top:i.top/n,right:i.right/s,bottom:i.bottom/n,left:i.left/s,x:i.left/s,y:i.top/n}}function he(e){var t=le(e),i=e.offsetWidth,s=e.offsetHeight;return Math.abs(t.width-i)<=1&&(i=t.width),Math.abs(t.height-s)<=1&&(s=t.height),{x:e.offsetLeft,y:e.offsetTop,width:i,height:s}}function de(e,t){var i=t.getRootNode&&t.getRootNode();if(e.contains(t))return!0;if(i&&ie(i)){var s=t;do{if(s&&e.isSameNode(s))return!0;s=s.parentNode||s.host}while(s)}return!1}function ce(e){return Q(e).getComputedStyle(e)}function ge(e){return["table","td","th"].indexOf(Z(e))>=0}function pe(e){return((ee(e)?e.ownerDocument:e.document)||window.document).documentElement}function ue(e){return"html"===Z(e)?e:e.assignedSlot||e.parentNode||(ie(e)?e.host:null)||pe(e)}function fe(e){return te(e)&&"fixed"!==ce(e).position?e.offsetParent:null}function ye(e){for(var t=Q(e),i=fe(e);i&&ge(i)&&"static"===ce(i).position;)i=fe(i);return i&&("html"===Z(i)||"body"===Z(i)&&"static"===ce(i).position)?t:i||function(e){var t=-1!==navigator.userAgent.toLowerCase().indexOf("firefox");if(-1!==navigator.userAgent.indexOf("Trident")&&te(e)&&"fixed"===ce(e).position)return null;var i=ue(e);for(ie(i)&&(i=i.host);te(i)&&["html","body"].indexOf(Z(i))<0;){var s=ce(i);if("none"!==s.transform||"none"!==s.perspective||"paint"===s.contain||-1!==["transform","perspective"].indexOf(s.willChange)||t&&"filter"===s.willChange||t&&s.filter&&"none"!==s.filter)return i;i=i.parentNode}return null}(e)||t}function me(e){return["top","bottom"].indexOf(e)>=0?"x":"y"}function Ee(e,t,i){return ae(e,re(t,i))}function Se(e){return Object.assign({},{top:0,right:0,bottom:0,left:0},e)}function ve(e,t){return t.reduce((function(t,i){return t[i]=e,t}),{})}var we={name:"arrow",enabled:!0,phase:"main",fn:function(e){var t,i=e.state,s=e.name,n=e.options,a=i.elements.arrow,r=i.modifiersData.popperOffsets,o=ne(i.placement),l=me(o),h=[K,z].indexOf(o)>=0?"height":"width";if(a&&r){var d=function(e,t){return Se("number"!=typeof(e="function"==typeof e?e(Object.assign({},t.rects,{placement:t.placement})):e)?e:ve(e,X))}(n.padding,i),c=he(a),g="y"===l?j:K,p="y"===l?U:z,u=i.rects.reference[h]+i.rects.reference[l]-r[l]-i.rects.popper[h],f=r[l]-i.rects.reference[l],y=ye(a),m=y?"y"===l?y.clientHeight||0:y.clientWidth||0:0,E=u/2-f/2,S=d[g],v=m-c[h]-d[p],w=m/2-c[h]/2+E,b=Ee(S,w,v),L=l;i.modifiersData[s]=((t={})[L]=b,t.centerOffset=b-w,t)}},effect:function(e){var t=e.state,i=e.options.element,s=void 0===i?"[data-popper-arrow]":i;null!=s&&("string"!=typeof s||(s=t.elements.popper.querySelector(s)))&&de(t.elements.popper,s)&&(t.elements.arrow=s)},requires:["popperOffsets"],requiresIfExists:["preventOverflow"]};function be(e){return e.split("-")[1]}var Le={top:"auto",right:"auto",bottom:"auto",left:"auto"};function De(e){var t,i=e.popper,s=e.popperRect,n=e.placement,a=e.variation,r=e.offsets,o=e.position,l=e.gpuAcceleration,h=e.adaptive,d=e.roundOffsets,c=e.isFixed,g=r.x,p=void 0===g?0:g,u=r.y,f=void 0===u?0:u,y="function"==typeof d?d({x:p,y:f}):{x:p,y:f};p=y.x,f=y.y;var m=r.hasOwnProperty("x"),E=r.hasOwnProperty("y"),S=K,v=j,w=window;if(h){var b=ye(i),L="clientHeight",D="clientWidth";b===Q(i)&&"static"!==ce(b=pe(i)).position&&"absolute"===o&&(L="scrollHeight",D="scrollWidth"),b=b,(n===j||(n===K||n===z)&&"end"===a)&&(v=U,f-=(c&&b===w&&w.visualViewport?w.visualViewport.height:b[L])-s.height,f*=l?1:-1),n!==K&&(n!==j&&n!==U||"end"!==a)||(S=z,p-=(c&&b===w&&w.visualViewport?w.visualViewport.width:b[D])-s.width,p*=l?1:-1)}var T,N=Object.assign({position:o},h&&Le),O=!0===d?function(e){var t=e.x,i=e.y,s=window.devicePixelRatio||1;return{x:oe(t*s)/s||0,y:oe(i*s)/s||0}}({x:p,y:f}):{x:p,y:f};return p=O.x,f=O.y,l?Object.assign({},N,((T={})[v]=E?"0":"",T[S]=m?"0":"",T.transform=(w.devicePixelRatio||1)<=1?"translate("+p+"px, "+f+"px)":"translate3d("+p+"px, "+f+"px, 0)",T)):Object.assign({},N,((t={})[v]=E?f+"px":"",t[S]=m?p+"px":"",t.transform="",t))}var Te={passive:!0},Ne={left:"right",right:"left",bottom:"top",top:"bottom"};function Oe(e){return e.replace(/left|right|bottom|top/g,(function(e){return Ne[e]}))}var Ce={start:"end",end:"start"};function Ie(e){return e.replace(/start|end/g,(function(e){return Ce[e]}))}function xe(e){var t=Q(e);return{scrollLeft:t.pageXOffset,scrollTop:t.pageYOffset}}function Ae(e){return le(pe(e)).left+xe(e).scrollLeft}function ke(e){var t=ce(e),i=t.overflow,s=t.overflowX,n=t.overflowY;return/auto|scroll|overlay|hidden/.test(i+n+s)}function Fe(e){return["html","body","#document"].indexOf(Z(e))>=0?e.ownerDocument.body:te(e)&&ke(e)?e:Fe(ue(e))}function Re(e,t){var i;void 0===t&&(t=[]);var s=Fe(e),n=s===(null==(i=e.ownerDocument)?void 0:i.body),a=Q(s),r=n?[a].concat(a.visualViewport||[],ke(s)?s:[]):s,o=t.concat(r);return n?o:o.concat(Re(ue(r)))}function _e(e){return Object.assign({},e,{left:e.x,top:e.y,right:e.x+e.width,bottom:e.y+e.height})}function Pe(e,t){return"viewport"===t?_e(function(e){var t=Q(e),i=pe(e),s=t.visualViewport,n=i.clientWidth,a=i.clientHeight,r=0,o=0;return s&&(n=s.width,a=s.height,/^((?!chrome|android).)*safari/i.test(navigator.userAgent)||(r=s.offsetLeft,o=s.offsetTop)),{width:n,height:a,x:r+Ae(e),y:o}}(e)):ee(t)?function(e){var t=le(e);return t.top=t.top+e.clientTop,t.left=t.left+e.clientLeft,t.bottom=t.top+e.clientHeight,t.right=t.left+e.clientWidth,t.width=e.clientWidth,t.height=e.clientHeight,t.x=t.left,t.y=t.top,t}(t):_e(function(e){var t,i=pe(e),s=xe(e),n=null==(t=e.ownerDocument)?void 0:t.body,a=ae(i.scrollWidth,i.clientWidth,n?n.scrollWidth:0,n?n.clientWidth:0),r=ae(i.scrollHeight,i.clientHeight,n?n.scrollHeight:0,n?n.clientHeight:0),o=-s.scrollLeft+Ae(e),l=-s.scrollTop;return"rtl"===ce(n||i).direction&&(o+=ae(i.clientWidth,n?n.clientWidth:0)-a),{width:a,height:r,x:o,y:l}}(pe(e)))}function He(e){var t,i=e.reference,s=e.element,n=e.placement,a=n?ne(n):null,r=n?be(n):null,o=i.x+i.width/2-s.width/2,l=i.y+i.height/2-s.height/2;switch(a){case j:t={x:o,y:i.y-s.height};break;case U:t={x:o,y:i.y+i.height};break;case z:t={x:i.x+i.width,y:l};break;case K:t={x:i.x-s.width,y:l};break;default:t={x:i.x,y:i.y}}var h=a?me(a):null;if(null!=h){var d="y"===h?"height":"width";switch(r){case"start":t[h]=t[h]-(i[d]/2-s[d]/2);break;case"end":t[h]=t[h]+(i[d]/2-s[d]/2)}}return t}function Me(e,t){void 0===t&&(t={});var i=t,s=i.placement,n=void 0===s?e.placement:s,a=i.boundary,r=void 0===a?"clippingParents":a,o=i.rootBoundary,l=void 0===o?"viewport":o,h=i.elementContext,d=void 0===h?"popper":h,c=i.altBoundary,g=void 0!==c&&c,p=i.padding,u=void 0===p?0:p,f=Se("number"!=typeof u?u:ve(u,X)),y="popper"===d?"reference":"popper",m=e.rects.popper,E=e.elements[g?y:d],S=function(e,t,i){var s="clippingParents"===t?function(e){var t=Re(ue(e)),i=["absolute","fixed"].indexOf(ce(e).position)>=0&&te(e)?ye(e):e;return ee(i)?t.filter((function(e){return ee(e)&&de(e,i)&&"body"!==Z(e)})):[]}(e):[].concat(t),n=[].concat(s,[i]),a=n[0],r=n.reduce((function(t,i){var s=Pe(e,i);return t.top=ae(s.top,t.top),t.right=re(s.right,t.right),t.bottom=re(s.bottom,t.bottom),t.left=ae(s.left,t.left),t}),Pe(e,a));return r.width=r.right-r.left,r.height=r.bottom-r.top,r.x=r.left,r.y=r.top,r}(ee(E)?E:E.contextElement||pe(e.elements.popper),r,l),v=le(e.elements.reference),w=He({reference:v,element:m,strategy:"absolute",placement:n}),b=_e(Object.assign({},m,w)),L="popper"===d?b:v,D={top:S.top-L.top+f.top,bottom:L.bottom-S.bottom+f.bottom,left:S.left-L.left+f.left,right:L.right-S.right+f.right},T=e.modifiersData.offset;if("popper"===d&&T){var N=T[n];Object.keys(D).forEach((function(e){var t=[z,U].indexOf(e)>=0?1:-1,i=[j,U].indexOf(e)>=0?"y":"x";D[e]+=N[i]*t}))}return D}var Ge={name:"flip",enabled:!0,phase:"main",fn:function(e){var t=e.state,i=e.options,s=e.name;if(!t.modifiersData[s]._skip){for(var n=i.mainAxis,a=void 0===n||n,r=i.altAxis,o=void 0===r||r,l=i.fallbackPlacements,h=i.padding,d=i.boundary,c=i.rootBoundary,g=i.altBoundary,p=i.flipVariations,u=void 0===p||p,f=i.allowedAutoPlacements,y=t.options.placement,m=ne(y),E=l||(m!==y&&u?function(e){if("auto"===ne(e))return[];var t=Oe(e);return[Ie(e),t,Ie(t)]}(y):[Oe(y)]),S=[y].concat(E).reduce((function(e,i){return e.concat("auto"===ne(i)?function(e,t){void 0===t&&(t={});var i=t,s=i.placement,n=i.boundary,a=i.rootBoundary,r=i.padding,o=i.flipVariations,l=i.allowedAutoPlacements,h=void 0===l?q:l,d=be(s),c=d?o?$:$.filter((function(e){return be(e)===d})):X,g=c.filter((function(e){return h.indexOf(e)>=0}));0===g.length&&(g=c);var p=g.reduce((function(t,i){return t[i]=Me(e,{placement:i,boundary:n,rootBoundary:a,padding:r})[ne(i)],t}),{});return Object.keys(p).sort((function(e,t){return p[e]-p[t]}))}(t,{placement:i,boundary:d,rootBoundary:c,padding:h,flipVariations:u,allowedAutoPlacements:f}):i)}),[]),v=t.rects.reference,w=t.rects.popper,b=new Map,L=!0,D=S[0],T=0;T<S.length;T++){var N=S[T],O=ne(N),C="start"===be(N),I=[j,U].indexOf(O)>=0,x=I?"width":"height",A=Me(t,{placement:N,boundary:d,rootBoundary:c,altBoundary:g,padding:h}),k=I?C?z:K:C?U:j;v[x]>w[x]&&(k=Oe(k));var F=Oe(k),R=[];if(a&&R.push(A[O]<=0),o&&R.push(A[k]<=0,A[F]<=0),R.every((function(e){return e}))){D=N,L=!1;break}b.set(N,R)}if(L)for(var _=function(e){var t=S.find((function(t){var i=b.get(t);if(i)return i.slice(0,e).every((function(e){return e}))}));if(t)return D=t,"break"},P=u?3:1;P>0&&"break"!==_(P);P--);t.placement!==D&&(t.modifiersData[s]._skip=!0,t.placement=D,t.reset=!0)}},requiresIfExists:["offset"],data:{_skip:!1}};function We(e,t,i){return void 0===i&&(i={x:0,y:0}),{top:e.top-t.height-i.y,right:e.right-t.width+i.x,bottom:e.bottom-t.height+i.y,left:e.left-t.width-i.x}}function Ye(e){return[j,z,U,K].some((function(t){return e[t]>=0}))}function Be(e,t,i){void 0===i&&(i=!1);var s,n,a=te(t),r=te(t)&&function(e){var t=e.getBoundingClientRect(),i=oe(t.width)/e.offsetWidth||1,s=oe(t.height)/e.offsetHeight||1;return 1!==i||1!==s}(t),o=pe(t),l=le(e,r),h={scrollLeft:0,scrollTop:0},d={x:0,y:0};return(a||!a&&!i)&&(("body"!==Z(t)||ke(o))&&(h=(s=t)!==Q(s)&&te(s)?{scrollLeft:(n=s).scrollLeft,scrollTop:n.scrollTop}:xe(s)),te(t)?((d=le(t,!0)).x+=t.clientLeft,d.y+=t.clientTop):o&&(d.x=Ae(o))),{x:l.left+h.scrollLeft-d.x,y:l.top+h.scrollTop-d.y,width:l.width,height:l.height}}function je(e){var t=new Map,i=new Set,s=[];function n(e){i.add(e.name),[].concat(e.requires||[],e.requiresIfExists||[]).forEach((function(e){if(!i.has(e)){var s=t.get(e);s&&n(s)}})),s.push(e)}return e.forEach((function(e){t.set(e.name,e)})),e.forEach((function(e){i.has(e.name)||n(e)})),s}var Ue={placement:"bottom",modifiers:[],strategy:"absolute"};function ze(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return!t.some((function(e){return!(e&&"function"==typeof e.getBoundingClientRect)}))}var Xe,$e=function(e){void 0===e&&(e={});var t=e,i=t.defaultModifiers,s=void 0===i?[]:i,n=t.defaultOptions,a=void 0===n?Ue:n;return function(e,t,i){void 0===i&&(i=a);var n,r,o={placement:"bottom",orderedModifiers:[],options:Object.assign({},Ue,a),modifiersData:{},elements:{reference:e,popper:t},attributes:{},styles:{}},l=[],h=!1,d={state:o,setOptions:function(i){var n="function"==typeof i?i(o.options):i;c(),o.options=Object.assign({},a,o.options,n),o.scrollParents={reference:ee(e)?Re(e):e.contextElement?Re(e.contextElement):[],popper:Re(t)};var r,h,g=function(e){var t=je(e);return J.reduce((function(e,i){return e.concat(t.filter((function(e){return e.phase===i})))}),[])}((r=[].concat(s,o.options.modifiers),h=r.reduce((function(e,t){var i=e[t.name];return e[t.name]=i?Object.assign({},i,t,{options:Object.assign({},i.options,t.options),data:Object.assign({},i.data,t.data)}):t,e}),{}),Object.keys(h).map((function(e){return h[e]}))));return o.orderedModifiers=g.filter((function(e){return e.enabled})),o.orderedModifiers.forEach((function(e){var t=e.name,i=e.options,s=void 0===i?{}:i,n=e.effect;if("function"==typeof n){var a=n({state:o,name:t,instance:d,options:s});l.push(a||function(){})}})),d.update()},forceUpdate:function(){if(!h){var e=o.elements,t=e.reference,i=e.popper;if(ze(t,i)){o.rects={reference:Be(t,ye(i),"fixed"===o.options.strategy),popper:he(i)},o.reset=!1,o.placement=o.options.placement,o.orderedModifiers.forEach((function(e){return o.modifiersData[e.name]=Object.assign({},e.data)}));for(var s=0;s<o.orderedModifiers.length;s++)if(!0!==o.reset){var n=o.orderedModifiers[s],a=n.fn,r=n.options,l=void 0===r?{}:r,c=n.name;"function"==typeof a&&(o=a({state:o,options:l,name:c,instance:d})||o)}else o.reset=!1,s=-1}}},update:(n=function(){return new Promise((function(e){d.forceUpdate(),e(o)}))},function(){return r||(r=new Promise((function(e){Promise.resolve().then((function(){r=void 0,e(n())}))}))),r}),destroy:function(){c(),h=!0}};if(!ze(e,t))return d;function c(){l.forEach((function(e){return e()})),l=[]}return d.setOptions(i).then((function(e){!h&&i.onFirstUpdate&&i.onFirstUpdate(e)})),d}}({defaultModifiers:[{name:"eventListeners",enabled:!0,phase:"write",fn:function(){},effect:function(e){var t=e.state,i=e.instance,s=e.options,n=s.scroll,a=void 0===n||n,r=s.resize,o=void 0===r||r,l=Q(t.elements.popper),h=[].concat(t.scrollParents.reference,t.scrollParents.popper);return a&&h.forEach((function(e){e.addEventListener("scroll",i.update,Te)})),o&&l.addEventListener("resize",i.update,Te),function(){a&&h.forEach((function(e){e.removeEventListener("scroll",i.update,Te)})),o&&l.removeEventListener("resize",i.update,Te)}},data:{}},{name:"popperOffsets",enabled:!0,phase:"read",fn:function(e){var t=e.state,i=e.name;t.modifiersData[i]=He({reference:t.rects.reference,element:t.rects.popper,strategy:"absolute",placement:t.placement})},data:{}},{name:"computeStyles",enabled:!0,phase:"beforeWrite",fn:function(e){var t=e.state,i=e.options,s=i.gpuAcceleration,n=void 0===s||s,a=i.adaptive,r=void 0===a||a,o=i.roundOffsets,l=void 0===o||o,h={placement:ne(t.placement),variation:be(t.placement),popper:t.elements.popper,popperRect:t.rects.popper,gpuAcceleration:n,isFixed:"fixed"===t.options.strategy};null!=t.modifiersData.popperOffsets&&(t.styles.popper=Object.assign({},t.styles.popper,De(Object.assign({},h,{offsets:t.modifiersData.popperOffsets,position:t.options.strategy,adaptive:r,roundOffsets:l})))),null!=t.modifiersData.arrow&&(t.styles.arrow=Object.assign({},t.styles.arrow,De(Object.assign({},h,{offsets:t.modifiersData.arrow,position:"absolute",adaptive:!1,roundOffsets:l})))),t.attributes.popper=Object.assign({},t.attributes.popper,{"data-popper-placement":t.placement})},data:{}},se,{name:"offset",enabled:!0,phase:"main",requires:["popperOffsets"],fn:function(e){var t=e.state,i=e.options,s=e.name,n=i.offset,a=void 0===n?[0,0]:n,r=q.reduce((function(e,i){return e[i]=function(e,t,i){var s=ne(e),n=[K,j].indexOf(s)>=0?-1:1,a="function"==typeof i?i(Object.assign({},t,{placement:e})):i,r=a[0],o=a[1];return r=r||0,o=(o||0)*n,[K,z].indexOf(s)>=0?{x:o,y:r}:{x:r,y:o}}(i,t.rects,a),e}),{}),o=r[t.placement],l=o.x,h=o.y;null!=t.modifiersData.popperOffsets&&(t.modifiersData.popperOffsets.x+=l,t.modifiersData.popperOffsets.y+=h),t.modifiersData[s]=r}},Ge,{name:"preventOverflow",enabled:!0,phase:"main",fn:function(e){var t=e.state,i=e.options,s=e.name,n=i.mainAxis,a=void 0===n||n,r=i.altAxis,o=void 0!==r&&r,l=i.boundary,h=i.rootBoundary,d=i.altBoundary,c=i.padding,g=i.tether,p=void 0===g||g,u=i.tetherOffset,f=void 0===u?0:u,y=Me(t,{boundary:l,rootBoundary:h,padding:c,altBoundary:d}),m=ne(t.placement),E=be(t.placement),S=!E,v=me(m),w="x"===v?"y":"x",b=t.modifiersData.popperOffsets,L=t.rects.reference,D=t.rects.popper,T="function"==typeof f?f(Object.assign({},t.rects,{placement:t.placement})):f,N="number"==typeof T?{mainAxis:T,altAxis:T}:Object.assign({mainAxis:0,altAxis:0},T),O=t.modifiersData.offset?t.modifiersData.offset[t.placement]:null,C={x:0,y:0};if(b){if(a){var I,x="y"===v?j:K,A="y"===v?U:z,k="y"===v?"height":"width",F=b[v],R=F+y[x],_=F-y[A],P=p?-D[k]/2:0,H="start"===E?L[k]:D[k],M="start"===E?-D[k]:-L[k],V=t.elements.arrow,G=p&&V?he(V):{width:0,height:0},W=t.modifiersData["arrow#persistent"]?t.modifiersData["arrow#persistent"].padding:{top:0,right:0,bottom:0,left:0},Y=W[x],B=W[A],X=Ee(0,L[k],G[k]),$=S?L[k]/2-P-X-Y-N.mainAxis:H-X-Y-N.mainAxis,q=S?-L[k]/2+P+X+B+N.mainAxis:M+X+B+N.mainAxis,J=t.elements.arrow&&ye(t.elements.arrow),Z=J?"y"===v?J.clientTop||0:J.clientLeft||0:0,Q=null!=(I=null==O?void 0:O[v])?I:0,ee=F+q-Q,te=Ee(p?re(R,F+$-Q-Z):R,F,p?ae(_,ee):_);b[v]=te,C[v]=te-F}if(o){var ie,se="x"===v?j:K,oe="x"===v?U:z,le=b[w],de="y"===w?"height":"width",ce=le+y[se],ge=le-y[oe],pe=-1!==[j,K].indexOf(m),ue=null!=(ie=null==O?void 0:O[w])?ie:0,fe=pe?ce:le-L[de]-D[de]-ue+N.altAxis,Se=pe?le+L[de]+D[de]-ue-N.altAxis:ge,ve=p&&pe?function(e,t,i){var s=Ee(e,t,i);return s>i?i:s}(fe,le,Se):Ee(p?fe:ce,le,p?Se:ge);b[w]=ve,C[w]=ve-le}t.modifiersData[s]=C}},requiresIfExists:["offset"]},we,{name:"hide",enabled:!0,phase:"main",requiresIfExists:["preventOverflow"],fn:function(e){var t=e.state,i=e.name,s=t.rects.reference,n=t.rects.popper,a=t.modifiersData.preventOverflow,r=Me(t,{elementContext:"reference"}),o=Me(t,{altBoundary:!0}),l=We(r,s),h=We(o,n,a),d=Ye(l),c=Ye(h);t.modifiersData[i]={referenceClippingOffsets:l,popperEscapeOffsets:h,isReferenceHidden:d,hasPopperEscaped:c},t.attributes.popper=Object.assign({},t.attributes.popper,{"data-popper-reference-hidden":d,"data-popper-escaped":c})}}]});class qe{constructor(e,t,i,s=30){this.owner=e,this.containerEl=t,this.limit=s,this.owner=e,this.containerEl=t,t.on("click",".suggestion-item",this.onSuggestionClick.bind(this)),t.on("mousemove",".suggestion-item",this.onSuggestionMouseover.bind(this)),i.register([],"ArrowUp",(e=>{if(!e.isComposing)return this.setSelectedItem(this.selectedItem-1,!0),!1})),i.register([],"ArrowDown",(e=>{if(!e.isComposing)return this.setSelectedItem(this.selectedItem+1,!0),!1})),i.register([],"Enter",(e=>{if(!e.isComposing)return this.useSelectedItem(e),!1}))}onSuggestionClick(e,t){e.preventDefault();const i=this.suggestions.indexOf(t);this.setSelectedItem(i,!1),this.useSelectedItem(e)}onSuggestionMouseover(e,t){const i=this.suggestions.indexOf(t);this.setSelectedItem(i,!1)}setSuggestions(e){this.containerEl.empty();const t=[];e.slice(0,this.limit).forEach((e=>{const i=this.containerEl.createDiv("suggestion-item");this.owner.renderSuggestion(e,i),t.push(i)})),this.values=e,this.suggestions=t,this.setSelectedItem(0,!1)}useSelectedItem(e){const t=this.values[this.selectedItem];t&&this.owner.selectSuggestion(t,e)}setSelectedItem(e,t){const i=(e%(s=this.suggestions.length)+s)%s;var s;const n=this.suggestions[this.selectedItem],a=this.suggestions[i];null==n||n.removeClass("is-selected"),null==a||a.addClass("is-selected"),this.selectedItem=i,t&&a.scrollIntoView(!1)}}!function(e){e[e.TemplateFiles=0]="TemplateFiles",e[e.ScriptFiles=1]="ScriptFiles"}(Xe||(Xe={}));class Je extends class{constructor(e,t,i){this.app=e,this.inputEl=t,this.containerEl=i,this.scope=new s.Scope,this.suggestEl=i.createDiv("suggestion-container");const n=this.suggestEl.createDiv("suggestion");this.suggest=new qe(this,n,this.scope),this.scope.register([],"Escape",this.close.bind(this)),this.inputEl.addEventListener("input",this.onInputChanged.bind(this)),this.inputEl.addEventListener("focus",this.onInputChanged.bind(this)),this.inputEl.addEventListener("blur",this.close.bind(this)),this.suggestEl.on("mousedown",".suggestion-container",(e=>{e.preventDefault()}))}onInputChanged(){const e=this.inputEl.value,t=this.getSuggestions(e);t&&t.length>0?(this.suggest.setSuggestions(t),this.open(this.containerEl,this.inputEl)):this.close()}open(e,t){this.app.keymap.pushScope(this.scope),e.appendChild(this.suggestEl),this.popper=$e(t,this.suggestEl,{placement:"bottom-start",modifiers:[{name:"sameWidth",enabled:!0,fn:({state:e,instance:t})=>{const i=`${e.rects.reference.width}px`;e.styles.popper.width!==i&&(e.styles.popper.width=i,t.update())},phase:"beforeWrite",requires:["computeStyles"]}]})}close(){this.app.keymap.popScope(this.scope),this.suggest.setSuggestions([]),this.popper&&this.popper.destroy(),this.suggestEl.detach()}}{constructor(e,t,i,s){super(e,t,s),this.plugin=i}getSuggestions(e){var t,i,n;if(""===e)return this.plugin.starred;const a=e.toLowerCase(),r=null===(t=this.plugin.pages)||void 0===t?void 0:t.getPages().filter((e=>(!e.file||(this.plugin.settings.showAttachments||"md"===e.file.extension)&&!this.plugin.settings.excludeFilepaths.some((t=>e.path.startsWith(t))))&&(e.file||(this.plugin.settings.showFolderNodes||!e.path.startsWith("folder:"))&&(this.plugin.settings.showTagNodes||!e.path.startsWith("tag:")))&&e.name.toLowerCase().contains(a)));if(r.length>30)return r;const o=r.concat(null===(i=this.plugin.pages)||void 0===i?void 0:i.getPages().filter((e=>!r.contains(e)&&(!e.file||(this.plugin.settings.showAttachments||"md"===e.file.extension)&&!this.plugin.settings.excludeFilepaths.some((t=>e.path.startsWith(t))))&&(e.file||(this.plugin.settings.showFolderNodes||!e.path.startsWith("folder:"))&&(this.plugin.settings.showTagNodes||!e.path.startsWith("tag:")))&&e.path.toLowerCase().contains(a))));if(o.length>30)return o;const l=s.prepareFuzzySearch(e);return o.concat(null===(n=this.plugin.pages)||void 0===n?void 0:n.getPages().filter((e=>!e.isVirtual&&(!e.file||(this.plugin.settings.showAttachments||"md"===e.file.extension)&&!this.plugin.settings.excludeFilepaths.some((t=>e.path.startsWith(t))))&&(e.file||(this.plugin.settings.showFolderNodes||!e.path.startsWith("folder:"))&&(this.plugin.settings.showTagNodes||!e.path.startsWith("tag:")))&&!o.contains(e)&&l(e.path))))}renderSuggestion(e,t){t.ariaLabel=e.path,t.setText(e.isFolder||e.isTag?e.path:e.name)}selectSuggestion(e){this.inputEl.value=e.path,this.inputEl.trigger("input"),this.close()}}var Ze={exports:{}};self,Ze.exports=(()=>{var e={858:(e,t,i)=>{i.r(t)},607:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Multiselect=void 0,i(858);var s=i(86);Object.defineProperty(t,"Multiselect",{enumerable:!0,get:function(){return s.Multiselect}})},51:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MultiselectOption=void 0;var i=function(){function e(e,t,i,s){this.label="",this.selected=!1,this.value=e,this.label=t,this.multiple=i,this.onChange=s,this.createOptionElement(),this.createListeners()}return e.prototype.select=function(e){void 0===e&&(e=!0),this.selected=!0,this.setAttribute(),e&&this.onChange(this)},e.prototype.deselect=function(e){void 0===e&&(e=!0),this.selected=!1,this.setAttribute(),e&&this.onChange(this)},e.prototype.createOptionElement=function(){var e=document.createElement("div");e.classList.add("option"),this.singleSelectTextSpanRef=document.createElement("span"),this.singleSelectTextSpanRef.classList.add("option-text"),this.singleSelectTextSpanRef.innerText=this.label,e.appendChild(this.singleSelectTextSpanRef),e.appendChild(this.createCheckbox()),this.optionRef=e},e.prototype.createCheckbox=function(){var e=document.createElement("label");e.classList.add("checkbox-wrapper");var t=document.createElement("span");t.classList.add("checkbox-text"),t.innerText=this.label;var i=document.createElement("input");i.setAttribute("type","checkbox"),this.checkboxRef=i;var s=document.createElement("span");return s.classList.add("checkbox-checkmark"),e.appendChild(t),e.appendChild(i),e.appendChild(s),e},e.prototype.setAttribute=function(){this.multiple?this.selected?this.checkboxRef.setAttribute("checked","checked"):this.checkboxRef.removeAttribute("checked"):this.selected?this.singleSelectTextSpanRef.classList.add("selected"):this.singleSelectTextSpanRef.classList.remove("selected")},e.prototype.createListeners=function(){var e=this;this.multiple?this.checkboxRef.addEventListener("change",(function(){e.selected=e.checkboxRef.checked,e.onChange(e)})):this.singleSelectTextSpanRef.addEventListener("click",(function(){e.selected=!0,e.onChange(e)}))},e}();t.MultiselectOption=i},86:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Multiselect=void 0;var s=i(51),n=function(){function e(e){var t=this;if(this.options=[],this.dropdownOpened=!1,this.destroyed=!1,this.rendered=!1,this.documentClickDropdownToggle=function(e){t.selectWrapperRef.contains(e.target)||t.handleDropdownToggle(!1,t.dropdownOpened)},this.config=e,this.assignConfig(),this.setOrigin(),!this.origin)throw"You have to pass origin element!";this.init()}return e.prototype.init=function(){this.destroyed=!1,this.dropdownOpened=!1,this.createSelect(),this.createListeners()},e.prototype.destroy=function(){this.destroyed=!0,this.rendered=!1,this.hide(),document.removeEventListener("click",this.documentClickDropdownToggle),this.selectWrapperRef.cloneNode(!0),this.origin=null,this.selectHeaderRef=null,this.selectWrapperRef=null,this.selectedValueRef=null,this.optionsWrapperRef=null,this.options=[]},e.prototype.reset=function(){this.options.forEach((function(e){return e.deselect(!1)})),this.updateSelection()},e.prototype.hide=function(){this.origin.innerHTML="",this.rendered=!1},e.prototype.render=function(){if(this.destroyed)throw"But you destroyed me... :(";if(this.origin.innerText.trim())throw"Hey! I am rendered already!";this.origin.appendChild(this.selectWrapperRef),this.rendered=!0,this.selectHeaderRef&&this.origin.prepend(this.selectHeaderRef)},e.prototype.assignConfig=function(){var e,t;this.id=this.config.id,this.configOptions=this.config.options,this.multiple=null===(e=this.config.multiple)||void 0===e||e,this.singularNominativeLabel=this.config.singularNominativeLabel,this.pluralNominativeLabel=this.config.pluralNominativeLabel,this.pluralGenitiveLabel=this.config.pluralGenitiveLabel,this.placeholder=null!==(t=this.config.placeholder)&&void 0!==t?t:"",this.headerLabel=this.config.headerLabel,this.selected=this.config.selected,this.onDropdownOpen=this.config.onDropdownOpen,this.onDropdownClose=this.config.onDropdownClose,this.onSelectionChange=this.config.onSelectionChange},e.prototype.setOrigin=function(){this.origin=document.querySelector("#"+this.id),this.origin&&this.origin.classList.add("multiselect-container")},e.prototype.createHeader=function(){this.headerLabel&&(this.selectHeaderRef=document.createElement("div"),this.selectHeaderRef.classList.add("multiselect-header"),this.selectHeaderRef.innerText=this.headerLabel)},e.prototype.createSelect=function(){var e=this;this.selectWrapperRef=document.createElement("div"),this.selectWrapperRef.classList.add("multiselect-wrapper"),this.multiple||this.selectWrapperRef.classList.add("single-select"),this.selectedValueRef=document.createElement("div"),this.selectedValueRef.classList.add("selected-value"),this.selectWrapperRef.appendChild(this.selectedValueRef),this.optionsWrapperRef=document.createElement("div"),this.optionsWrapperRef.classList.add("options-wrapper"),this.configOptions.forEach((function(t){var i,n=new s.MultiselectOption(t.value,t.label,e.multiple,e.onSelectChange.bind(e));(null===(i=e.selected)||void 0===i?void 0:i.includes(t.value))&&n.select(!1),e.options.push(n),e.optionsWrapperRef.appendChild(n.optionRef)})),this.updateSelection(),this.selectWrapperRef.appendChild(this.optionsWrapperRef),this.createHeader(),this.render()},e.prototype.createListeners=function(){var e=this;this.selectWrapperRef.addEventListener("click",(function(t){e.selectWrapperRef.contains(t.target)&&!e.optionsWrapperRef.contains(t.target)&&e.handleDropdownToggle(!e.dropdownOpened)})),document.addEventListener("click",this.documentClickDropdownToggle)},e.prototype.handleDropdownToggle=function(e,t){void 0===t&&(t=!0),this.dropdownOpened=e,this.dropdownOpened?(this.selectWrapperRef.classList.add("opened"),this.onDropdownOpen&&t&&this.onDropdownOpen()):(this.selectWrapperRef.classList.remove("opened"),this.onDropdownClose&&t&&this.onDropdownClose(this.selected))},e.prototype.onSelectChange=function(e){this.multiple||(this.options.forEach((function(e){return e.deselect(!1)})),e.select(!1)),this.updateSelection(),this.onSelectionChange&&this.onSelectionChange(this.selected),this.multiple||this.handleDropdownToggle(!1)},e.prototype.updateSelection=function(){this.selected=this.options.filter((function(e){return!!e.selected})).map((function(e){return e.value}));var e=this.options.filter((function(e){return!!e.selected})).map((function(e){return e.label})),t=this.placeholder;1===e.length?t=e[0]:e.length>1&&(t=e.length+" "+this.transformPluralLabel(e.length)),this.selectedValueRef.innerText=t},e.prototype.transformPluralLabel=function(e){var t,i,s;return 1===e?null!==(t=this.singularNominativeLabel)&&void 0!==t?t:"items":e%10>=2&&e%10<=4&&(e%100<10||e%100>=20)?null!==(i=this.pluralNominativeLabel)&&void 0!==i?i:"items":null!==(s=this.pluralGenitiveLabel)&&void 0!==s?s:"items"},e}();t.Multiselect=n}},t={};function i(s){if(t[s])return t[s].exports;var n=t[s]={exports:{}};return e[s](n,n.exports,i),n.exports}return i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i(607)})();class Qe{constructor(e,t){this.plugin=e,this.selectedLinks=new Set,this.selectedTags=new Set,this.isOpen=!1,this.filterDiv=t.createDiv({attr:{id:"filter"}})}render(){if(this.isOpen)return;if(this.filterDiv.empty(),!this.plugin.scene)return;const e=Array.from(this.selectedTags);this.selectedLinks.forEach((t=>e.push("link::"+t)));const t=[],i=new Set(this.selectedLinks.keys());this.plugin.scene.links.links.forEach((e=>{var t;null===(t=e.hierarchyDefinition)||void 0===t||t.split(",").map((e=>e.trim())).forEach((e=>i.add(e))),e.hierarchyDefinition||(e.isInferred?i.add("inferred-link"):i.add("normal-link"))})),i.forEach((e=>t.push({label:e,value:"link::"+e})));const s=new Set(this.selectedTags.keys());this.plugin.scene.nodesMap.forEach((e=>{e.page.primaryStyleTag&&s.add(e.page.primaryStyleTag)})),s.forEach((e=>t.push({label:e,value:e})));const n=new Ze.exports.Multiselect({id:"filter",placeholder:"filter links and tags",options:t.sort(((e,t)=>e.label>t.label?1:-1)),selected:e,onDropdownOpen:()=>{this.isOpen=!0,this.selectedItems=n.selected},onSelectionChange:e=>{var t;this.selectedLinks.clear(),this.selectedTags.clear(),e.forEach((e=>{e.startsWith("link::")?this.selectedLinks.add(e.substring(6)):this.selectedTags.add(e)})),null===(t=this.plugin.scene)||void 0===t||t.reRender(!1)},onDropdownClose:e=>{var t;this.isOpen=!1,e!==this.selectedItems&&(null===(t=this.plugin.scene)||void 0===t||t.reRender(!1))}})}}class et{constructor(e,t){this.contentEl=e,this.plugin=t,this.buttons=[],e.addClass("excalibrain-contentEl"),this.wrapperDiv=this.contentEl.createDiv({cls:"excalibrain-toolspanel-wrapper"});const i=this.wrapperDiv.createDiv({cls:"excalibrain-dropdown-wrapper"}),s=i.createEl("input",{type:"text",cls:"excalibrain-searchinput"});s.ariaLabel=N("SEARCH_IN_VAULT"),s.oninput=()=>{var e;const t=this.plugin.pages.get(s.value);t&&(null===(e=this.plugin.scene)||void 0===e||e.renderGraphForPath(t.path))},s.onblur=()=>{s.value=""},new Je(this.plugin.app,s,this.plugin,e),this.searchElement=s,this.linkTagFilter=new Qe(t,i),this.linkTagFilter.render();const n=this.wrapperDiv.createDiv({cls:"excalibrain-buttons"}),a=n.createEl("button",{cls:"excalibrain-button",text:"✏"});a.ariaLabel=N("OPEN_DRAWING"),a.onclick=()=>{const e=this.plugin.EA.getExcalidrawAPI().getSceneElements(),t=this.plugin.EA.getExcalidrawAPI().getAppState(),i=this.plugin.EA;i.reset(),i.canvas.viewBackgroundColor=t.viewBackgroundColor,i.canvas.theme="light",e.forEach((e=>i.elementsDict[e.id]=e)),i.create({filename:`ExcaliBrain Snapshot - ${c(this.plugin.scene.centralPagePath).basename}`,onNewPane:!0})},this.buttons.push(new B(this.plugin,(()=>this.plugin.settings.showAttachments),(e=>this.plugin.settings.showAttachments=e),n,{display:"📎",tooltip:N("SHOW_HIDE_ATTACHMENTS")})),this.buttons.push(new B(this.plugin,(()=>this.plugin.settings.showVirtualNodes),(e=>this.plugin.settings.showVirtualNodes=e),n,{display:"∅",tooltip:N("SHOW_HIDE_VIRTUAL")},!1)),this.buttons.push(new B(this.plugin,(()=>this.plugin.settings.showInferredNodes),(e=>this.plugin.settings.showInferredNodes=e),n,{display:"🤔",tooltip:N("SHOW_HIDE_INFERRED")})),this.buttons.push(new B(this.plugin,(()=>this.plugin.settings.showPageNodes),(e=>this.plugin.settings.showPageNodes=e),n,{display:"📄",tooltip:N("SHOW_HIDE_PAGES")})),this.buttons.push(new B(this.plugin,(()=>this.plugin.settings.showFolderNodes),(e=>this.plugin.settings.showFolderNodes=e),n,{display:"📂",tooltip:N("SHOW_HIDE_FOLDER")},!0)),this.buttons.push(new B(this.plugin,(()=>this.plugin.settings.showTagNodes),(e=>this.plugin.settings.showTagNodes=e),n,{display:"#",tooltip:N("SHOW_HIDE_TAG")},!1)),this.buttons.push(new B(this.plugin,(()=>this.plugin.settings.renderAlias),(e=>this.plugin.settings.renderAlias=e),n,{display:"🧥",tooltip:N("SHOW_HIDE_ALIAS")},!1)),this.buttons.push(new B(this.plugin,(()=>this.plugin.scene.pinLeaf),(e=>this.plugin.scene.pinLeaf=e),n,{display:"📌",tooltip:N("PIN_LEAF")},!1)),this.buttons.push(new B(this.plugin,(()=>this.plugin.settings.renderSiblings),(e=>this.plugin.settings.renderSiblings=e),n,{display:"👨‍👩‍👧‍👦",tooltip:N("SHOW_HIDE_SIBLINGS")},!1)),this.contentEl.appendChild(this.wrapperDiv)}rerender(){this.buttons.forEach((e=>e.setColor())),this.linkTagFilter.render()}terminate(){var e;if(this.contentEl&&this.contentEl.removeClass("excalibrain-contentEl"),this.wrapperDiv){try{null===(e=this.contentEl)||void 0===e||e.removeChild(this.wrapperDiv)}catch(e){}this.wrapperDiv=null}}}class tt{constructor(e,t){this.contentEl=e,this.plugin=t,this.wrapperDiv=this.contentEl.createDiv({cls:"excalibrain-history-wrapper"}),this.rerender(),this.contentEl.appendChild(this.wrapperDiv)}rerender(){this.wrapperDiv.empty();const e=this.wrapperDiv.createDiv({cls:"excalibrain-history-container"}),t=this.plugin.settings.navigationHistory;for(let i=t.length-1;i>=0;i--){i!==t.length-1&&e.createDiv({text:"•",cls:"excalibrain-history-divider"});let s="",n="";const a=this.plugin.pages.get(t[i]);if(!a)return;const r=a.path.startsWith("folder:")?this.plugin.settings.folderNodeStyle:a.path.startsWith("tag:")?this.plugin.settings.tagNodeStyle:Object.assign(Object.assign({},this.plugin.settings.baseNodeStyle),l(o(a.dvPage,this.plugin.settings),this.plugin.settings));a.file?(s=r.prefix+a.getTitle(),n=a.path):(s=r.prefix+a.name,n=a.path),e.createDiv({text:s,cls:"excalibrain-history-item"},(e=>{e.onclick=()=>{var e;return null===(e=this.plugin.scene)||void 0===e?void 0:e.renderGraphForPath(n)}}))}}terminate(){var e;if(this.wrapperDiv){try{null===(e=this.contentEl)||void 0===e||e.removeChild(this.wrapperDiv)}catch(e){}this.wrapperDiv=null}}}class it{constructor(e,t,i){this.disregardLeafChange=!1,this.nodesMap=new Map,this.layouts=[],this.blockUpdateTimer=!1,this.vaultFileChanged=!1,this.pinLeaf=!1,this.focusSearchAfterInitiation=!0,this.ea=e.EA,this.plugin=e,this.app=e.app,this.leaf=null!=i?i:app.workspace.getLeaf(t),this.terminated=!1,this.links=new Y(e)}async initialize(e){this.focusSearchAfterInitiation=e,await this.plugin.loadSettings(),this.toolsPanel=new et(this.leaf.view.contentEl,this.plugin),await this.initializeScene(),this.historyPanel=new tt(this.leaf.view.contentEl,this.plugin)}isActive(){var e;return!this.terminated&&app.workspace.getLeafById(null===(e=this.leaf)||void 0===e?void 0:e.id)}async reRender(e=!0){this.isActive()&&this.centralLeaf&&this.centralPagePath&&(e&&await this.plugin.createIndex(),await this.render(),this.toolsPanel.rerender())}async renderGraphForPath(e){var t;if(!this.isActive())return;this.blockUpdateTimer=!0;const i=this.plugin.pages.get(e);if(!i)return void(this.blockUpdateTimer=!1);const s=!(i.isFolder||i.isTag||i.isVirtual);if(s&&!i.file)return void(this.blockUpdateTimer=!1);if(!(null===(t=this.ea.targetView)||void 0===t?void 0:t.file)||this.ea.targetView.file.path!==this.plugin.settings.excalibrainFilepath)return void this.unloadScene();if(s&&i.file.path===this.ea.targetView.file.path)return void(this.blockUpdateTimer=!1);const n=this.plugin.pages.get(this.centralPagePath);n&&n.path===e&&s&&i.file.stat.mtime===n.mtime?this.blockUpdateTimer=!1:(s?(this.centralLeaf&&app.workspace.getLeafById(this.centralLeaf.id)?this.centralLeaf.openFile(i.file):this.centralLeaf=this.ea.openFileInNewOrAdjacentLeaf(i.file),this.addToHistory(i.file.path)):this.addToHistory(i.path),i.isFolder&&!this.plugin.settings.showFolderNodes&&(this.plugin.settings.showFolderNodes=!0,this.toolsPanel.rerender()),i.isTag&&!this.plugin.settings.showTagNodes&&(this.plugin.settings.showTagNodes=!0,this.toolsPanel.rerender()),this.centralPagePath=e,await this.render())}async addToHistory(e){const t=this.plugin.settings.navigationHistory;if(t.last()===e)return;const i=t.indexOf(e);i>-1&&t.splice(i,1),t.length>50&&t.shift(),t.push(e)}static async openExcalidrawLeaf(e,t,i){let n=0,a=app.vault.getAbstractFileByPath(t.excalibrainFilepath);if(!a||a instanceof s.TFile){if(!a)for(a=await app.vault.create(t.excalibrainFilepath,G);a instanceof s.TFile&&!e.isExcalidrawFile(a)&&n++<10;)await sleep(50);n=0,a&&a instanceof s.TFile&&!e.isExcalidrawFile(a)?new O(app,"⚠ File Exists",`${a.path} already exists in your Vault. Is it ok to overwrite this file? If not, change ExcaliBrain file path in plugin settings.`).show((async r=>{if(r){for(await app.vault.modify(a,G);a instanceof s.TFile&&!e.isExcalidrawFile(a)&&n++<10;)await sleep(50);it.openExcalidrawLeaf(e,t,i)}else new s.Notice("Could not start ExcaliBrain. Please change the ExcaliBrain file path in plugin settings.")})):await(null!=i?i:app.workspace.getLeaf(!0)).openFile(a)}else new s.Notice(`Please check settings. ExcaliBrain path (${t.excalibrainFilepath}) points to a folder, not a file`)}async initializeScene(){this.disregardLeafChange=!1;const e=this.ea,t=this.plugin.settings.baseNodeStyle;let i=0;for(e.clear(),e.setView(this.leaf.view),i=0;!e.targetView.excalidrawAPI&&i++<10;)await sleep(50);e.targetView.excalidrawAPI?(this.ea.registerThisAsViewEA(),this.ea.targetView.semaphores.saving=!0,this.ea.targetView.excalidrawAPI.setMobileModeAllowed(!1),e.style.fontFamily=t.fontFamily,e.style.fontSize=t.fontSize,this.textSize=e.measureText("m".repeat(t.maxLabelLength+3)),this.nodeWidth=this.textSize.width+3*t.padding,this.nodeHeight=2*(this.textSize.height+2*t.padding),e.getExcalidrawAPI().updateScene({appState:{viewModeEnabled:!0,activeTool:{lastActiveToolBeforeEraser:null,locked:!1,type:"selection"},theme:"light",viewBackgroundColor:this.plugin.settings.backgroundColor},elements:[]}),e.style.strokeColor=t.textColor,e.addText(0,0,"🚀 To get started\nselect a document using the search in the top left or\nopen a document in another pane.\n\n✨ For the best experience enable 'Open in adjacent pane'\nin Excalidraw settings under 'Links and Transclusion'.\n\n⚠ ExcaliBrain may need to wait for DataView to initialize its index.\nThis can take up to a few minutes after starting Obsidian.",{textAlign:"center"}),await e.addElementsToView(),e.getExcalidrawAPI().zoomToFit(null,5,.15),e.targetView.linksAlwaysOpenInANewPane=!0,this.addEventHandler(),new s.Notice("ExcaliBrain On")):new s.Notice("Error initializing Excalidraw view")}addNodes(t){t.neighbours.forEach((i=>{if(i.page.path===this.ea.targetView.file.path)return;const s=new C({page:i.page,isInferred:i.relationType===e.INFERRED,isCentral:t.isCentral,isSibling:t.isSibling,friendGateOnLeft:t.friendGateOnLeft});this.nodesMap.set(i.page.path,s),t.layout.nodes.push(s)}))}async render(){var e,i;this.historyPanel&&this.historyPanel.rerender();const s=this.plugin.pages.get(this.centralPagePath);this.ea.clear(),this.ea.getExcalidrawAPI().updateScene({elements:[]}),this.ea.style.verticalAlign="middle";const n=s.getParents().filter((e=>!(e.page.path===s.path||this.plugin.settings.excludeFilepaths.some((t=>e.page.path.startsWith(t)))||e.page.primaryStyleTag&&this.toolsPanel.linkTagFilter.selectedTags.has(e.page.primaryStyleTag)))).slice(0,this.plugin.settings.maxItemCount),a=n.map((e=>e.page.path)),r=s.getChildren().filter((e=>!(e.page.path===s.path||this.plugin.settings.excludeFilepaths.some((t=>e.page.path.startsWith(t)))||e.page.primaryStyleTag&&this.toolsPanel.linkTagFilter.selectedTags.has(e.page.primaryStyleTag)))).slice(0,this.plugin.settings.maxItemCount),o=s.getFriends().filter((e=>!(e.page.path===s.path||this.plugin.settings.excludeFilepaths.some((t=>e.page.path.startsWith(t)))||e.page.primaryStyleTag&&this.toolsPanel.linkTagFilter.selectedTags.has(e.page.primaryStyleTag)))).slice(0,this.plugin.settings.maxItemCount),l=s.getSiblings().filter((e=>!(n.some((t=>t.page.path===e.page.path))||r.some((t=>t.page.path===e.page.path))||o.some((t=>t.page.path===e.page.path))||this.plugin.settings.excludeFilepaths.some((t=>e.page.path.startsWith(t))))&&e.page.path!==s.path)).filter((e=>e.page.getParents().map((e=>e.page.path)).some((e=>a.includes(e)))&&(!e.page.primaryStyleTag||!this.toolsPanel.linkTagFilter.selectedTags.has(e.page.primaryStyleTag)))).slice(0,this.plugin.settings.maxItemCount);this.nodesMap=new Map,this.links=new Y(this.plugin),this.layouts=[];const h=r.length>10,d=l.length>10,c=n.length<=1,g=this.plugin.settings.baseNodeStyle,p=new W({origoX:0,origoY:0,top:null,bottom:null,columns:1,columnWidth:this.nodeWidth,rowHeight:this.nodeHeight});this.layouts.push(p);const u=new W({origoX:0,origoY:2.5*this.nodeHeight,top:2*this.nodeHeight,bottom:null,columns:h?5:3,columnWidth:this.nodeWidth,rowHeight:this.nodeHeight});this.layouts.push(u);const f=new W({origoX:(h?-3:-2)*this.nodeWidth,origoY:0,top:null,bottom:null,columns:1,columnWidth:this.nodeWidth,rowHeight:this.nodeHeight});this.layouts.push(f);const y=new W({origoX:0,origoY:-2.5*this.nodeHeight,top:null,bottom:-2*this.nodeHeight,columns:3,columnWidth:this.nodeWidth,rowHeight:this.nodeHeight});this.layouts.push(y);const m=this.plugin.settings.siblingNodeStyle,E=null!==(e=m.padding)&&void 0!==e?e:g.padding,S=null!==(i=m.maxLabelLength)&&void 0!==i?i:g.maxLabelLength;this.ea.style.fontFamily=m.fontFamily,this.ea.style.fontSize=m.fontSize;const v=this.ea.measureText("m".repeat(S+3)),w=v.width+3*E,b=2*(v.height+2*E),L=new W({origoX:1.3*this.nodeWidth*((c?0:1)+(d?2:1)),origoY:-2.5*this.nodeHeight,top:null,bottom:0,columns:d?3:1,columnWidth:w,rowHeight:b});this.layouts.push(L);const D=new C({page:s,isInferred:!1,isCentral:!0,isSibling:!1,friendGateOnLeft:!0});this.nodesMap.set(s.path,D),p.nodes.push(D),this.addNodes({neighbours:n,layout:y,isCentral:!1,isSibling:!1,friendGateOnLeft:!0}),this.addNodes({neighbours:r,layout:u,isCentral:!1,isSibling:!1,friendGateOnLeft:!0}),this.addNodes({neighbours:o,layout:f,isCentral:!1,isSibling:!1,friendGateOnLeft:!1}),this.plugin.settings.renderSiblings&&this.addNodes({neighbours:l,layout:L,isCentral:!1,isSibling:!0,friendGateOnLeft:!0});const T=(e,t,i)=>{t.forEach((t=>{const s=this.nodesMap.get(t.page.path);s&&this.links.addLink(e,s,i,t.relationType,t.typeDefinition,t.linkDirection,this.ea,this.plugin.settings)}))};Array.from(this.nodesMap.values()).forEach((e=>{T(e,e.page.getChildren(),t.CHILD),T(e,e.page.getParents(),t.PARENT),T(e,e.page.getFriends(),t.FRIEND)})),this.ea.style.opacity=100,this.layouts.forEach((e=>e.render()));const N=this.ea.getElements();this.links.render(Array.from(this.toolsPanel.linkTagFilter.selectedLinks));const O=this.ea.getElements().filter((e=>!N.includes(e)));this.ea.getExcalidrawAPI().updateScene({elements:O.concat(N)}),this.ea.getExcalidrawAPI().zoomToFit(null,5,.15),this.toolsPanel.rerender(),this.focusSearchAfterInitiation&&(this.toolsPanel.searchElement.focus(),this.focusSearchAfterInitiation=!1),this.blockUpdateTimer=!1}isCentralLeafStillThere(){return null!==app.workspace.getLeafById(this.centralLeaf.id)}async addEventHandler(){const e=this,t=async t=>{var i;if(this.disregardLeafChange)return;if(e.blockUpdateTimer=!0,await new Promise((e=>setTimeout(e,100))),this.pinLeaf&&!this.isCentralLeafStillThere()&&(this.pinLeaf=!1,this.toolsPanel.rerender()),this.pinLeaf&&t!==this.centralLeaf)return;if(!(null===(i=e.ea.targetView)||void 0===i?void 0:i.file)||e.ea.targetView.file.path!==e.plugin.settings.excalibrainFilepath)return void e.unloadScene();if(!((null==t?void 0:t.view)&&t.view instanceof s.FileView&&t.view.file))return void(e.blockUpdateTimer=!1);const n=t.view.file;if(n.path===e.ea.targetView.file.path)return void(e.blockUpdateTimer=!1);const a=e.plugin.pages.get(e.centralPagePath);a&&a.path===n.path&&n.stat.mtime===a.mtime?e.blockUpdateTimer=!1:(e.plugin.pages.get(n.path)||await e.plugin.createIndex(),this.addToHistory(n.path),e.centralPagePath=n.path,e.centralLeaf=t,e.render())},i=()=>{this.vaultFileChanged=!0};app.workspace.on("active-leaf-change",t),this.removeEH=()=>app.workspace.off("active-leaf-change",t);const n=setInterval((async()=>{this.blockUpdateTimer||this.vaultFileChanged&&(this.vaultFileChanged=!1,await this.plugin.createIndex(),this.centralPagePath&&(this.plugin.pages.get(this.centralPagePath)||this.centralLeaf&&this.centralLeaf.view&&this.centralLeaf.view.file&&(this.centralPagePath=this.centralLeaf.view.file.path)),this.render())}),5e3);this.removeTimer=()=>clearInterval(n),app.vault.on("rename",i),this.removeOnRename=()=>app.vault.off("rename",i),app.vault.on("modify",i),this.removeOnModify=()=>app.vault.off("modify",i),app.vault.on("create",i),this.removeOnCreate=()=>app.vault.off("create",i),app.vault.on("delete",i),this.removeOnDelete=()=>app.vault.off("delete",i);const a=[];app.workspace.iterateAllLeaves((e=>{e.view instanceof s.FileView&&e.view.file&&e.view.file.path!==this.ea.targetView.file.path&&a.push(e)})),await this.plugin.createIndex(),a.length>0&&t(a[0])}unloadScene(){var e,t;if(this.removeEH&&(this.removeEH(),this.removeEH=void 0),this.removeTimer&&(this.removeTimer(),this.removeTimer=void 0),this.removeOnRename&&(this.removeOnRename(),this.removeOnRename=void 0),this.removeOnModify&&(this.removeOnModify(),this.removeOnModify=void 0),this.removeOnCreate&&(this.removeOnCreate(),this.removeOnCreate=void 0),this.removeOnDelete&&(this.removeOnDelete(),this.removeOnDelete=void 0),this.ea.targetView&&isBoolean(this.ea.targetView.linksAlwaysOpenInANewPane)&&(this.ea.targetView.linksAlwaysOpenInANewPane=!1),this.ea.targetView&&this.ea.targetView.excalidrawAPI)try{this.ea.targetView.semaphores.saving=!1,this.ea.targetView.excalidrawAPI.setMobileModeAllowed(!0),this.ea.targetView.excalidrawAPI.updateScene({appState:{viewModeEnabled:!1}})}catch(e){}if(this.ea.targetView&&this.ea.targetView._loaded)try{this.ea.deregisterThisAsViewEA()}catch(e){}(async()=>{const e=this.plugin.settings.navigationHistory.slice();await this.plugin.loadSettings(),this.plugin.settings.navigationHistory=e,await this.plugin.saveSettings()})(),null===(e=this.toolsPanel)||void 0===e||e.terminate(),this.toolsPanel=void 0,null===(t=this.historyPanel)||void 0===t||t.terminate(),this.historyPanel=void 0,this.ea.targetView=void 0,this.leaf=void 0,this.centralLeaf=void 0,this.centralPagePath=void 0,this.terminated=!0,app.plugins.plugins["obsidian-excalidraw-plugin"]||(this.plugin.EA=null),new s.Notice("Brain Graph Off")}}class st extends s.EditorSuggest{constructor(e){super(e.app),this.getKeys=()=>"parent"===this.suggestType?this.plugin.settings.hierarchy.parents:"child"===this.suggestType?this.plugin.settings.hierarchy.children:this.plugin.settings.hierarchy.friends,this.getTrigger=()=>"parent"===this.suggestType?this.plugin.settings.ontologySuggesterParentTrigger:"child"===this.suggestType?this.plugin.settings.ontologySuggesterChildTrigger:this.plugin.settings.ontologySuggesterFriendTrigger,this.getSuggestions=e=>{const t=e.query.toLowerCase();return this.getKeys().filter((e=>e.toLowerCase().includes(t)))},this.plugin=e}onTrigger(e,t,i){var s,n,a,r,o;const l=this.plugin.settings;if(l.allowOntologySuggester){const i=t.getLine(e.line).substring(0,e.ch),h=new RegExp(`^${l.ontologySuggesterParentTrigger}(.*)$`),d=new RegExp(`^${l.ontologySuggesterChildTrigger}(.*)$`),c=new RegExp(`^${l.ontologySuggesterFriendTrigger}(.*)$`),g=null!==(r=null!==(n=null===(s=i.match(h))||void 0===s?void 0:s[1])&&void 0!==n?n:null===(a=i.match(d))||void 0===a?void 0:a[1])&&void 0!==r?r:null===(o=i.match(c))||void 0===o?void 0:o[1];if(void 0!==g)return this.suggestType=i.match(h)?"parent":i.match(d)?"child":"friend",this.latestTriggerInfo={end:e,start:{ch:e.ch-g.length-this.getTrigger().length,line:e.line},query:g},this.latestTriggerInfo}return null}renderSuggestion(e,t){t.createEl("b",{text:e})}selectSuggestion(e){const{context:t}=this;if(t){const i=`${e}:: `;if(t.editor.replaceRange(i,this.latestTriggerInfo.start,this.latestTriggerInfo.end),this.latestTriggerInfo.start.ch===this.latestTriggerInfo.end.ch){const e=this.latestTriggerInfo.end;e.ch+=i.length,t.editor.setCursor(e)}}}}class nt extends s.Plugin{constructor(e,t){super(e,t),this.hierarchyLowerCase={parents:[],children:[],friends:[]},this.scene=null,this.pluginLoaded=!1,this.starred=[],this.focusSearchAfterInitiation=!1,this.starred=[new y(null,"Initializing index, please wait",null,this,!1,!1,"Initializing index, please wait")]}async onload(){await this.loadSettings(),this.addSettingTab(new P(this.app,this)),this.registerEditorSuggest(new st(this)),this.app.workspace.onLayoutReady((()=>{this.DVAPI=M(),this.DVAPI?this.DVAPI.version.compare(">=","0.5.31")?(this.EA=S(),this.EA?this.EA.verifyMinimumPluginVersion("1.6.33")?(this.registerCommands(),this.registerExcalidrawAutomateHooks(),this.pluginLoaded=!0):new O(app,"⚠ ExcaliBrain Disabled: Please upgrade Excalidraw and try again",N("EXCALIDRAW_MINAPP_VERSION")).show((async e=>{new s.Notice("Disabling ExcaliBrain Plugin",8e3),h({fn:this.onload,where:"main.ts/onload()",message:"ExcaliBrain requires a new version of Excalidraw"}),this.app.plugins.disablePlugin("excalibrain")})):new O(app,"⚠ ExcaliBrain Disabled: Excalidraw Plugin not found",N("EXCALIDRAW_NOT_FOUND")).show((async e=>{new s.Notice("Disabling ExcaliBrain Plugin",8e3),h({fn:this.onload,where:"main.ts/onload()",message:"Excalidraw not found"}),this.app.plugins.disablePlugin("excalibrain")}))):new O(app,"⚠ ExcaliBrain Disabled: Dataview upgrade requried",N("DATAVIEW_UPGRADE")).show((async e=>{new s.Notice("Disabling ExcaliBrain Plugin",8e3),h({fn:this.onload,where:"main.ts/onload()",message:"Dataview version error"}),this.app.plugins.disablePlugin("excalibrain")})):new O(app,"⚠ ExcaliBrain Disabled: DataView Plugin not found",N("DATAVIEW_NOT_FOUND")).show((async e=>{new s.Notice("Disabling ExcaliBrain Plugin",8e3),h({fn:this.onload,where:"main.ts/onload()",message:"Dataview not found"}),this.app.plugins.disablePlugin("excalibrain")}))}))}async createIndex(){this.pages=new V(this);let t=0;for(;this.app.metadataCache.inProgressTaskCount>0||this.DVAPI.index.importer.reloadQueue.length>0;)t++%100==10&&new s.Notice("ExcaliBrain is waiting for Dataview to update its index",1e3),await sleep(100);const n=(t,a)=>{t.children.forEach((t=>{if(t instanceof s.TFolder){const s=new y(this.pages,"folder:"+t.path,null,this,!0,!1,t.name);return this.pages.add("folder:"+t.path,s),s.addParent(a,e.DEFINED,i.FROM,"file-tree"),a.addChild(s,e.DEFINED,i.TO,"file-tree"),void n(t,s)}{const s=new y(this.pages,t.path,t,this);this.pages.add(t.path,s),s.addParent(a,e.DEFINED,i.FROM,"file-tree"),a.addChild(s,e.DEFINED,i.TO,"file-tree")}}))},a=app.vault.getRoot(),r=new y(this.pages,"folder:/",null,this,!0,!1,"/");this.pages.add("folder:/",r),n(a,r);const o=Object.keys(app.metadataCache.getTags()).map((e=>e.substring(1).split("/")));o.forEach((t=>{const s=[];t.forEach(((t,n,a)=>{const r="tag:"+a.slice(0,n+1).join("/");let o=this.pages.get(r);if(o)s.push(o);else if(o=new y(this.pages,r,null,this,!1,!0,t),this.pages.add(r,o),s.push(o),n>0){const t=s[n-1];o.addParent(t,e.DEFINED,i.FROM,"tag-tree"),t.addChild(o,e.DEFINED,i.TO,"tag-tree")}}))})),this.pages.addUnresolvedLinks(),this.pages.addResolvedLinks();const l=this;setTimeout((async()=>{const e=app.internalPlugins.getPluginById("starred");e&&(l.starred=(await e.loadData()).items.filter((e=>"file"===e.type)).map((e=>e.path)).filter((e=>e!==l.settings.excalibrainFilepath&&l.pages.has(e))).map((e=>l.pages.get(e))))}))}excalidrawAvailable(){const e=S();return e?(this.EA||(this.EA=e,this.registerExcalidrawAutomateHooks()),!0):(this.EA=null,this.scene&&this.scene.unloadScene(),new s.Notice("ExcaliBrain: Please start Excalidraw and try again.",4e3),!1)}revealBrainLeaf(){var e;if(!this.scene||this.scene.terminated)return;app.workspace.revealLeaf(this.scene.leaf);const t=app.plugins.getPlugin("obsidian-hover-editor");if(t){const e=t.activePopovers.filter((e=>e.leaves()[0]===this.scene.leaf))[0];e&&0===this.scene.leaf.view.containerEl.offsetHeight&&e.titleEl.querySelector("a.popover-action.mod-minimize").click()}const i=null===(e=this.scene.toolsPanel)||void 0===e?void 0:e.searchElement;null==i||i.focus()}registerCommands(){const e=(e,t)=>{var i;const n=null===(i=app.workspace.activeLeaf)||void 0===i?void 0:i.view;if(e)return n instanceof s.MarkdownView&&"source"===n.getMode();if(!(n instanceof s.MarkdownView)||"source"!==n.getMode())return!1;const a=n.editor.getCursor(),r=n.editor.getLine(a.line).match(/^([^\:]*)::/);return!!r&&((async()=>{const e=this.settings.navigationHistory;if(await this.loadSettings(),this.settings.navigationHistory=e,this.settings.hierarchy.parents.includes(r[1]))new s.Notice(`${r[1]} is already registered as a PARENT`);else if(this.settings.hierarchy.children.includes(r[1]))new s.Notice(`${r[1]} is already registered as a CHILD`);else if(this.settings.hierarchy.friends.includes(r[1]))new s.Notice(`${r[1]} is already registered as a FRIEND`);else{switch(t){case"parent":this.settings.hierarchy.parents.push(r[1]),this.settings.hierarchy.parents=this.settings.hierarchy.parents.sort(((e,t)=>e.toLowerCase()<t.toLowerCase()?-1:1)),this.hierarchyLowerCase.parents=[],this.settings.hierarchy.parents.forEach((e=>this.hierarchyLowerCase.parents.push(e.toLowerCase().replaceAll(" ","-"))));break;case"child":this.settings.hierarchy.children.push(r[1]),this.settings.hierarchy.children=this.settings.hierarchy.children.sort(((e,t)=>e.toLowerCase()<t.toLowerCase()?-1:1)),this.hierarchyLowerCase.children=[],this.settings.hierarchy.children.forEach((e=>this.hierarchyLowerCase.children.push(e.toLowerCase().replaceAll(" ","-"))));break;default:this.settings.hierarchy.friends.push(r[1]),this.settings.hierarchy.friends=this.settings.hierarchy.friends.sort(((e,t)=>e.toLowerCase()<t.toLowerCase()?-1:1)),this.hierarchyLowerCase.friends=[],this.settings.hierarchy.friends.forEach((e=>this.hierarchyLowerCase.friends.push(e.toLowerCase().replaceAll(" ","-"))))}await this.saveSettings(),this.scene&&!this.scene.terminated&&(this.scene.vaultFileChanged=!0),new s.Notice(`Added ${r[1]} as ${t}`)}})(),!0)};this.addCommand({id:"excalibrain-addParentField",name:N("COMMAND_ADD_PARENT_FIELD"),checkCallback:t=>e(t,"parent")}),this.addCommand({id:"excalibrain-addChildField",name:N("COMMAND_ADD_CHILD_FIELD"),checkCallback:t=>e(t,"child")}),this.addCommand({id:"excalibrain-addFriendField",name:N("COMMAND_ADD_FRIEND_FIELD"),checkCallback:t=>e(t,"friend")}),this.addCommand({id:"excalibrain-start",name:N("COMMAND_START"),checkCallback:e=>{if(e)return this.excalidrawAvailable();if(!this.excalidrawAvailable())return;if(this.scene&&!this.scene.terminated)return void this.revealBrainLeaf();const t=this.getBrainLeaf();if(t)return this.scene=new it(this,!0,t),this.scene.initialize(!0),void this.revealBrainLeaf();this.focusSearchAfterInitiation=!0,it.openExcalidrawLeaf(window.ExcalidrawAutomate,this.settings,t)}}),this.addCommand({id:"excalibrain-open-hover",name:N("COMMAND_START_HOVER"),checkCallback:e=>{const t=app.plugins.getPlugin("obsidian-hover-editor");if(e)return t&&this.excalidrawAvailable();if(this.excalidrawAvailable()&&t)if(!this.scene||this.scene.terminated)try{const e=this.getBrainLeaf();if(e){const i=t.activePopovers.filter((t=>t.leaves()[0]===e))[0];if(i)return app.workspace.revealLeaf(e),0===e.view.containerEl.offsetHeight&&i.titleEl.querySelector("a.popover-action.mod-maximize").click(),this.scene=new it(this,!0,e),void this.scene.initialize(!0)}const i=t.spawnPopover(void 0,(()=>{if(this.app.workspace.setActiveLeaf(i,!1,!0),!t.activePopovers.filter((e=>e.leaves()[0]===i))[0])return new s.Notice(N("HOVER_EDITOR_ERROR"),6e3),!1;setTimeout((()=>app.commands.executeCommandById("obsidian-hover-editor:snap-active-popover-to-viewport"))),this.focusSearchAfterInitiation=!0,it.openExcalidrawLeaf(window.ExcalidrawAutomate,this.settings,i)}))}catch(e){new s.Notice(N("HOVER_EDITOR_ERROR"),6e3)}else this.revealBrainLeaf()}})}getBrainLeaf(){let e;return app.workspace.iterateAllLeaves((t=>{t.view&&this.EA.isExcalidrawView(t.view)&&t.view instanceof s.TextFileView&&t.view.file.path===this.settings.excalibrainFilepath&&(e=t)})),e}registerExcalidrawAutomateHooks(){this.EA.onViewModeChangeHook=e=>{var t;this.EA.targetView&&(null===(t=this.EA.targetView.file)||void 0===t?void 0:t.path)===this.settings.excalibrainFilepath&&(e||this.stop())},this.EA.onLinkHoverHook=(e,t)=>{var i;return!(this.scene&&this.EA.targetView&&(null===(i=this.EA.targetView.file)||void 0===i?void 0:i.path)===this.settings.excalibrainFilepath&&this.EA.targetView.excalidrawAPI&&this.EA.targetView.excalidrawAPI.getAppState().viewModeEnabled&&(this.scene.disregardLeafChange=!0,this.disregardLeafChangeTimer&&clearTimeout(this.disregardLeafChangeTimer),this.disregardLeafChangeTimer=setTimeout((()=>{this.disregardLeafChangeTimer=null,this.scene&&(this.scene.disregardLeafChange=!1)}),1e3),0))},this.EA.onLinkClickHook=(e,t,i)=>{var n,a,r,o,l,h,d,c,g;const p=t.match(/\[\[([^\]]*)/)[1],u=this.pages.get(p);if(!i.shiftKey&&u&&u.isVirtual)return null===(n=this.scene)||void 0===n||n.renderGraphForPath(p),!1;if(!t.startsWith("[[folder:")&&!t.startsWith("[[tag:")){if((null===(l=null===(o=null===(r=null===(a=this.scene)||void 0===a?void 0:a.centralLeaf)||void 0===r?void 0:r.view)||void 0===o?void 0:o.file)||void 0===l?void 0:l.path)===p)return null===(h=this.scene)||void 0===h||h.renderGraphForPath(p),!1;if((null===(d=this.scene)||void 0===d?void 0:d.pinLeaf)&&(null===(c=this.scene)||void 0===c?void 0:c.isCentralLeafStillThere())){const e=app.vault.getAbstractFileByPath(p.split("#")[0]);if(e&&e instanceof s.TFile)return this.scene.centralLeaf.openFile(e),this.scene.renderGraphForPath(p),!1}return!0}return null===(g=this.scene)||void 0===g||g.renderGraphForPath(p),!1},this.EA.onViewUnloadHook=e=>{this.scene&&this.scene.leaf===e.leaf&&this.stop()}}onunload(){this.scene&&(this.scene.unloadScene(),this.scene=null)}setHierarchyLinkStylesExtended(){this.hierarchyLinkStylesExtended={},Object.entries(this.settings.hierarchyLinkStyles).forEach((e=>{const t=e[0].toLowerCase().replaceAll(" ","-");this.hierarchyLinkStylesExtended[e[0]]=e[1],e[0]!==t&&(this.hierarchyLinkStylesExtended[t]=e[1])}))}loadCustomNodeLabelFunction(){if(this.settings.nodeTitleScript)try{this.customNodeLabel=new Function("dvPage","defaultName","return "+this.settings.nodeTitleScript)}catch(e){h({fn:this.loadCustomNodeLabelFunction,message:"error processing custom node label script",where:"loadCustomNodeLabelFunction()",data:this.settings.nodeTitleScript,error:e}),new s.Notice("Could not load custom node label function. See Developer console for details"),this.customNodeLabel=null}else this.customNodeLabel=null}async loadSettings(){this.settings=Object.assign({},x,await this.loadData()),this.loadCustomNodeLabelFunction(),this.settings.baseLinkStyle=Object.assign(Object.assign({},b),this.settings.baseLinkStyle),this.settings.baseNodeStyle=Object.assign(Object.assign({},L),this.settings.baseNodeStyle),this.hierarchyLowerCase.parents=[],this.settings.hierarchy.parents=this.settings.hierarchy.parents.sort(((e,t)=>e.toLowerCase()<t.toLowerCase()?-1:1)),this.settings.hierarchy.parents.forEach((e=>this.hierarchyLowerCase.parents.push(e.toLowerCase().replaceAll(" ","-")))),this.hierarchyLowerCase.children=[],this.settings.hierarchy.children=this.settings.hierarchy.children.sort(((e,t)=>e.toLowerCase()<t.toLowerCase()?-1:1)),this.settings.hierarchy.children.forEach((e=>this.hierarchyLowerCase.children.push(e.toLowerCase().replaceAll(" ","-")))),this.hierarchyLowerCase.friends=[],this.settings.hierarchy.friends=this.settings.hierarchy.friends.sort(((e,t)=>e.toLowerCase()<t.toLowerCase()?-1:1)),this.settings.hierarchy.friends.forEach((e=>this.hierarchyLowerCase.friends.push(e.toLowerCase().replaceAll(" ","-")))),this.setHierarchyLinkStylesExtended(),this.linkStyles={},this.linkStyles.base={style:this.settings.baseLinkStyle,allowOverride:!1,userStyle:!1,display:N("LINKSTYLE_BASE"),getInheritedStyle:()=>this.settings.baseLinkStyle},this.linkStyles.inferred={style:this.settings.inferredLinkStyle,allowOverride:!0,userStyle:!1,display:N("LINKSTYLE_INFERRED"),getInheritedStyle:()=>this.settings.baseLinkStyle},this.linkStyles["file-tree"]={style:this.settings.folderLinkStyle,allowOverride:!0,userStyle:!1,display:N("LINKSTYLE_FOLDER"),getInheritedStyle:()=>this.settings.baseLinkStyle},this.linkStyles["tag-tree"]={style:this.settings.tagLinkStyle,allowOverride:!0,userStyle:!1,display:N("LINKSTYLE_TAG"),getInheritedStyle:()=>this.settings.baseLinkStyle},Object.entries(this.settings.hierarchyLinkStyles).forEach((e=>{w.contains(e[0])||(this.linkStyles[e[0]]={style:e[1],allowOverride:!0,userStyle:!0,display:e[0],getInheritedStyle:()=>this.settings.baseLinkStyle})})),this.nodeStyles={},this.nodeStyles.base={style:this.settings.baseNodeStyle,allowOverride:!1,userStyle:!1,display:N("NODESTYLE_BASE"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.inferred={style:this.settings.inferredNodeStyle,allowOverride:!0,userStyle:!1,display:N("NODESTYLE_INFERRED"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.virtual={style:this.settings.virtualNodeStyle,allowOverride:!0,userStyle:!1,display:N("NODESTYLE_VIRTUAL"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.central={style:this.settings.centralNodeStyle,allowOverride:!0,userStyle:!1,display:N("NODESTYLE_CENTRAL"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.sibling={style:this.settings.siblingNodeStyle,allowOverride:!0,userStyle:!1,display:N("NODESTYLE_SIBLING"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.attachment={style:this.settings.attachmentNodeStyle,allowOverride:!0,userStyle:!1,display:N("NODESTYLE_ATTACHMENT"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.folder={style:this.settings.folderNodeStyle,allowOverride:!0,userStyle:!1,display:N("NODESTYLE_FOLDER"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.tag={style:this.settings.tagNodeStyle,allowOverride:!0,userStyle:!1,display:N("NODESTYLE_TAG"),getInheritedStyle:()=>this.settings.baseNodeStyle},Object.entries(this.settings.tagNodeStyles).sort(((e,t)=>e[0].toLowerCase()<t[0].toLowerCase()?-1:1)).forEach((e=>{this.nodeStyles[e[0]]={style:e[1],allowOverride:!0,userStyle:!0,display:e[0],getInheritedStyle:()=>this.settings.baseNodeStyle}}))}async saveSettings(){await this.saveData(this.settings)}stop(){this.scene&&!this.scene.terminated&&(this.scene.unloadScene(),this.scene=null)}async start(e){if(!e.view)return;let t=0;for(;!this.pluginLoaded&&t++<100;)await sleep(50);if(!this.pluginLoaded)return new s.Notice("ExcaliBrain plugin did not load - aborting start()"),void h({where:"ExcaliBrain.start()",fn:this.start,message:"ExcaliBrain did not load. Aborting after 5000ms of trying"});this.excalidrawAvailable()&&(this.stop(),e?(this.scene=new it(this,!0,e),this.scene.initialize(this.focusSearchAfterInitiation),this.focusSearchAfterInitiation=!1):await it.openExcalidrawLeaf(window.ExcalidrawAutomate,this.settings,this.getBrainLeaf()))}}module.exports=nt;